<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•”ì‹œì¥ & ì»¤ìŠ¤í…€ ìƒµ</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        body {
            background-color: #111;
            color: #d0d0d0;
            font-family: 'Courier Prime', monospace;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 20px; min-height: 100vh;
            user-select: none;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ (ê³µí†µ) */
        .navbar { width: 100%; background: rgba(0,0,0,0.9); border-bottom: 1px solid #ab0000; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 50px; box-sizing: border-box; position: fixed; top: 0; z-index: 1000; }
        .logo { color: #ab0000; font-family: 'Black Ops One'; font-size: 24px; }
        .nav-links { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
        .nav-links li { display: inline-block; }
        .nav-links a { color: white; text-decoration: none; font-size: 14px; }
        .nav-links a:hover { color: #ab0000; }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .shop-wrapper {
            margin-top: 80px;
            width: 100%; max-width: 1000px;
            display: flex; flex-direction: column; gap: 40px;
            margin-bottom: 100px;
        }

        /* ìœ ì € ì •ë³´ íŒ¨ë„ */
        .user-hud {
            background: #1a1a1a;
            border: 2px solid #ab0000;
            border-radius: 5px;
            padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            font-family: 'Black Ops One'; font-size: 20px;
            box-shadow: 0 0 15px rgba(171, 0, 0, 0.2);
        }
        .money-text { color: #ffd700; text-shadow: 0 0 5px #ffd700; }

        /* ì„¹ì…˜ í—¤ë” */
        .section-header {
            color: #fff; font-family: 'Black Ops One'; font-size: 24px; margin-bottom: 15px;
            border-bottom: 2px solid #333; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-end;
        }
        .section-sub { font-size: 14px; color: #888; font-family: 'Courier Prime'; }

        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .shop-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        /* 1. ìŠ¤í‚¨ ì•„ì´í…œ ì¹´ë“œ */
        .skin-card {
            background: #000; border: 1px solid #444; border-radius: 5px; padding: 20px;
            text-align: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .skin-card:hover {
            border-color: #ab0000; background: #111; transform: translateY(-2px);
        }
        .skin-card.owned { border-color: #555; opacity: 1; }
        .skin-card.equipped { border-color: #0f0; background: #051a05; box-shadow: 0 0 10px #0f0; }

        .item-icon { font-size: 40px; margin-bottom: 10px; }
        .item-name { font-weight: bold; color: #fff; margin-bottom: 5px; font-size: 16px; }
        
        .status-badge {
            font-size: 12px; padding: 3px 8px; border-radius: 3px; margin-top: 10px; display: inline-block;
        }
        .badge-buy { background: #ab0000; color: white; }
        .badge-equip { background: #444; color: white; }
        .badge-active { background: #0f0; color: black; font-weight: bold; }

        /* 2. íŒë§¤(í™˜ì „) ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .sell-item {
            background: #222; border: 1px solid #444; border-radius: 5px; padding: 15px;
            text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .sell-item:hover { background: #333; border-color: #ffd700; transform: scale(1.05); }
        .sell-count { font-size: 12px; color: #aaa; margin-top: 5px; }
        .sell-price { color: #0f0; font-weight: bold; margin-top: 5px; font-size: 14px; }
        .sell-empty { grid-column: 1 / -1; text-align: center; color: #555; padding: 30px; border: 1px dashed #333; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">BLACK MARKET</div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="game.html">ë¦¬ë“¬ê²Œì„</a></li>
            <li><a href="shop.html" style="color:#ab0000;">ìƒì </a></li>
        </ul>
    </nav>

    <div class="shop-wrapper">
        <div class="user-hud">
            <div>USER: <span id="myNick" style="color:#fff;">LOADING...</span></div>
            <div>CREDIT: <span id="myMoney" class="money-text">0</span> G</div>
        </div>

        <div>
            <div class="section-header">
                CUSTOM SKINS
                <span class="section-sub">ë…¸íŠ¸ ëª¨ì–‘ì„ ë³€ê²½í•©ë‹ˆë‹¤</span>
            </div>
            <div class="shop-grid" id="skinGrid">
                </div>
        </div>

        <div>
            <div class="section-header">
                PAWN SHOP
                <span class="section-sub">ìíŒê¸°ì—ì„œ ì–»ì€ ë¬¼ê±´ íŒë§¤</span>
            </div>
            <div class="shop-grid" id="inventoryGrid">
                </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
            authDomain: "cheongjuca.firebaseapp.com",
            databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
            projectId: "cheongjuca",
            storageBucket: "cheongjuca.firebasestorage.app",
            messagingSenderId: "455437421321",
            appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const loginID = localStorage.getItem("loginID");
        if(!loginID) { alert("ë¡œê·¸ì¸ í•„ìš”"); location.href='index.html'; }

        // --- ìƒì  ì•„ì´í…œ ë°ì´í„° (ìŠ¤í‚¨ë§Œ ë‚¨ê¹€) ---
        const skinItems = [
            { id: 'skin_default', name: 'ê¸°ë³¸ ë…¸íŠ¸', icon: 'ğŸŸ¦', price: 0 },
            { id: 'skin_neon', name: 'ë„¤ì˜¨ ì„œí´', icon: 'ğŸŸ£', price: 500 },
            { id: 'skin_pixel', name: '8ë¹„íŠ¸ í”½ì…€', icon: 'ğŸ‘¾', price: 1000 },
            { id: 'skin_fire', name: 'ë¶ˆê½ƒ ë…¸íŠ¸', icon: 'ğŸ”¥', price: 2000 }
        ];

        let myMoney = 0;
        let myCustomItems = {}; // ë³´ìœ í•œ ìŠ¤í‚¨ ëª©ë¡
        let equippedSkin = 'skin_default';

        // 1. Firebase ë°ì´í„° ë¡œë“œ (ëˆ, ìŠ¤í‚¨ ì •ë³´)
        database.ref('users/' + loginID).on('value', snap => {
            const data = snap.val() || {};
            myMoney = data.money || 0;
            myCustomItems = data.inventory_custom || {}; 
            
            // ì¥ì°© ì •ë³´ í™•ì¸ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
            if(data.equipped && data.equipped.skin) {
                equippedSkin = data.equipped.skin;
            } else {
                equippedSkin = 'skin_default';
            }

            // ê¸°ë³¸ ìŠ¤í‚¨ì€ í•­ìƒ ë³´ìœ  ì²˜ë¦¬
            myCustomItems['skin_default'] = true;

            document.getElementById('myNick').innerText = data.nick || loginID;
            document.getElementById('myMoney').innerText = myMoney.toLocaleString();

            renderSkins();
        });

        // 2. ë¡œì»¬ ì¸ë²¤í† ë¦¬ ë¡œë“œ (íŒë§¤í•  ë¬¼ê±´ë“¤)
        // ìíŒê¸° ê²Œì„(game.html)ì€ localStorage 'myInventory'ì— ì•„ì´í…œì„ ì €ì¥í•¨
        renderLocalInventory();

        // --- [ë Œë”ë§] ìŠ¤í‚¨ ëª©ë¡ ---
        function renderSkins() {
            const grid = document.getElementById('skinGrid');
            grid.innerHTML = skinItems.map(item => {
                const isOwned = myCustomItems[item.id];
                const isEquipped = equippedSkin === item.id;
                
                let badgeClass = isEquipped ? 'badge-active' : (isOwned ? 'badge-equip' : 'badge-buy');
                let badgeText = isEquipped ? 'EQUIPPED' : (isOwned ? 'ì¥ì°©í•˜ê¸°' : `êµ¬ë§¤: ${item.price} G`);
                let cardClass = `skin-card ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;
                
                let clickAction = isOwned 
                    ? `equipSkin('${item.id}')` 
                    : `buySkin('${item.id}', '${item.name}', ${item.price})`;

                return `
                    <div class="${cardClass}" onclick="${clickAction}">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="status-badge ${badgeClass}">${badgeText}</div>
                    </div>
                `;
            }).join('');
        }

        // --- [ë Œë”ë§] íŒë§¤ ì¸ë²¤í† ë¦¬ ---
        function renderLocalInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = "";
            
            const savedInv = localStorage.getItem("myInventory");
            const inventory = savedInv ? JSON.parse(savedInv) : {};
            
            let hasItem = false;

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ìˆœíšŒ
            for (const [key, count] of Object.entries(inventory)) {
                // _priceë‚˜ _iconìœ¼ë¡œ ëë‚˜ëŠ” í‚¤ëŠ” ë©”íƒ€ë°ì´í„°ì´ë¯€ë¡œ ì œì™¸í•˜ê³ , ìˆ˜ëŸ‰ì´ 0 ì´ìƒì¸ ê²ƒë§Œ í‘œì‹œ
                if (!key.includes('_price') && !key.includes('_icon') && count > 0) {
                    hasItem = true;
                    
                    // ì €ì¥ëœ ê°€ê²©ê³¼ ì•„ì´ì½˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
                    const price = inventory[key + "_price"] || 10;
                    const icon = inventory[key + "_icon"] || 'ğŸ“¦';
                    
                    const div = document.createElement('div');
                    div.className = 'sell-item';
                    div.innerHTML = `
                        <div style="font-size:30px;">${icon}</div>
                        <div style="font-size:14px; font-weight:bold; margin-top:5px; color:#ddd;">${key}</div>
                        <div class="sell-count">ë³´ìœ : ${count}ê°œ</div>
                        <div class="sell-price">+ ${price} G</div>
                    `;
                    div.onclick = () => sellJunk(key, price, inventory);
                    grid.appendChild(div);
                }
            }

            if(!hasItem) {
                grid.innerHTML = '<div class="sell-empty">íŒ” ìˆ˜ ìˆëŠ” ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤.<br>(ê³ ì¥ë‚œ ìíŒê¸° ê²Œì„ì—ì„œ íšë“í•˜ì„¸ìš”)</div>';
            }
        }

        // --- [ê¸°ëŠ¥] ìŠ¤í‚¨ êµ¬ë§¤ ---
        function buySkin(id, name, price) {
            if(myMoney < price) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            if(!confirm(`[${name}] ìŠ¤í‚¨ì„ ${price}Gì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const updates = {};
            updates[`users/${loginID}/money`] = myMoney - price;
            updates[`users/${loginID}/inventory_custom/${id}`] = true;

            database.ref().update(updates)
                .then(() => alert("êµ¬ë§¤ ì™„ë£Œ!"))
                .catch(err => alert("ì˜¤ë¥˜: " + err));
        }

        // --- [ê¸°ëŠ¥] ìŠ¤í‚¨ ì¥ì°© ---
        function equipSkin(id) {
            database.ref(`users/${loginID}/equipped/skin`).set(id);
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìˆì–´ì„œ í™”ë©´ì€ ìë™ ê°±ì‹ ë¨
        }

        // --- [ê¸°ëŠ¥] ì¡ë™ì‚¬ë‹ˆ íŒë§¤ ---
        function sellJunk(itemName, price, inventory) {
            if (confirm(`[${itemName}] 1ê°œë¥¼ ${price}Gì— í™˜ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                
                // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìˆ˜ëŸ‰ ê°ì†Œ
                inventory[itemName] -= 1;
                
                // ìˆ˜ëŸ‰ì´ 0ì´ ë˜ë©´ ê´€ë ¨ ë°ì´í„° ëª¨ë‘ ì‚­ì œ
                if(inventory[itemName] <= 0) {
                    delete inventory[itemName];
                    delete inventory[itemName + "_price"];
                    delete inventory[itemName + "_icon"];
                }
                
                // ë³€ê²½ëœ ì¸ë²¤í† ë¦¬ ì €ì¥ ë° í™”ë©´ ê°±ì‹ 
                localStorage.setItem("myInventory", JSON.stringify(inventory));
                renderLocalInventory(); 

                // 2. ì„œë²„(Firebase)ì— ëˆ ì¶”ê°€
                database.ref('users/' + loginID).update({ money: myMoney + price })
                    .then(() => {
                        // (ì„ íƒì‚¬í•­) íŒë§¤ ì„±ê³µ ë©”ì‹œì§€ë‚˜ íš¨ê³¼ìŒ
                        // alert("íŒë§¤ ì™„ë£Œ!"); 
                    });
            }
        }

    </script>
</body>
</html>