<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë’·ê³¨ëª© í™˜ì „ì†Œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');

        body {
            background-color: #111;
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://www.transparenttextures.com/patterns/dark-brick-wall.png');
            color: #d0d0d0;
            font-family: 'Courier Prime', monospace;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            cursor: url(http://www.rw-designer.com/cursor-extern.php?id=88921), auto !important;
        }

        .navbar {
            width: 100%; background: #000; border-bottom: 2px solid #333; padding: 15px 0; text-align: center; margin-bottom: 30px;
        }
        .nav-links a {
            color: #888; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0 15px; transition: 0.3s;
        }
        .nav-links a:hover { color: #fff; text-shadow: 0 0 5px #fff; }

        .shop-container { width: 90%; max-width: 1000px; display: flex; gap: 20px; flex-wrap: wrap; }
        .shop-section {
            background: #222; border: 2px solid #444; border-radius: 8px; padding: 20px; flex: 1; min-width: 300px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
        }
        .section-title {
            margin-top: 0; border-bottom: 2px dashed #555; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px; color: #aaa; font-weight: bold; text-transform: uppercase;
        }

        .user-panel {
            width: 100%; background: #1a1a1a; border: 1px solid #ab0000; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; align-items: center; font-size: 16px;
        }

        .buy-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .buy-card {
            background: #333; border: 1px solid #555; border-radius: 5px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .buy-card:hover { border-color: #f0d090; background: #444; transform: translateY(-3px); }
        .item-icon { font-size: 35px; margin-bottom: 10px; }
        .item-name { font-size: 12px; margin-bottom: 5px; color: #fff; }
        .item-price { color: #f0d090; font-weight: bold; font-size: 14px; }
        .tag { position: absolute; top: 5px; right: 5px; font-size: 10px; padding: 2px 5px; border-radius: 3px; }
        .tag-owned { background: #4caf50; color: #fff; }

        .inventory-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;
        }
        .sell-card {
            background: #2a2a2a; border: 1px solid #444; border-radius: 5px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .sell-card:hover { border-color: #ab0000; background: #333; }
        .sell-price { color: #888; font-size: 11px; margin-top: 3px; }

        button.nav-btn { background: transparent; border: none; color: #888; font-family: 'Courier Prime'; cursor: pointer; font-size: 14px; font-weight: bold; }
        button.nav-btn:hover { color: #fff; text-shadow: 0 0 5px #fff; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-links">
            <a href="main.html">MAIN SYSTEM</a> | 
            <a href="shop.html" style="color: #fff; border-bottom: 1px solid #fff;">EXCHANGE</a> | 
            <a href="game.html">VENDING MACHINE</a> | 
            <button class="nav-btn" onclick="logout()">LOGOUT</button>
        </div>
    </nav>

    <div class="shop-container">
        
        <div class="user-panel">
            <div>ğŸ‘¤ <span id="myNick" style="color:#fff;">Guest</span></div>
            <div class="asset-info">
                <span>ğŸ’µ ê°€ì§„ ëˆ: <span id="myMoney" style="color:#f0d090;">loading...</span></span>
            </div>
        </div>

        <div class="shop-section">
            <h3 class="section-title">ğŸ”¨ ì¥ë¹„ êµ¬ë§¤</h3>
            <div class="buy-grid">
                <div class="buy-card" id="rodCard" onclick="buyRod()">
                    <div id="rodTag"></div>
                    <div class="item-icon">ğŸ”¨</div>
                    <div class="item-name">ë¬´ê±°ìš´ ë§ì¹˜</div>
                    <div style="font-size:10px; color:#888;">íš¨ê³¼ì ì¸ íƒ€ê²© (ì„±ëŠ¥UP)</div>
                    <div class="item-price" id="rodPriceDisplay">500 G</div>
                </div>
            </div>
        </div>

        <div class="shop-section">
            <h3 class="section-title" style="color:#ab0000;">ğŸ’ ì¡ë™ì‚¬ë‹ˆ íŒë§¤ (ë¡œì»¬ ì €ì¥ì†Œ)</h3>
            <div class="inventory-list" id="inventoryGrid">
                <div style="color:#555; text-align:center; padding:20px; grid-column: span 3;">
                    ê°€ë°©ì„ í™•ì¸í•˜ëŠ” ì¤‘...
                </div>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
            authDomain: "cheongjuca.firebaseapp.com",
            databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
            projectId: "cheongjuca",
            storageBucket: "cheongjuca.firebasestorage.app",
            messagingSenderId: "455437421321",
            appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // [í•µì‹¬ ìˆ˜ì •] ë‹‰ë„¤ì„ì´ ì•„ë‹ˆë¼ 'loginID'ë¥¼ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤!
        const loginID = localStorage.getItem("loginID");
        const nickDisplay = localStorage.getItem("userNick");

        if(!loginID) {
            alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            location.href='index.html';
        }

        // í™”ë©´ì—ëŠ” ë‹‰ë„¤ì„ ë³´ì—¬ì£¼ê¸°
        document.getElementById('myNick').innerText = nickDisplay || loginID;

        let money = 0, rodLevel = 1;

        // [í•µì‹¬ ìˆ˜ì •] DB ì¡°íšŒ ì‹œ loginID ì‚¬ìš© (users/runner1 ë“±)
        database.ref('users/' + loginID).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (data.money === undefined) {
                database.ref('users/' + loginID).update({ money: 100, rod_level: 1 });
                return;
            }

            money = data.money;
            rodLevel = data.rod_level || 1;

            document.getElementById('myMoney').innerText = money;

            // ì¥ë¹„ ìƒíƒœ ì—…ë°ì´íŠ¸
            if(rodLevel >= 2) {
                document.getElementById('rodTag').innerHTML = '<span class="tag tag-owned">ë³´ìœ ì¤‘</span>';
                document.getElementById('rodPriceDisplay').innerText = "ë§¤ì§„";
                document.getElementById('rodCard').style.opacity = "0.5";
            }
        });

        // ë¡œì»¬ ì¸ë²¤í† ë¦¬ ë¡œë“œ
        renderLocalInventory();

        function buyRod() {
            if (rodLevel >= 2) return alert("ì´ë¯¸ ë§ì¹˜ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.");
            if (money < 500) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            
            if (confirm("ë¬´ê±°ìš´ ë§ì¹˜ë¥¼ 500Gì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                database.ref('users/' + loginID).update({
                    money: money - 500,
                    rod_level: 2
                });
                alert("ì¥ë¹„ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!");
            }
        }

        function renderLocalInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = "";
            
            const savedInv = localStorage.getItem("myInventory");
            const inventory = savedInv ? JSON.parse(savedInv) : {};
            
            let hasItem = false;
            for (const [key, count] of Object.entries(inventory)) {
                // _priceë‚˜ _iconì€ ë©”íƒ€ë°ì´í„°ì´ë¯€ë¡œ ê±´ë„ˆëœ€
                if (!key.includes('_price') && !key.includes('_icon') && count > 0) {
                    hasItem = true;
                    const price = inventory[key + "_price"] || 0;
                    const icon = inventory[key + "_icon"] || 'ğŸ“¦';
                    
                    const div = document.createElement('div');
                    div.className = 'sell-card';
                    div.innerHTML = `
                        <div class="item-icon">${icon}</div>
                        <div style="font-size:11px; margin-bottom:5px;">${key} (${count}ê°œ)</div>
                        <div class="sell-price">+ ${price} G</div>
                    `;
                    div.onclick = () => sellItem(key, price, inventory);
                    grid.appendChild(div);
                }
            }
            if(!hasItem) grid.innerHTML = '<div style="color:#555; text-align:center; padding:20px; grid-column: span 3;">ê°€ë°©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>';
        }

        function sellItem(itemName, price, inventory) {
            if (confirm(`${itemName}ì„(ë¥¼) ${price}Gì— í™˜ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                
                // 1. ë¡œì»¬ ë°ì´í„° ìˆ˜ì •
                inventory[itemName] -= 1;
                if(inventory[itemName] <= 0) {
                    delete inventory[itemName];
                    delete inventory[itemName + "_price"];
                    delete inventory[itemName + "_icon"];
                }
                localStorage.setItem("myInventory", JSON.stringify(inventory));
                renderLocalInventory(); 

                // 2. ì„œë²„ ëˆ ì¶”ê°€ [í•µì‹¬ ìˆ˜ì •: loginID ì‚¬ìš©]
                database.ref('users/' + loginID).update({ money: money + price });
            }
        }

        function logout() { localStorage.clear(); location.href = "index.html"; }
    </script>
</body>
</html>