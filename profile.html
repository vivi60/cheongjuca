<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒì¡´ì ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // 2. Firebase ì„¤ì • (ë³´ë‚´ì£¼ì‹  game.htmlì˜ ì„¤ì •ê°’ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤)
        const firebaseConfig = {
            apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
            authDomain: "cheongjuca.firebaseapp.com",
            databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
            projectId: "cheongjuca",
            storageBucket: "cheongjuca.firebasestorage.app",
            messagingSenderId: "455437421321",
            appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
            measurementId: "G-9XG7JRFM3D"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ë¡œê·¸ì¸ ì²´í¬ ë° ìƒë‹¨ ë°” ì„¤ì •
        (function() {
            const status = localStorage.getItem("loginStatus");
            const nick = localStorage.getItem("userNick");

            if (!status) { location.href = "index.html"; }

            window.addEventListener('load', function() {
                const badge = document.getElementById("userBadge");
                if (badge && nick) {
                    if (status === "admin") {
                        badge.innerText = `[ê´€ë¦¬ì ëª¨ë“œ]`;
                        badge.style.color = "#ff0000";
                    } else {
                        badge.innerText = `[${nick}]`;
                        badge.style.color = "#cccccc";
                    }
                    badge.style.display = "inline";
                }
                loadProfile(); // í”„ë¡œí•„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
            });
        })();


// ìƒë‹¨ì— userDB ëª…ë‹¨ ì¶”ê°€ (ì•„ì´ë””ì™€ ë‹‰ë„¤ì„ì„ ë§¤ì¹­í•˜ê¸° ìœ„í•¨)
const userDB = {
    "13reaking_news":    { nick: "ê´€ë¦¬ì" },
    "runner1":  { nick: "ëŸ¬ë„ˆ1" },
    "13reaking_system":  { nick: "ì‹œìŠ¤í…œ" }
};


function loadProfile() {
    const params = new URLSearchParams(window.location.search);
    const targetID = params.get('name'); 
    const myNick = localStorage.getItem("userNick");

    if (!targetID) return;

    database.ref('users/' + targetID).on('value', (snapshot) => {
        const displayData = snapshot.val() || { money: 0, hp: 100, infection: 0, inventory: {}, desc: "ê¸°ë¡ ì—†ìŒ" };
        
        // userDBì— ì •ë³´ê°€ ì—†ë”ë¼ë„ ì˜¤ë¥˜ê°€ ë‚˜ì§€ ì•Šë„ë¡ ìˆ˜ì •
        const nickName = (userDB[targetID] ? userDB[targetID].nick : targetID);
        document.getElementById('pName').innerText = nickName;
        
        document.getElementById('pMoney').innerText = displayData.money || 0;
        document.getElementById('pHP').innerText = displayData.hp || 100;
        document.getElementById('pInf').innerText = displayData.infection || 0;
        document.getElementById('pDesc').innerText = displayData.desc || "íŠ¹ë³„í•œ íŠ¹ì´ì‚¬í•­ ì—†ìŒ.";
        
        // ë³¸ì¸ í™•ì¸ ì¡°ê±´ ìˆ˜ì • (localStorageì— ì €ì¥ëœ ë‹‰ë„¤ì„ê³¼ ë¹„êµí•˜ê±°ë‚˜ script.jsì˜ ì•„ì´ë””ì™€ ë¹„êµ)
        if (userDB[targetID] && userDB[targetID].nick === myNick) {
            document.getElementById('myEditZone').style.display = "block";
            document.getElementById('editDescInput').value = displayData.desc || "";
        }

        renderInventory(displayData.inventory || {});
    });
}

       // profile.html ë‚´ë¶€ì˜ updateMyProfile í•¨ìˆ˜ ìˆ˜ì •
function updateMyProfile() {
    // userNick ëŒ€ì‹  loginIDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const myID = localStorage.getItem("loginID"); 
    const newDesc = document.getElementById('editDescInput').value;
    
    if (!myID) {
        alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        return;
    }

    // ì´ì œ users/13reaking_system ê²½ë¡œì— ì •í™•íˆ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
    database.ref('users/' + myID).update({
        desc: newDesc
    }).then(() => {
        alert("í”„ë¡œí•„ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }).catch((error) => {
        console.error("ìˆ˜ì • ì‹¤íŒ¨:", error);
    });
}

     // ì•„ì´í…œë³„ íšŒë³µëŸ‰ ì„¤ì •
const ITEM_EFFECTS = {
    "ì´ˆì½”ìš°ìœ ": { hp: 20 },
    "ì—ë„ˆì§€ë“œë§í¬": { hp: 10 },
    "êµ¬ê¸‰ìƒì": { hp: 50 }
};

function renderInventory(invData) {
    const grid = document.getElementById('pInventoryGrid');
    grid.innerHTML = "";
    
    // ë°ì´í„°ë² ì´ìŠ¤ì˜ í‚¤ê°’(id)ì„ í•¨ê»˜ ë³´ê´€í•˜ì—¬ ì‚­ì œ ì‹œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    Object.entries(invData).forEach(([key, item]) => {
        const div = document.createElement('div');
        div.className = "inventory-item"; 
        div.style = "background: #222; border: 1px solid #444; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer;";
        
        // í´ë¦­í•˜ë©´ ì•„ì´í…œì„ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
        div.onclick = () => useItem(key, item.name);
        
        div.innerHTML = `
            <div style="font-size: 30px; margin-bottom:5px;">${item.icon || 'ğŸ“¦'}</div>
            <div style="font-size: 14px; color: #ddd;">${item.name}</div>
        `;
        grid.appendChild(div);
    });
}

function useItem(itemKey, itemName) {
    const myID = localStorage.getItem("loginID");
    if (!myID) return;

    if (!confirm(`${itemName}ì„(ë¥¼) ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    // 1. í˜„ì¬ ì²´ë ¥ ìƒíƒœë¥¼ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤.
    database.ref('users/' + myID).once('value', (snapshot) => {
        const userData = snapshot.val();
        let currentHP = userData.hp || 100;
        
        // 2. ì•„ì´í…œ íš¨ê³¼ ì ìš©
        const effect = ITEM_EFFECTS[itemName];
        if (effect && effect.hp) {
            currentHP = Math.min(100, currentHP + effect.hp); // ìµœëŒ€ ì²´ë ¥ 100 ì œí•œ
        }

        // 3. Firebase ì—…ë°ì´íŠ¸: ì²´ë ¥ì€ ëŠ˜ë¦¬ê³ , ì•„ì´í…œì€ ì‚­ì œí•©ë‹ˆë‹¤.
        const updates = {};
        updates[`users/${myID}/hp`] = currentHP;
        updates[`users/${myID}/inventory/${itemKey}`] = null; // nullë¡œ ì„¤ì •í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ì‚­ì œë©ë‹ˆë‹¤.

        database.ref().update(updates).then(() => {
            alert(`${itemName}ì„(ë¥¼) ì‚¬ìš©í•˜ì—¬ ì²´ë ¥ì´ ${currentHP}ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        });
    });
}

        function logout() {
            localStorage.removeItem("loginStatus");
            localStorage.removeItem("userNick");
            location.href = "index.html";
        }
    </script>

    <style>
        .profile-card {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #444;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .stat-item { font-size: 1.2rem; margin: 10px 0; }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
            height: 80px;
            background: #111;
            color: #fff;
            border: 1px solid #ab0000;
            padding: 10px;
            border-radius: 5px;
            font-family: 'DaraeHandwriting';
            resize: none;
        }
    </style>
</head>
<body class="profile-page">
    
    <nav class="navbar">
        <div class="logo">
            OUT BREAK 
            <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;"></span>
        </div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="sub.html">ìƒì¡´ìëª©ë¡</a></li>
            <li><a href="board.html">ììœ ê²Œì‹œíŒ</a></li>
            <li><a href="quest.html">ì˜ë¢°ê²Œì‹œíŒ</a></li>
            <li><a href="game.html">ë‚šì‹œí„°</a></li>
            <li><a href="vending.html">ìíŒê¸°</a></li>
            <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>

    <div class="profile-card">
        <div style="text-align: center; margin-bottom: 20px;">
    <img id="pImg" src="https://i.imgur.com/3SPL075.png" style="width: 150px; height: 150px; border-radius: 50%; border: 3px solid #ab0000; object-fit: cover;">
</div>
        <h1 id="pName" style="color: #ab0000; margin-bottom: 5px;">ë¡œë”© ì¤‘...</h1>
        <hr style="border: 0.5px solid #444;">
        
        <div class="stat-item" style="color: gold;">ğŸ’° ì†Œì§€ê¸ˆ: <span id="pMoney">0</span> G</div>
        <div class="stat-item" style="color: #ff4444;">â¤ï¸ ì²´ë ¥: <span id="pHP">100</span></div>
        <div class="stat-item" style="color: #00ff00;">ğŸ§ª ê°ì—¼ë„: <span id="pInf">0</span>%</div>
        
        <div style="margin-top: 20px; background: #252525; padding: 15px; border-radius: 10px;">
            <h3 style="margin-top: 0; color: #888;">ìƒì¡´ ê¸°ë¡</h3>
            <p id="pDesc" style="line-height: 1.5;"></p>
            
        <div id="myEditZone" style="display: none; border-top: 1px dashed #444; padding-top: 15px; margin-top: 15px;">
            <textarea id="editDescInput" placeholder="ë‹¹ì‹ ì˜ ê¸°ë¡ì„ ë‚¨ê¸°ì„¸ìš”..."></textarea>
            <button onclick="updateMyProfile()" style="margin-top:10px; width:100%; background:#ab0000; color:white; border:none; padding:10px; cursor:pointer; border-radius:5px;">ê¸°ë¡ ê°±ì‹ </button>
        </div>

        <h3 style="margin-top: 30px;">ì†Œì§€í’ˆ ê°€ë°©</h3>
        <div id="pInventoryGrid" class="inventory-grid"></div>
    </div>

</body>
</html>

