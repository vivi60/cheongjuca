<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°œì¸ í”„ë¡œí•„</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --accent-color: #535353; --bg-dark: #111; --panel-bg: #1a1a1a; --text-gray: #ccc; --nav-font: 'Pretendard', sans-serif; }
        
        body { background-color: var(--bg-dark); color: white; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; overflow-x: hidden; }

        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 0 50px; background: rgba(0, 0, 0, 0.9); border-bottom: 1px solid var(--accent-color); height: 60px; position: fixed; top: 0; width: 100%; z-index: 1000; box-sizing: border-box; font-family: var(--nav-font); }
        .nav-links { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
        .nav-links a { color: white; text-decoration: none; font-size: 1.1rem; }

        /* [ìˆ˜ì •ë¨] í—¤ë” ë¡œê³  ìŠ¤íƒ€ì¼ (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ê¸€ê¼´ í†µì¼ + í˜¸ë²„ íš¨ê³¼) */
        .header-logo {
            font-family: 'Black Ops One', cursive; /* ê¸€ê¼´ í†µì¼ */
            font-size: 28px; 
            color: #efefef; /* ê¸°ë³¸ ìƒ‰ìƒ (ë°ì€ íšŒìƒ‰) */
            text-shadow: 2px 2px 4px #000; 
            cursor: pointer;
            text-decoration: none;
            transition: color 0.3s; /* ìƒ‰ìƒ ë¶€ë“œëŸ½ê²Œ ì „í™˜ */
        }

        /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ìƒ‰ìƒ ë³€ê²½ */
        .header-logo:hover {
            color: #535353; /* í˜¸ë²„ ìƒ‰ìƒ (ì§„í•œ íšŒìƒ‰) */
        }

        .profile-wrapper { display: flex; width: 100vw; height: calc(100vh - 60px); margin-top: 60px; }
        /* [ìˆ˜ì •] ì „ì‹  ì´ë¯¸ì§€ ì˜ì—­ (ì™¼ìª½ 40% ê³µê°„ë§Œ ì“°ë„ë¡ ë³€ê²½) */
        .portrait-section { 
            width: 40%; /* â˜… í•µì‹¬! 100%ì—ì„œ 40%ë¡œ ì¤„ì„ */
            height: 100%; 
            position: fixed; 
            top: 50px; /* í—¤ë” ë†’ì´ */
            left: 0;
            background: transparent; /* ë°°ê²½ íˆ¬ëª… */
            
            /* ì •ë ¬ ì„¤ì • */
            display: flex; 
            justify-content: center; /* 40% ê³µê°„ ì•ˆì—ì„œ ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            align-items: center;     /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            
            z-index: 1; 
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
            overflow: hidden;     /* ì‚ì ¸ë‚˜ì˜¤ëŠ” ë¶€ë¶„ ìë¥´ê¸° */
        }
        .portrait-section img { width: auto; height: 100%; object-fit: contain; }
        /* [ìˆ˜ì •] ì •ë³´ì°½ì„ ì˜¤ë¥¸ìª½ ìœ„ì— ë„ìš°ê¸° (ìŠ¬ë¼ì´ë“œ ê¸°ëŠ¥) */
        .info-section { 
            width: 60%; /* ë„ˆë¹„ ìœ ì§€ */
            height: 100%; 
            position: fixed; /* ë°°ì¹˜ê°€ ì•„ë‹Œ ë„ìš°ê¸° */
            right: 0; top: 50px; /* ì˜¤ë¥¸ìª½ ê³ ì • */
            background: rgba(21, 21, 21, 0.6); /* ë°°ê²½ ì‚´ì§ íˆ¬ëª…í•˜ê²Œ */
            overflow-y: auto; padding: 60px; box-sizing: border-box; 
            z-index: 20; /* ì‚¬ì§„ë³´ë‹¤ ìœ„ì— */
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„ */
            border-left: 1px solid #535353;
        }

        /* [ì¶”ê°€] ë‹«í˜”ì„ ë•Œ ìˆ¨ê¸°ëŠ” í´ë˜ìŠ¤ */
        .info-section.closed {
            transform: translateX(100%); /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ì–´ë²„ë¦¼ */
        }

        /* [ì¶”ê°€] ì ‘ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .toggle-btn {
            position: absolute;
            top: 50%; left: -40px; /* íŒ¨ë„ ì™¼ìª½ì— ë§¤ë‹¬ë¦¼ */
            width: 40px; height: 80px;
            background: #535353; color: white;
            border: none; border-radius: 10px 0 0 10px;
            cursor: pointer; font-size: 20px; font-weight: bold;
            box-shadow: -5px 0 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
        }

        .toggle-btn:hover { background: #efefef; }

        #editBtn { position: absolute; top: 20px; right: 20px; background: var(--accent-color); color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; display: none; z-index: 10; }

        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; border-top: 2px solid var(--accent-color); }
        .info-table td { padding: 15px; border-bottom: 1px solid #333; }
        /* ì´ë ‡ê²Œ ë°”ê¾¸ì„¸ìš”! */
.label { color: #efefef; font-weight: bold; width: 80px; font-size: 0.9rem; }
        .value { color: #eee; }
        .head-img { width: 120px; height: 120px; border-radius: 10px; border: 2px solid var(--accent-color); object-fit: cover; background: #222; }
        .section-title { font-size: 1.2rem; color: var(--accent-color); border-bottom: 1px solid #444; margin: 30px 0 15px; padding-bottom: 5px; font-family: var(--nav-font); }

        .stat-bars { display: flex; gap: 4px; }
        .bar { width: 14px; height: 16px; background: #333; border-radius: 2px; }
        /* ìˆ˜ì • ì˜ˆì‹œ (ë…¸ë€ìƒ‰ìœ¼ë¡œ ë³€ê²½) */
.bar.fill { 
    background: #ff0000;  /* ë§‰ëŒ€ ìƒ‰ìƒ */
    box-shadow: 0 0 5px #ff0000; /* ë¹›ë‚˜ëŠ” íš¨ê³¼ ìƒ‰ìƒ */
}
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        /* [ìˆ˜ì •] ì¸ë²¤í† ë¦¬ ì•„ì´í…œ: ì •ì‚¬ê°í˜• ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .inv-item { 
            background: #222; 
            border-radius: 8px; 
            text-align: center; 
            border: 1px solid #333; 
            transition: 0.3s; 
            cursor: pointer; 
            
            /* ì •ì‚¬ê°í˜• ë§Œë“¤ê¸° í•µì‹¬ */
            aspect-ratio: 1 / 1; 
            
            /* ë‚´ìš©ë¬¼ì„ ì¤‘ì•™ìœ¼ë¡œ ì •ë ¬ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box; /* íŒ¨ë”©ì´ í¬ê¸°ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ì„¤ì • */
        }

        .inv-item:hover { 
            border-color: var(--accent-color); 
            background: #2a2a2a; 
            transform: translateY(-3px); /* í˜¸ë²„ ì‹œ ì‚´ì§ ë– ì˜¤ë¥´ëŠ” íš¨ê³¼ */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ì•„ì´í…œ ë‚´ë¶€ í…ìŠ¤íŠ¸ í¬ê¸° ë° ê°„ê²© ë¯¸ì„¸ ì¡°ì • */
        .inv-item div {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis; /* ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ë©´ ... ì²˜ë¦¬ */
            white-space: nowrap;
            margin-top: 5px;
        }
        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto; padding: 50px 0; }
        .modal-content { width: 90%; max-width: 850px; margin: auto; background: #1a1a1a; padding: 40px; border-radius: 15px; border: 1px solid var(--accent-color); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .form-group label { color: var(--accent-color); font-weight: bold; font-size: 0.85rem; }
        .form-group input, .form-group textarea { padding: 10px; background: #0a0a0a; border: 1px solid #333; color: white; border-radius: 5px; }
        
        #myInteractionSection button:hover { filter: brightness(1.3); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(171, 0, 0, 0.4); }

        /* ì•Œë¦¼ ë²„íŠ¼ ë° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .noti-btn {
            position: absolute; top: 20px; right: 140px; 
            background: #333; color: #ddd; border: 1px solid #555;
            padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;
            display: none; z-index: 10;
        }
        .noti-btn:hover { background: #444; color: white; }
        .noti-btn.new-alert { border-color: #ff0000; color: #ffcccc; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        #notificationList {
            display: none; margin-bottom: 20px; background: #111; border: 1px solid #444; border-radius: 8px; max-height: 300px; overflow-y: auto; box-shadow: inset 0 0 20px #000;
        }
        .noti-item { padding: 12px 15px; border-bottom: 1px solid #333; font-size: 0.9rem; color: #aaa; display: flex; justify-content: space-between; }
        .noti-item.unread { background: rgba(171, 0, 0, 0.1); color: #fff; border-left: 3px solid var(--accent-color); }
        .noti-time { font-size: 0.75rem; color: #666; margin-left: 10px; }
    
    /* --- í”„ë¡œí•„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ --- */

/* ì œëª©ì„ í´ë¦­ ê°€ëŠ¥í•œ ë²„íŠ¼ì²˜ëŸ¼ ë³´ì´ê²Œ ë³€ê²½ */
.section-title {
    cursor: pointer;
    display: flex;
    justify-content: space-between; /* í™”ì‚´í‘œë¥¼ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ */
    align-items: center;
    user-select: none; /* í…ìŠ¤íŠ¸ ë“œë˜ê·¸ ë°©ì§€ */
    transition: color 0.3s;
}

.section-title:hover {
    color: #efefef; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë°ì€ ë¹¨ê°• */
}

/* í™”ì‚´í‘œ ì•„ì´ì½˜ (ê¸°ë³¸: ì•„ë˜ìª½) */
.section-title::after {
    content: 'â–¼';
    font-size: 0.8rem;
    color: #666;
    transition: transform 0.3s;
}

/* í¼ì³ì§„ ìƒíƒœ(active í´ë˜ìŠ¤)ì¼ ë•Œ í™”ì‚´í‘œ íšŒì „ */
.section-title.active::after {
    transform: rotate(180deg); /* ìœ„ìª½ì„ í–¥í•˜ê²Œ */
    color: #535353;
}

/* ë‚´ìš©ì„ ìˆ¨ê¸°ëŠ” í´ë˜ìŠ¤ */
.collapsed {
    display: none !important;
}

    </style>
</head>
<body>

    <header class="simple-header" style="position: fixed; top: 0; left: 0; width: 100%; height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; box-sizing: border-box; z-index: 1000; background: rgba(21, 21, 21, 0.95); border-bottom: 1px solid #535353;">
        <div class="header-logo" onclick="location.href='main.html'">OUTBREAK</div>
        <button class="back-btn" onclick="location.href='sub.html'" style="background: transparent; border: none; color: #efefef; font-size: 20px; font-family: 'Black Ops One'; cursor: pointer; margin-top: 20px;">â—€ LIST</button>
    
    </header>

    <div id="bgLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: 100% 100%; background-position: center; opacity: 1; z-index: 0;"></div>
    <div id="bgOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.2) 60%, rgba(0,0,0,0.9) 100%); z-index: 1; pointer-events: none;"></div>

    <div class="portrait-section">
        <img id="pFullBody" src="" alt="ì „ì‹  ì´ë¯¸ì§€" style="height: 110%; object-fit: cover; transform: translateY(5%);">
    </div>

   <div class="left-info-panel" style="position: absolute; bottom: 50px; left: 50px; width: 320px; z-index: 10; display: flex; flex-direction: column; gap: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
        
    <div id="pCatchphrase" style="font-size: 18px; color: #efefef; font-weight: 300; border-left: 3px solid #efefef; padding-left: 10px; margin-top:5px;">-</div>
        

            <div id="pName" style="font-size: 48px; font-weight: 900; line-height: 1; color:white;">NAME</div>
            
        <div>
            
            
        </div>

        <div id="statsWrapper" style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
            <div style="display: flex; align-items: center; color:#ccc; font-size:14px;">
                <span style="width:60px;">ê·¼ë ¥</span> <div class="stat-bars" id="stat-str"></div>
            </div>
            <div style="display: flex; align-items: center; color:#ccc; font-size:14px;">
                <span style="width:60px;">ë¯¼ì²©</span> <div class="stat-bars" id="stat-agi"></div>
            </div>
            <div style="display: flex; align-items: center; color:#ccc; font-size:14px;">
                <span style="width:60px;">ëŒ€ì¸ê´€ê³„</span> <div class="stat-bars" id="stat-soc"></div>
            </div>
            <div style="display: flex; align-items: center; color:#ccc; font-size:14px;">
                <span style="width:60px;">í–‰ìš´</span> <div class="stat-bars" id="stat-luk"></div>
            </div>
        </div>

        <div id="pOneLiner" style="margin-top: 20px; font-size: 14px; color: #ddd; font-style: italic; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 0 15px 0 15px; border-left: 4px solid #fff;">
            "í•œë§ˆë””ê°€ ì—†ìŠµë‹ˆë‹¤."
        </div>
    </div>

    <div class="info-section">
        <button class="toggle-btn" onclick="toggleSidebar()">></button>
        <button id="notiBtn" class="noti-btn" onclick="toggleNotifications()">ì•Œë¦¼</button>
        <button id="editBtn" onclick="openEditModal()">ìˆ˜ì •</button>
        
        <div id="notificationList"></div>

        <div class="section-title">BASIC INFO</div>
        <table class="info-table">
            <tr>
                <td rowspan="3" style="width: 120px; text-align: center; padding:0;">
                    <img id="pHeadImg" class="head-img" src="" alt="ë‘ìƒ">
                </td>
                <td class="label">ë‚˜ì´</td><td class="value" id="pAge">-</td>
            </tr>
            <tr>
                <td class="label">ì„±ë³„</td><td class="value" id="pGender">-</td>
            </tr>
            <tr>
                <td class="label">ì§ì—…</td><td class="value" id="pJob">-</td>
            </tr>
            <tr>
                <td class="label" style="text-align:center;">ì‹ ì²´</td>
                <td class="label">í‚¤/ì²´ì¤‘</td><td class="value" id="pBody">-</td>
            </tr>
            <tr>
                <td class="label" style="text-align:center;">ìƒíƒœ</td>
                <td class="label">ì²´ë ¥</td><td class="value" style="color: #ff4444;"><span id="pHP">100</span></td>
            </tr>
            <tr>
                <td class="label" style="text-align:center;">ê°ì—¼</td>
                <td colspan="2" class="value" id="pInfection">-</td>
            </tr>
            <tr>
                <td class="label" style="text-align:center;">ìì‚°</td>
                <td class="value" style="color: gold;" colspan="2"><span id="pMoney">0</span> ì›</td>
            </tr>
        </table>

        <div class="section-title active" onclick="toggleSection('pPersonality', this)">PERSONALITY</div>
        <div id="pPersonality" style="white-space: pre-wrap; color: #ccc; margin-bottom: 30px;"></div>

        <div class="section-title active" onclick="toggleSection('pEtc', this)">ETC</div>
        <div id="pEtc" style="white-space: pre-wrap; color: #ccc; margin-bottom: 30px;"></div>

        <div class="section-title active" onclick="toggleSection('pItems', this)">ITEMS</div>
        <div id="pItems" style="white-space: pre-wrap; color: #ccc; margin-bottom: 30px;"></div>

        <div class="section-title active" onclick="toggleSection('inventoryList', this)">INVENTORY</div>
        <div id="inventoryList" class="inventory-grid"></div>
        
        <div id="myInteractionSection" style="display: none; margin-top: 30px; border-top: 1px solid #535353; padding-top: 20px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="openUserSelectModal('money')" style="flex: 1; padding: 12px; background: #535353; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ’° ì†¡ê¸ˆ</button>
                <button onclick="openUserSelectModal('item')" style="flex: 1; padding: 12px; background: #535353; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ ì„ ë¬¼</button>
            </div>
        </div>
    </div>

    <div id="userSelectModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3000;">
        <div style="width:90%; max-width:400px; margin:100px auto; background:#1a1a1a; border:1px solid #535353; padding:20px; border-radius:10px;">
            <h3 style="color:#535353; margin-top:0;">ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</h3>
            <div id="userListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
            <button onclick="closeUserModal()" style="width:100%; padding:10px; background:#444; color:white; border:none; border-radius:5px; cursor:pointer;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="editModal">
        <div class="modal-content">
            <h2 style="color: #535353; margin-top: 0;">ì •ë³´ ìˆ˜ì •</h2>
            <div class="form-row"><div class="form-group"><label>ë°°ê²½ ì´ë¯¸ì§€ URL</label><input type="text" id="editBgImg"></div></div>
            <div class="form-row">
                <div class="form-group"><label>ì „ì‹  ì´ë¯¸ì§€ (URL)</label><input type="text" id="editFullBody"></div>
                <div class="form-group"><label>ë‘ìƒ ì´ë¯¸ì§€ (URL)</label><input type="text" id="editHead"></div>
            </div>
            <div class="form-row"><div class="form-group"><label>ì´ë¦„</label><input type="text" id="editNickname"></div></div>  
            <div class="form-row">
                <div class="form-group"><label>ìºì¹˜í”„ë ˆì´ì¦ˆ</label><input type="text" id="editCatch"></div>
                <div class="form-group"><label>í•œë§ˆë””</label><input type="text" id="editOne"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ë‚˜ì´</label><input type="text" id="editAge"></div>
                <div class="form-group"><label>ì„±ë³„</label><input type="text" id="editGender"></div>
                <div class="form-group"><label>ì§ì—…</label><input type="text" id="editJob"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>í‚¤ (cm)</label><input type="text" id="editHeight"></div>
                <div class="form-group"><label>ëª¸ë¬´ê²Œ (kg)</label><input type="text" id="editWeight"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ê·¼ë ¥</label><input type="number" id="editStr" min="0" max="10"></div>
                <div class="form-group"><label>ë¯¼ì²©</label><input type="number" id="editAgi" min="0" max="10"></div>
                <div class="form-group"><label>ëŒ€ì¸ê´€ê³„</label><input type="number" id="editSoc" min="0" max="10"></div>
                <div class="form-group"><label>í–‰ìš´</label><input type="number" id="editLuk" min="0" max="10"></div>
            </div>
            <div class="form-group"><label>ì„±ê²©</label><textarea id="editPersonality"></textarea></div>
            <div class="form-group"><label>ê¸°íƒ€</label><textarea id="editEtc"></textarea></div>
            <div class="form-group"><label>ì†Œì§€í’ˆ</label><textarea id="editItems"></textarea></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="saveProfile()" style="flex: 2; padding: 15px; background: #535353; color: white; border: none; cursor: pointer;">ì €ì¥</button>
                <button onclick="closeEditModal()" style="flex: 1; padding: 15px; background: #444; color: white; border: none; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
        authDomain: "cheongjuca.firebaseapp.com",
        databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
        projectId: "cheongjuca",
        storageBucket: "cheongjuca.firebasestorage.app",
        messagingSenderId: "455437421321",
        appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const params = new URLSearchParams(window.location.search);
    const targetID = params.get('name');
    const myID = localStorage.getItem("loginID") || localStorage.getItem("userNick");
    const myNick = localStorage.getItem("userNick") || "ìƒì¡´ì";

    function createStatBars(containerId, value) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            const bar = document.createElement('div');
            bar.className = i <= value ? 'bar fill' : 'bar';
            container.appendChild(bar);
        }
    }

    function loadProfile() {
        if (!targetID) return;
        database.ref('users/' + targetID).on('value', (snapshot) => {
            const d = snapshot.val() || {};
            // â–¼â–¼â–¼ [ì¶”ê°€í•  ì½”ë“œ] ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì • (ê¸°ë³¸ê°’ ì ìš©) â–¼â–¼â–¼
            const defaultBg = 'https://firebasestorage.googleapis.com/v0/b/cheongjuca.firebasestorage.app/o/image%2F%E1%84%80%E1%85%A2%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%AA%E1%84%86%E1%85%A7%E1%86%AB%E1%84%87%E1%85%A2%E1%84%80%E1%85%A7%E1%86%BC.png?alt=media&token=f7043cce-163a-4a4f-aa2b-ca55f2516d47';
            const bgUrl = d.bgImg || defaultBg;
            document.getElementById('bgLayer').style.backgroundImage = `url('${bgUrl}')`;
            // â–²â–²â–² ì¶”ê°€ ë â–²â–²â–²
            document.getElementById('pName').innerText = d.nickname || targetID;
            document.getElementById('pCatchphrase').innerText = d.catchphrase || "";
            document.getElementById('pOneLiner').innerText = d.oneLiner || "";
            document.getElementById('pAge').innerText = d.age || "-";
            document.getElementById('pGender').innerText = d.gender || "-";
            document.getElementById('pJob').innerText = d.job || "-";
            document.getElementById('pBody').innerText = `${d.height || '-'}cm / ${d.weight || '-'}kg`;
            document.getElementById('pMoney').innerText = (d.money || 0).toLocaleString();
            document.getElementById('pHP').innerText = d.hp || 0;
            document.getElementById('pPersonality').innerText = d.personality || "";
            document.getElementById('pEtc').innerText = d.etc || "";
            document.getElementById('pItems').innerText = d.items || "ì†Œì§€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.";
            
            const infDisplay = document.getElementById('pInfection');
            if (d.infection === "ì¢€ë¹„") { infDisplay.innerText = "ì¢€ë¹„í™”"; infDisplay.style.color = "#ff4444"; }
            else if (d.infection > 0) { infDisplay.innerText = "ê°ì—¼ " + d.infection + "ë‹¨ê³„"; infDisplay.style.color = "#00ff00"; }
            else { infDisplay.innerText = "ì •ìƒ"; infDisplay.style.color = "#888"; }

            if(d.fullBodyImg) document.getElementById('pFullBody').src = d.fullBodyImg;
            if(d.img) document.getElementById('pHeadImg').src = d.img;

            createStatBars('stat-str', d.stat_str || 0);
            createStatBars('stat-agi', d.stat_agi || 0);
            createStatBars('stat-soc', d.stat_soc || 0);
            createStatBars('stat-luk', d.stat_luk || 0);

            const invList = document.getElementById('inventoryList');
            invList.innerHTML = '';
            const invData = d.inventory || {};
            // ì¸ë²¤í† ë¦¬ ìƒì„± ë¶€ë¶„ ìˆ˜ì •
            Object.entries(invData).forEach(([key, item]) => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.onclick = () => useItem(key, item.name);

                // â–¼â–¼â–¼ [ìˆ˜ì •ëœ ë¡œì§] ì´ë¯¸ì§€ ì£¼ì†Œê°€ ìˆìœ¼ë©´ <img> íƒœê·¸ ì‚¬ìš© â–¼â–¼â–¼
                let displayHTML = `<div style="font-size: 24px;">${item.icon || 'ğŸ“¦'}</div>`;
                
                // ë§Œì•½ item.img ë˜ëŠ” item.iconì— URL(http)ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì´ë¯¸ì§€ë¡œ ì¶œë ¥
                const imgSource = item.img || item.icon;
                if (imgSource && (imgSource.startsWith('http') || imgSource.startsWith('https'))) {
                    displayHTML = `<img src="${imgSource}" style="width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; border-radius: 4px;">`;
                }
                // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

                div.innerHTML = `${displayHTML}<div style="font-size: 12px;">${item.name}</div>`;
                invList.appendChild(div);
            });
        });

        // [ê¶Œí•œ í™•ì¸ ë¡œì§]
        const isAdmin = localStorage.getItem("loginStatus") === "admin";

        // 1. ìˆ˜ì • ë²„íŠ¼: ë‚˜ ìì‹ ì´ê±°ë‚˜ ê´€ë¦¬ìë©´ ë³´ì„
        if (myID === targetID || isAdmin) {
            document.getElementById('editBtn').style.display = 'block'; 
            
            // 2. ì•Œë¦¼/ì†¡ê¸ˆ: ê´€ë¦¬ìë¼ë„ ë‚¨ì˜ ê²ƒì€ ë³¼ í•„ìš” ì—†ìœ¼ë¯€ë¡œ 'ë³¸ì¸'ì¼ ë•Œë§Œ ë³´ì„
            if (myID === targetID) {
                document.getElementById('notiBtn').style.display = 'block';
                document.getElementById('myInteractionSection').style.display = 'block';
                loadMyNotifications();
            } else {
                document.getElementById('notiBtn').style.display = 'none';
                document.getElementById('myInteractionSection').style.display = 'none';
            }
        } else {
            // ì•„ë¬´ ê¶Œí•œë„ ì—†ìœ¼ë©´ ë‹¤ ìˆ¨ê¹€
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('notiBtn').style.display = 'none';
            document.getElementById('myInteractionSection').style.display = 'none';
        }
    }

    function loadMyNotifications() {
        const listDiv = document.getElementById('notificationList');
        const notiBtn = document.getElementById('notiBtn');

        database.ref('users/' + myID + '/notifications').on('value', (snap) => {
            const notis = snap.val();
            listDiv.innerHTML = "";
            let unreadCount = 0;

            if (!notis) {
                listDiv.innerHTML = '<div style="padding:15px; color:#666; text-align:center;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                notiBtn.innerText = `ì•Œë¦¼ (0)`;
                notiBtn.classList.remove('new-alert');
                return;
            }

            const sortedKeys = Object.keys(notis).sort((a,b) => notis[b].timestamp - notis[a].timestamp);

            sortedKeys.forEach(key => {
                const n = notis[key];
                if (!n.read) unreadCount++;

                const div = document.createElement('div');
                div.className = `noti-item ${n.read ? '' : 'unread'}`;
                
                const time = new Date(n.timestamp).toLocaleDateString();
                div.innerHTML = `<span>${n.message}</span><span class="noti-time">${time}</span>`;
                listDiv.appendChild(div);
            });

            notiBtn.innerText = `ğŸ”” ì•Œë¦¼ (${unreadCount})`;
            if (unreadCount > 0) notiBtn.classList.add('new-alert');
            else notiBtn.classList.remove('new-alert');
        });
    }

    function toggleNotifications() {
        const listDiv = document.getElementById('notificationList');
        const isClosed = listDiv.style.display === "none" || listDiv.style.display === "";
        
        if (isClosed) {
            listDiv.style.display = "block"; 
            database.ref('users/' + myID + '/notifications').once('value', snap => {
                snap.forEach(child => {
                    if (child.val().read === false) child.ref.update({ read: true });
                });
            });
        } else {
            listDiv.style.display = "none";
        }
    }

    function openEditModal() {
        database.ref('users/' + targetID).once('value', (snapshot) => {
            const d = snapshot.val() || {};
            document.getElementById('editNickname').value = d.nickname || "";
            document.getElementById('editFullBody').value = d.fullBodyImg || "";
            document.getElementById('editHead').value = d.img || "";
            document.getElementById('editCatch').value = d.catchphrase || "";
            document.getElementById('editOne').value = d.oneLiner || "";
            document.getElementById('editAge').value = d.age || "";
            document.getElementById('editGender').value = d.gender || "";
            document.getElementById('editJob').value = d.job || "";
            document.getElementById('editHeight').value = d.height || "";
            document.getElementById('editWeight').value = d.weight || "";
            document.getElementById('editPersonality').value = d.personality || "";
            document.getElementById('editEtc').value = d.etc || "";
            document.getElementById('editItems').value = d.items || "";
            document.getElementById('editStr').value = d.stat_str || 0;
            document.getElementById('editAgi').value = d.stat_agi || 0;
            document.getElementById('editSoc').value = d.stat_soc || 0;
            document.getElementById('editLuk').value = d.stat_luk || 0;
            document.getElementById('editModal').style.display = 'block';
        });
    }

    function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

    function saveProfile() {
        const updates = {
            nickname: document.getElementById('editNickname').value,
            fullBodyImg: document.getElementById('editFullBody').value,
            img: document.getElementById('editHead').value,
            catchphrase: document.getElementById('editCatch').value,
            oneLiner: document.getElementById('editOne').value,
            age: document.getElementById('editAge').value,
            gender: document.getElementById('editGender').value,
            job: document.getElementById('editJob').value,
            height: document.getElementById('editHeight').value,
            weight: document.getElementById('editWeight').value,
            personality: document.getElementById('editPersonality').value,
            etc: document.getElementById('editEtc').value,
            items: document.getElementById('editItems').value,
            stat_str: Number(document.getElementById('editStr').value),
            stat_agi: Number(document.getElementById('editAgi').value),
            stat_soc: Number(document.getElementById('editSoc').value),
            stat_luk: Number(document.getElementById('editLuk').value)
        };
        database.ref('users/' + targetID).update(updates).then(() => { alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); closeEditModal(); });
    }

    // profile.html ë‚´ë¶€ì˜ script íƒœê·¸ ì•ˆìª½ í•¨ìˆ˜ êµì²´

    async function useItem(key, name) {
        // â–¼â–¼â–¼ [ìˆ˜ì •ëœ ë¡œì§] ì´ë¦„ì— íŠ¹ì • ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì²´í¬ â–¼â–¼â–¼
        const unusableKeywords = ["ë§Œì¥¬","í™•ì„±ê¸°", "ì‡ ì§€ë ›ëŒ€", "ì•¼êµ¬ë°°íŠ¸","ëª©ê²€","ê°€ì¡±ì‚¬ì§„","ìŠ¤ì¼€ì´íŠ¸ë³´ë“œ","ë°§ì¤„","ì‹ ë¶„ì¦","ì½˜ë”","ê°œì‚¬ë£Œ","íƒ„ì°½ ì—†ëŠ” ê¶Œì´","ìœ„ìŠ¤í‚¤","íœ´ëŒ€ì „í™”","ì—¬ìì•„ì´ ì¸í˜•","ìŒì‹ëª¨í˜•","MP3","ë…¸íŠ¸ì™€íœ","ì² ê°€ë°©","ë„ë¼","í¬ë„ë‹¹ ì‚¬íƒ•","ì‘ê¸‰í‚¤íŠ¸","ë¬¼ë³‘"];
        
        // some í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¦„ì— ê¸ˆì§€ í‚¤ì›Œë“œê°€ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        const isUnusable = unusableKeywords.some(keyword => name.includes(keyword));

        if (isUnusable) {
            alert(`[${name}] ì•„ì´í…œì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë©°, ì¸ë²¤í† ë¦¬ ë³´ê´€ìš©ì…ë‹ˆë‹¤.`);
            return; // ì‚¬ìš© ë¡œì§ ì¤‘ë‹¨
        }

        if (!confirm(`[${name}]ì„(ë¥¼) ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        const myRef = database.ref(`users/${myID}`);
        const snap = await myRef.once('value');
        const userData = snap.val();
        let updates = {};
        let usedMsg = ""; // ì•Œë¦¼ì°½ ë©”ì‹œì§€
        let tootMsg = ""; // ë§ˆìŠ¤í† ëˆ íˆ¿ ë©”ì‹œì§€
        let tootImg = null;

        // --- ì•„ì´í…œë³„ íš¨ê³¼ êµ¬í˜„ ---
        
        // [ìˆ˜ì • ì „] if (name === "ë§ˆë²•ì˜ì†Œë¼ê³ ë™")
// [ìˆ˜ì • í›„] ì´ë¦„ì— 'ì†Œë¼ê³ ë™'ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì‹¤í–‰ (ê³µë°± ì‹¤ìˆ˜ ë°©ì§€)
if (name.includes("ì†Œë¼ê³ ë™")) {
    const fortunes = [
        "ë™ë£Œì™€ ì˜ì‚¬ì†Œí†µì´ ì˜ ë˜ëŠ” ë‚ ì´ì—ìš”. ì˜ê²¬ ì°¨ë¥¼ ì¢í ìˆ˜ ìˆê² ì–´ìš”.", 
        "ëœ»ë°–ì˜ ì¬í™”ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”. ë°–ìœ¼ë¡œ ë‚˜ê°€ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?", 
        "ì¢‹ì€ ê±°ë˜ë¥¼ í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”. ì¤‘ê³ ê±°ë˜ë¥¼ í•´ ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?", 
        "ê¸°ë‹¤ë¦¬ë˜ ì†Œì‹ì´ ì°¾ì•„ì˜¬ ê²ƒ ê°™ì•„ìš”. ì•Œë¦¼ì„ í™•ì¸í•´ë´ìš”.", 
        "í•œê³„ê¹Œì§€ ë¬´ë¦¬í•  ì§€ë„ ëª°ë¼ìš”. ë™ë£Œì—ê²Œ ë„ì›€ì„ ìš”ì²­í•´ë´ìš”.", 
        "ìì‹ ê°ì„ ê°–ê³  ë‹¹ë‹¹í•˜ê²Œ ë§í•´ë´ìš”. ëª¨ë‘ê°€ ë‹¹ì‹ ì—ê²Œ ê·€ ê¸°ìš¸ì¼ ê±°ì˜ˆìš”.", 
        "ë§ˆìŒì˜ ì¥ë²½ì´ ë‚®ì•„ì§„ ì‹œê¸°ì˜ˆìš”. ì‚¬ê¸° ë‹¹í•˜ì§€ ì•Šë„ë¡ ì¡°ì‹¬í•˜ì„¸ìš”.", 
        "ì´ì•¼ê¸°ë¥¼ ëê¹Œì§€ ë“£ê³  ë‚˜ì„œ ì›€ì§ì—¬ìš”. ì„£ë¶€ë¥¸ ì¶”ì¸¡ì€ ì˜¤í•´ë¥¼ ë¶ˆëŸ¬ì¼ìœ¼ì¼œìš”.", 
        "ì¢‹ì€ ì ˆì•½ë²•ì„ ì°¾ì€ ê²ƒ ê°™ì•„ìš”. ìíŒê¸°ì˜ ë„ë°•ì„ ê·¸ë§Œë‘ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?", 
        "ì‹¤ë ¥ ë°œíœ˜ë¡œ ë§¹í™œì•½í•´ìš”. ì˜¤ëŠ˜ì´ë¼ë©´ ë‹¹ì‹ ë„ ì¢€ë¹„ ìŠ¬ë ˆì´ì–´!",
    ];
    const fortune = fortunes[Math.floor(Math.random() * fortunes.length)];
    usedMsg = `ì†Œë¼ê³ ë™ì˜ ê³„ì‹œ: "${fortune}"`;
    
    // userData.nicknameì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ targetIDë‚˜ "ìƒì¡´ì"ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
    const displayName = userData.nickname || targetID || "ìƒì¡´ì";
    tootMsg = `[ë§ˆë²•ì˜ ì†Œë¼ê³ ë™] ${displayName}ë‹˜ì˜ ìš´ì„¸: "${fortune}"`;

        } else if (name === "ì°¢ì–´ì§„ ì§€ë„") {
            // [ìˆ˜ì •] ì´ë¯¸ì§€ ëŒ€ì‹  í…ìŠ¤íŠ¸ ì •ë³´ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€ê²½
            const mapInfos = [
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ì‚¬íšŒê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. íŠ¹ì • ì¸µì— ì§ì„ ì´ ì”ëœ© ê·¸ì–´ì ¸ ìˆìœ¼ë©°, x í‘œì‹œê°€ ëª‡ ê°œ ë³´ì…ë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ê¸°ìˆ™ì‚¬ Aë™ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. íŠ¹ì • ì¸µì— ì§ì„ ì´ ì”ëœ© ê·¸ì–´ì ¸ ìˆìœ¼ë©°, x í‘œì‹œê°€ ëª‡ ê°œ ë³´ì…ë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ì˜ˆìˆ ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. íŠ¹ì • ì¸µì— ì§ì„ ì´ ì”ëœ© ê·¸ì–´ì ¸ ìˆìœ¼ë©°, x í‘œì‹œê°€ ëª‡ ê°œ ë³´ì…ë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ì²­ì†¡íšŒê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. íŠ¹ì • ì¸µì— ì§ì„ ì´ ì”ëœ© ê·¸ì–´ì ¸ ìˆìœ¼ë©°, x í‘œì‹œê°€ ëª‡ ê°œ ë³´ì…ë‹ˆë‹¤.", 
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ë©”ë””ì»¬ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. íŠ¹ì • ì¸µì— ì§ì„ ì´ ì”ëœ© ê·¸ì–´ì ¸ ìˆìœ¼ë©°, x í‘œì‹œê°€ ëª‡ ê°œ ë³´ì…ë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ë„ì„œê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. íŠ¹ì • ì¸µì— ì§ì„ ì´ ì”ëœ© ê·¸ì–´ì ¸ ìˆìœ¼ë©°, x í‘œì‹œê°€ ëª‡ ê°œ ë³´ì…ë‹ˆë‹¤.",

                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ì‚¬ë²”ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë™ê·¸ë¼ë¯¸ê°€ ì”ëœ© ê·¸ë ¤ì ¸ ìˆìœ¼ë‚˜, ì–´ì§¸ ë‹¤ê¸‰í•˜ê²Œ ì“°ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ë³¸ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë™ê·¸ë¼ë¯¸ê°€ ì”ëœ© ê·¸ë ¤ì ¸ ìˆìœ¼ë‚˜, ì–´ì§¸ ë‹¤ê¸‰í•˜ê²Œ ì“°ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ì¸ë¬¸ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë™ê·¸ë¼ë¯¸ê°€ ì”ëœ© ê·¸ë ¤ì ¸ ìˆìœ¼ë‚˜, ì–´ì§¸ ë‹¤ê¸‰í•˜ê²Œ ì“°ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ìì—°ê³¼í•™ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë™ê·¸ë¼ë¯¸ê°€ ì”ëœ© ê·¸ë ¤ì ¸ ìˆìœ¼ë‚˜, ì–´ì§¸ ë‹¤ê¸‰í•˜ê²Œ ì“°ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ê³µí•™ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë™ê·¸ë¼ë¯¸ê°€ ì”ëœ© ê·¸ë ¤ì ¸ ìˆìœ¼ë‚˜, ì–´ì§¸ ë‹¤ê¸‰í•˜ê²Œ ì“°ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
                

                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ì¸ë¬¸ê´€ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. xê°€ ê°€ë“ ê·¸ë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ìœ„í—˜í•´ ë³´ì´ë„¤ìš”.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ìš´ë™ì¥ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. xê°€ ê°€ë“ ê·¸ë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ìœ„í—˜í•´ ë³´ì´ë„¤ìš”.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ê³µì›ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. xê°€ ê°€ë“ ê·¸ë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ìœ„í—˜í•´ ë³´ì´ë„¤ìš”.",
                "ì§€ë„ë¥¼ ì‚´í´ë³´ë‹ˆâ‹¯â‹¯ ê¸°ìˆ™ì‚¬Bë™ì— ëŒ€í•´ ì ì–´ë‘” ê²ƒ ê°™ìŠµë‹ˆë‹¤. xê°€ ê°€ë“ ê·¸ë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ìœ„í—˜í•´ ë³´ì´ë„¤ìš”.",

                 
            ];
            // ëœë¤ìœ¼ë¡œ í…ìŠ¤íŠ¸ í•˜ë‚˜ ì„ íƒ
            const selectedInfo = mapInfos[Math.floor(Math.random() * mapInfos.length)];
            
            usedMsg = `[ì§€ë„ í™•ì¸] ${selectedInfo}`;
            tootMsg = `[ì§€ë„] ${userData.nickname}ë‹˜ì´ ì§€ë„ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.\në‚´ìš©: "${selectedInfo}"`;
            
            // ì´ë¯¸ì§€ ë³€ìˆ˜ëŠ” ë¹„ì›Œë‘¡ë‹ˆë‹¤.
            tootImg = null;
            
            // [ì‚­ì œ] window.open(mapImg, '_blank');  <- ìƒˆ ì°½ ê¸°ëŠ¥ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.

            // í™”ë©´ì— ì•Œë¦¼ë§Œ ë„ì›Œì¤ë‹ˆë‹¤.
            alert(usedMsg);

        } else if (name === "ì†Œì£¼") {
            const stats = ['stat_str', 'stat_agi', 'stat_soc', 'stat_luk'];
            const targetStat = stats[Math.floor(Math.random() * stats.length)];
            const statName = { 'stat_str':'ê·¼ë ¥', 'stat_agi':'ë¯¼ì²©', 'stat_soc':'ëŒ€ì¸ê´€ê³„', 'stat_luk':'í–‰ìš´' }[targetStat];
            
            const currentVal = userData[targetStat] || 0;
            updates[targetStat] = Math.min(10, currentVal + 1); // ìµœëŒ€ 10ê¹Œì§€
            
            usedMsg = `ìº¬~! ì·¨í•œë‹¤. [${statName}] ìŠ¤íƒ¯ì´ 1 ì˜¬ëìŠµë‹ˆë‹¤.`;
            tootMsg = `[ì†Œì£¼] ${userData.nickname}ë‹˜ì´ ì†Œì£¼ë¥¼ ë§ˆì‹œê³  ${statName}ì´(ê°€) ê°•í•´ì¡ŒìŠµë‹ˆë‹¤!`;

        } else if (name === "ì—ë„ˆì§€ë°”") {
            const curHp = userData.hp || 0;
            updates['hp'] = Math.min(100, curHp + 15);
            usedMsg = `ëƒ ëƒ . ì²´ë ¥ì´ 15 íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.`;
            tootMsg = `[ì—ë„ˆì§€ë°”] ${userData.nickname}ë‹˜ì´ ì—ë„ˆì§€ë¥¼ ì¶©ì „í–ˆìŠµë‹ˆë‹¤. (HP +15)`;

        } else if (name === "ë„ì‹œë½") {
            const curHp = userData.hp || 0;
            updates['hp'] = Math.min(100, curHp + 30);
            usedMsg = `ì˜ ë¨¹ì—ˆìŠµë‹ˆë‹¤! ì²´ë ¥ì´ 30 íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.`;
            tootMsg = `[ë„ì‹œë½] ${userData.nickname}ë‹˜ì´ ë“ ë“ í•˜ê²Œ ì‹ì‚¬í–ˆìŠµë‹ˆë‹¤. (HP +30)`;

        } else {
            // ê¸°íƒ€ ì•„ì´í…œ (ê¸°ê³„ê³ ì¥, ë°•ìŠ¤ ë“±ì—ì„œ ë‚˜ì˜¨ ì•„ì´í…œ)
            // íŠ¹ë³„í•œ íš¨ê³¼ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì‚¬ìš© ì²˜ë¦¬
            usedMsg = `[${name}]ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`;
            tootMsg = `${userData.nickname}ë‹˜ì´ [${name}]ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`;
        }

        // 2. ì•„ì´í…œ ì‚­ì œ ë° ì—…ë°ì´íŠ¸ ì ìš©
        await database.ref(`users/${myID}/inventory/${key}`).remove();
        if (Object.keys(updates).length > 0) {
            await database.ref(`users/${myID}`).update(updates);
        }

        // 3. ì•Œë¦¼ ë° ë´‡ ì „ì†¡
        alert(usedMsg);
        if (typeof postToMastodon === "function") {
            postToMastodon(tootMsg, tootImg);
        }
        
        // (ì„ íƒ) í™”ë©´ ê°±ì‹ ì„ ìœ„í•´ ë¦¬ë¡œë“œí•˜ê±°ë‚˜, on listenerê°€ ìë™ ì²˜ë¦¬í•¨
    }

    let currentAction = ""; 
    function openUserSelectModal(action) {
        currentAction = action;
        const container = document.getElementById('userListContainer');
        container.innerHTML = '<p style="text-align:center; color:#888;">ìœ ì € ëª©ë¡ ë¡œë”© ì¤‘...</p>';
        document.getElementById('userSelectModal').style.display = 'block';

        database.ref('users').once('value', (snapshot) => {
            container.innerHTML = '';
            snapshot.forEach((child) => {
                const userData = child.val();
                const userId = child.key;
                if (userId === myID) return;

                const div = document.createElement('div');
                div.className = "user-select-item";
                div.onclick = () => processTransfer(userId, userData.nickname || userId);

                div.innerHTML = `
                    <img src="${userData.img || 'https://i.imgur.com/3SPL075.png'}" style="width:30px; height:30px; border-radius:50%; border:1px solid var(--accent-color);">
                    <span>${userData.nickname || userId}</span>
                `;
                container.appendChild(div);
            });
        });
    }

    function closeUserModal() { document.getElementById('userSelectModal').style.display = 'none'; }

    async function processTransfer(targetId, targetName) {
        closeUserModal();
        const senderName = document.getElementById('pName').innerText; 

        if (currentAction === 'money') {
            const amount = parseInt(prompt(`${targetName} ë‹˜ì—ê²Œ ì†¡ê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”:`));
            if (isNaN(amount) || amount <= 0) return;

            const mySnap = await database.ref('users/' + myID).once('value');
            const myMoney = mySnap.val().money || 0;

            if (myMoney < amount) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

            if (confirm(`${targetName} ë‹˜ì—ê²Œ ${amount}Gë¥¼ ë³´ë‚¼ê¹Œìš”?`)) {
                await database.ref('users/' + myID).update({ money: myMoney - amount });
                const targetSnap = await database.ref('users/' + targetId).once('value');
                const targetMoney = targetSnap.val().money || 0;
                await database.ref('users/' + targetId).update({ money: targetMoney + amount });
                
                // â˜… [ì¶”ê°€] ë§ˆìŠ¤í† ëˆ ì†¡ê¸ˆ ì•Œë¦¼
                if (myID !== '13reaking_news' && typeof postToMastodon === "function") {
                postToMastodon(`ğŸ’¸ [ì†¡ê¸ˆ] @${targetId}ë‹˜, ${myNick}ë‹˜ì´ [${amount}G]ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!`);
}

                sendNotification(targetId, `${senderName}ë‹˜ì´ ${amount}Gë¥¼ ì†¡ê¸ˆí–ˆìŠµë‹ˆë‹¤.`);
                alert(`${targetName} ë‹˜ì—ê²Œ ì†¡ê¸ˆ ì™„ë£Œ!`);
            }
        } else {
            // --- ì•„ì´í…œ ì„ ë¬¼ ì²˜ë¦¬ ì„¹ì…˜ ---
            const myInvSnap = await database.ref('users/' + myID + '/inventory').once('value');
            const myInv = myInvSnap.val();
            if (!myInv) return alert("ì„ ë¬¼í•  ì•„ì´í…œì´ ê°€ë°©ì— ì—†ìŠµë‹ˆë‹¤.");

            const items = Object.entries(myInv);
            let msg = `${targetName} ë‹˜ì—ê²Œ ë³´ë‚¼ ì•„ì´í…œ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n`;
            items.forEach(([key, val], i) => msg += `${i + 1}. ${val.name}\n`);

            const choice = parseInt(prompt(msg)) - 1;
            if (isNaN(choice) || !items[choice]) return;

            const [itemKey, itemData] = items[choice];

            if (confirm(`${targetName} ë‹˜ì—ê²Œ [${itemData.name}]ì„ ì„ ë¬¼í• ê¹Œìš”?`)) {
                await database.ref(`users/${myID}/inventory/${itemKey}`).remove();
                await database.ref(`users/${targetId}/inventory`).push(itemData);
                
                // â˜… [ì¶”ê°€] ë§ˆìŠ¤í† ëˆ ì•„ì´í…œ ì„ ë¬¼ ì•Œë¦¼
                if (myID !== '13reaking_news' && typeof postToMastodon === "function") {
                postToMastodon(`ğŸ [ì„ ë¬¼] @${targetId}ë‹˜, ${myNick}ë‹˜ì´ [${itemData.name}]ì„(ë¥¼) ë³´ëƒˆìŠµë‹ˆë‹¤!`);
}

                sendNotification(targetId, `${senderName}ë‹˜ì´ [${itemData.name}]ì„ ì„ ë¬¼í–ˆìŠµë‹ˆë‹¤.`);
                alert(`[${itemData.name}] ì„ ë¬¼ì„ ì „ë‹¬í–ˆìŠµë‹ˆë‹¤!`);
            }
        }
    }

    function sendNotification(targetId, message) {
        database.ref('users/' + targetId + '/notifications').push({
            message: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            read: false
        });
    }

    function logout() { localStorage.clear(); location.href = "index.html"; }
    window.onload = loadProfile;

    // [NEW] ì„¹ì…˜ ì ‘ê³  í¼ì¹˜ê¸° í•¨ìˆ˜
    function toggleSection(elementId, header) {
        const content = document.getElementById(elementId);
        if (!content) return;

        // 1. ë‚´ìš©ë¬¼ì˜ ë³´ì„/ìˆ¨ê¹€ í† ê¸€ (collapsed í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°)
        content.classList.toggle('collapsed');
        
        // 2. ì œëª©ì˜ í™”ì‚´í‘œ íšŒì „ í† ê¸€ (active í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°)
        header.classList.toggle('active');
    }

// [ì¶”ê°€] ì‚¬ì´ë“œë°” ì ‘ê³  í¼ì¹˜ê¸° ê¸°ëŠ¥
    function toggleSidebar() {
        const panel = document.querySelector('.info-section');
        const btn = document.querySelector('.toggle-btn');
        
        panel.classList.toggle('closed');
        
        if (panel.classList.contains('closed')) {
            btn.innerText = "<"; // ë‹«í˜”ìœ¼ë‹ˆ 'ì—¬ëŠ”' í™”ì‚´í‘œë¡œ ë³€ê²½
        } else {
            btn.innerText = ">"; // ì—´ë ¸ìœ¼ë‹ˆ 'ë‹«ëŠ”' í™”ì‚´í‘œë¡œ ë³€ê²½
        }
    }

</script>
<script src="script.js"></script>
</body>
</html>