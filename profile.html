<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒì¡´ì í”„ë¡œí•„</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --accent-color: #ab0000; --bg-dark: #111; --panel-bg: #1a1a1a; --text-gray: #ccc; --nav-font: 'SchoolSafeBoardMarker', sans-serif; }
        
        body { background-color: var(--bg-dark); color: white; margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; overflow-x: hidden; }

        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 0 50px; background: rgba(0, 0, 0, 0.9); border-bottom: 1px solid var(--accent-color); height: 60px; position: fixed; top: 0; width: 100%; z-index: 1000; box-sizing: border-box; font-family: var(--nav-font); }
        .nav-links { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
        .nav-links a { color: white; text-decoration: none; font-size: 1.1rem; }

        .profile-wrapper { display: flex; width: 100vw; height: calc(100vh - 60px); margin-top: 60px; }
        .portrait-section { width: 40%; height: 100%; background: #000; display: flex; align-items: flex-start; justify-content: center; border-right: 2px solid var(--accent-color); overflow: hidden; }
        .portrait-section img { width: auto; height: 100%; object-fit: contain; }
        .info-section { width: 60%; height: 100%; overflow-y: auto; padding: 60px; box-sizing: border-box; background: #151515; position: relative; }

        #editBtn { position: absolute; top: 20px; right: 20px; background: var(--accent-color); color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; display: none; z-index: 10; }

        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; border-top: 2px solid var(--accent-color); }
        .info-table td { padding: 15px; border-bottom: 1px solid #333; }
        .label { color: var(--accent-color); font-weight: bold; width: 80px; font-size: 0.9rem; }
        .value { color: #eee; }
        .head-img { width: 120px; height: 120px; border-radius: 10px; border: 2px solid var(--accent-color); object-fit: cover; background: #222; }
        .section-title { font-size: 1.2rem; color: var(--accent-color); border-bottom: 1px solid #444; margin: 30px 0 15px; padding-bottom: 5px; font-family: var(--nav-font); }

        .stat-bars { display: flex; gap: 4px; }
        .bar { width: 14px; height: 16px; background: #333; border-radius: 2px; }
        .bar.fill { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .inv-item { background: #222; padding: 15px 10px; border-radius: 8px; text-align: center; border: 1px solid #333; transition: 0.3s; cursor: pointer; }
        .inv-item:hover { border-color: var(--accent-color); background: #2a2a2a; }

        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto; padding: 50px 0; }
        .modal-content { width: 90%; max-width: 850px; margin: auto; background: #1a1a1a; padding: 40px; border-radius: 15px; border: 1px solid var(--accent-color); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .form-group label { color: var(--accent-color); font-weight: bold; font-size: 0.85rem; }
        .form-group input, .form-group textarea { padding: 10px; background: #0a0a0a; border: 1px solid #333; color: white; border-radius: 5px; }
        
        #myInteractionSection button:hover { filter: brightness(1.3); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(171, 0, 0, 0.4); }

        /* ì•Œë¦¼ ë²„íŠ¼ ë° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .noti-btn {
            position: absolute; top: 20px; right: 140px; 
            background: #333; color: #ddd; border: 1px solid #555;
            padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;
            display: none; z-index: 10;
        }
        .noti-btn:hover { background: #444; color: white; }
        .noti-btn.new-alert { border-color: #ff0000; color: #ffcccc; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        #notificationList {
            display: none; margin-bottom: 20px; background: #111; border: 1px solid #444; border-radius: 8px; max-height: 300px; overflow-y: auto; box-shadow: inset 0 0 20px #000;
        }
        .noti-item { padding: 12px 15px; border-bottom: 1px solid #333; font-size: 0.9rem; color: #aaa; display: flex; justify-content: space-between; }
        .noti-item.unread { background: rgba(171, 0, 0, 0.1); color: #fff; border-left: 3px solid var(--accent-color); }
        .noti-time { font-size: 0.75rem; color: #666; margin-left: 10px; }
    
    /* --- í”„ë¡œí•„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ --- */

/* ì œëª©ì„ í´ë¦­ ê°€ëŠ¥í•œ ë²„íŠ¼ì²˜ëŸ¼ ë³´ì´ê²Œ ë³€ê²½ */
.section-title {
    cursor: pointer;
    display: flex;
    justify-content: space-between; /* í™”ì‚´í‘œë¥¼ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ */
    align-items: center;
    user-select: none; /* í…ìŠ¤íŠ¸ ë“œë˜ê·¸ ë°©ì§€ */
    transition: color 0.3s;
}

.section-title:hover {
    color: #ff4444; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë°ì€ ë¹¨ê°• */
}

/* í™”ì‚´í‘œ ì•„ì´ì½˜ (ê¸°ë³¸: ì•„ë˜ìª½) */
.section-title::after {
    content: 'â–¼';
    font-size: 0.8rem;
    color: #666;
    transition: transform 0.3s;
}

/* í¼ì³ì§„ ìƒíƒœ(active í´ë˜ìŠ¤)ì¼ ë•Œ í™”ì‚´í‘œ íšŒì „ */
.section-title.active::after {
    transform: rotate(180deg); /* ìœ„ìª½ì„ í–¥í•˜ê²Œ */
    color: #ab0000;
}

/* ë‚´ìš©ì„ ìˆ¨ê¸°ëŠ” í´ë˜ìŠ¤ */
.collapsed {
    display: none !important;
}

    </style>
</head>
<body>

<nav class="navbar">
    <div class="logo">
        OUT BREAK 
        <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;"></span>
    </div>
    <ul class="nav-links">
        <li><a href="main.html">í™ˆ</a></li>
        <li><a href="sub.html">ìƒì¡´ìëª©ë¡</a></li>
        <li><a href="board.html">ììœ ê²Œì‹œíŒ</a></li>
        <li><a href="trade.html">ì¤‘ê³ ê±°ë˜ê²Œì‹œíŒ</a></li>
        <li><a href="quest.html">ì˜ë¢°ê²Œì‹œíŒ</a></li>
        <li><a href="game.html">ê³ ì¥ë‚œìíŒê¸°</a></li>
        <li><a href="vending.html">ì‹ í˜•ìíŒê¸°</a></li>
        <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
    </ul>
    </nav>

<div class="profile-wrapper">
    <div class="portrait-section">
        <img id="pFullBody" src="" alt="ì „ì‹  ì´ë¯¸ì§€">
    </div>

    <div class="info-section">
        <button id="notiBtn" class="noti-btn" onclick="toggleNotifications()">ğŸ”” ì•Œë¦¼</button>
        <button id="editBtn" onclick="openEditModal()">ğŸ“ ì •ë³´ ìˆ˜ì •</button>
        
        <div id="notificationList"></div>

        <div id="pCatchphrase" style="color: var(--accent-color); font-size: 1.2rem; margin-bottom: 5px; opacity: 0.8;"></div>
        <div id="pOneLiner" style="font-size: 2.8rem; font-weight: bold; margin-bottom: 35px; line-height: 1.2;"></div>

        <table class="info-table">
            <tr>
                <td rowspan="4" style="width: 140px; text-align: center;"><img id="pHeadImg" class="head-img" src="" alt="ë‘ìƒ"></td>
                <td class="label">ì´ë¦„</td><td class="value" id="pName"></td>
                <td class="label">ë‚˜ì´</td><td class="value" id="pAge"></td>
            </tr>
            <tr>
                <td class="label">ì„±ë³„</td><td class="value" id="pGender"></td>
                <td class="label">ì§ì—…</td><td class="value" id="pJob"></td>
            </tr>
            <tr>
                <td class="label">ì‹ ì¥/ì²´ì¤‘</td><td class="value" id="pBody"></td>
                <td class="label">ì†Œì§€ê¸ˆ</td><td class="value" style="color: gold;"><span id="pMoney">0</span> G</td>
            </tr>
            <tr>
                <td class="label">ì²´ë ¥</td><td class="value" style="color: #ff4444;"><span id="pHP">100</span> / 100</td>
                <td class="label">ìƒíƒœ</td><td class="value" id="pInfection">-</td>
            </tr>
        </table>

        <div class="section-title active" onclick="toggleSection('pPersonality', this)">PERSONALITY</div>
        <div id="pPersonality" style="white-space: pre-wrap; color: #ccc; margin-bottom: 40px;"></div>

        <div class="section-title active" onclick="toggleSection('statsWrapper', this)">STATISTICS</div>
        
        <div id="statsWrapper" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px;">
                <span>ê·¼ë ¥</span> <div class="stat-bars" id="stat-str"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px;">
                <span>ë¯¼ì²©</span> <div class="stat-bars" id="stat-agi"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px;">
                <span>ëŒ€ì¸ê´€ê³„</span> <div class="stat-bars" id="stat-soc"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px;">
                <span>í–‰ìš´</span> <div class="stat-bars" id="stat-luk"></div>
            </div>
        </div>
        
        <div class="section-title active" onclick="toggleSection('pEtc', this)">ETC</div>
        <div id="pEtc" style="white-space: pre-wrap; color: #ccc; margin-bottom: 40px;"></div>

        <div class="section-title active" onclick="toggleSection('pItems', this)">ITEMS (ì„¤ì •)</div>
        <div id="pItems" style="white-space: pre-wrap; color: #ccc; margin-bottom: 40px;"></div>

        <div class="section-title active" onclick="toggleSection('inventoryList', this)">INVENTORY (ê°€ë°©)</div>
        <div id="inventoryList" class="inventory-grid"></div>
        
        <div id="myInteractionSection" style="display: none; margin-top: 30px; border-top: 1px solid var(--accent-color); padding-top: 20px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="openUserSelectModal('money')" style="flex: 1; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s;">ğŸ’° ëˆ ì†¡ê¸ˆí•˜ê¸°</button>
                <button onclick="openUserSelectModal('item')" style="flex: 1; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s;">ğŸ ì•„ì´í…œ ì„ ë¬¼í•˜ê¸°</button>
            </div>
        </div>

        <div id="userSelectModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3000;">
            <div style="width:90%; max-width:400px; margin:100px auto; background:#1a1a1a; border:1px solid var(--accent-color); padding:20px; border-radius:10px;">
                <h3 id="modalTitle" style="color:var(--accent-color); margin-top:0;">ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</h3>
                <div id="userListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
                <button onclick="closeUserModal()" style="width:100%; padding:10px; background:#444; color:white; border:none; border-radius:5px; cursor:pointer;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h2 style="color: var(--accent-color); margin-top: 0;">ìºë¦­í„° ë°ì´í„° ìˆ˜ì •</h2>
        <div class="form-row">
            <div class="form-group"><label>ì „ì‹  ì´ë¯¸ì§€ (URL)</label><input type="text" id="editFullBody"></div>
            <div class="form-group"><label>ë‘ìƒ ì´ë¯¸ì§€ (URL)</label><input type="text" id="editHead"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>ì´ë¦„</label><input type="text" id="editNickname"></div>
        </div>  
        <div class="form-row">
            <div class="form-group"><label>ìºì¹˜í”„ë ˆì´ì¦ˆ</label><input type="text" id="editCatch"></div>
            <div class="form-group"><label>í•œë§ˆë””</label><input type="text" id="editOne"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>ë‚˜ì´</label><input type="text" id="editAge"></div>
            <div class="form-group"><label>ì„±ë³„</label><input type="text" id="editGender"></div>
            <div class="form-group"><label>ì§ì—…</label><input type="text" id="editJob"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>í‚¤ (cm)</label><input type="text" id="editHeight"></div>
            <div class="form-group"><label>ëª¸ë¬´ê²Œ (kg)</label><input type="text" id="editWeight"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>ê·¼ë ¥</label><input type="number" id="editStr" min="0" max="10"></div>
            <div class="form-group"><label>ë¯¼ì²©</label><input type="number" id="editAgi" min="0" max="10"></div>
            <div class="form-group"><label>ëŒ€ì¸ê´€ê³„</label><input type="number" id="editSoc" min="0" max="10"></div>
            <div class="form-group"><label>í–‰ìš´</label><input type="number" id="editLuk" min="0" max="10"></div>
        </div>
        <div class="form-group"><label>ì„±ê²©</label><textarea id="editPersonality"></textarea></div>
        <div class="form-group"><label>ê¸°íƒ€</label><textarea id="editEtc"></textarea></div>
        <div class="form-group"><label>ì†Œì§€í’ˆ</label><textarea id="editItems"></textarea></div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button onclick="saveProfile()" style="flex: 2; padding: 15px; background: var(--accent-color); color: white; border: none; cursor: pointer;">ì €ì¥</button>
            <button onclick="closeEditModal()" style="flex: 1; padding: 15px; background: #444; color: white; border: none; cursor: pointer;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
        authDomain: "cheongjuca.firebaseapp.com",
        databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
        projectId: "cheongjuca",
        storageBucket: "cheongjuca.firebasestorage.app",
        messagingSenderId: "455437421321",
        appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const params = new URLSearchParams(window.location.search);
    const targetID = params.get('name');
    const myID = localStorage.getItem("loginID") || localStorage.getItem("userNick");

    function createStatBars(containerId, value) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            const bar = document.createElement('div');
            bar.className = i <= value ? 'bar fill' : 'bar';
            container.appendChild(bar);
        }
    }

    function loadProfile() {
        if (!targetID) return;
        database.ref('users/' + targetID).on('value', (snapshot) => {
            const d = snapshot.val() || {};
            document.getElementById('pName').innerText = d.nickname || targetID;
            document.getElementById('pCatchphrase').innerText = d.catchphrase || "";
            document.getElementById('pOneLiner').innerText = d.oneLiner || "";
            document.getElementById('pAge').innerText = d.age || "-";
            document.getElementById('pGender').innerText = d.gender || "-";
            document.getElementById('pJob').innerText = d.job || "-";
            document.getElementById('pBody').innerText = `${d.height || '-'}cm / ${d.weight || '-'}kg`;
            document.getElementById('pMoney').innerText = (d.money || 0).toLocaleString();
            document.getElementById('pHP').innerText = d.hp || 0;
            document.getElementById('pPersonality').innerText = d.personality || "";
            document.getElementById('pEtc').innerText = d.etc || "";
            document.getElementById('pItems').innerText = d.items || "ì†Œì§€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.";
            
            const infDisplay = document.getElementById('pInfection');
            if (d.infection === "ì¢€ë¹„") { infDisplay.innerText = "ğŸ§Ÿ ì¢€ë¹„í™”"; infDisplay.style.color = "#ff4444"; }
            else if (d.infection > 0) { infDisplay.innerText = "ğŸ§ª ê°ì—¼ " + d.infection + "ë‹¨ê³„"; infDisplay.style.color = "#00ff00"; }
            else { infDisplay.innerText = "ì •ìƒ"; infDisplay.style.color = "#888"; }

            if(d.fullBodyImg) document.getElementById('pFullBody').src = d.fullBodyImg;
            if(d.img) document.getElementById('pHeadImg').src = d.img;

            createStatBars('stat-str', d.stat_str || 0);
            createStatBars('stat-agi', d.stat_agi || 0);
            createStatBars('stat-soc', d.stat_soc || 0);
            createStatBars('stat-luk', d.stat_luk || 0);

            const invList = document.getElementById('inventoryList');
            invList.innerHTML = '';
            const invData = d.inventory || {};
            Object.entries(invData).forEach(([key, item]) => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.onclick = () => useItem(key, item.name);
                div.innerHTML = `<div style="font-size: 24px;">${item.icon || 'ğŸ“¦'}</div><div style="font-size: 12px;">${item.name}</div>`;
                invList.appendChild(div);
            });
        });

        // [ê¶Œí•œ í™•ì¸ ë¡œì§]
        const isAdmin = localStorage.getItem("loginStatus") === "admin";

        // 1. ìˆ˜ì • ë²„íŠ¼: ë‚˜ ìì‹ ì´ê±°ë‚˜ ê´€ë¦¬ìë©´ ë³´ì„
        if (myID === targetID || isAdmin) {
            document.getElementById('editBtn').style.display = 'block'; 
            
            // 2. ì•Œë¦¼/ì†¡ê¸ˆ: ê´€ë¦¬ìë¼ë„ ë‚¨ì˜ ê²ƒì€ ë³¼ í•„ìš” ì—†ìœ¼ë¯€ë¡œ 'ë³¸ì¸'ì¼ ë•Œë§Œ ë³´ì„
            if (myID === targetID) {
                document.getElementById('notiBtn').style.display = 'block';
                document.getElementById('myInteractionSection').style.display = 'block';
                loadMyNotifications();
            } else {
                document.getElementById('notiBtn').style.display = 'none';
                document.getElementById('myInteractionSection').style.display = 'none';
            }
        } else {
            // ì•„ë¬´ ê¶Œí•œë„ ì—†ìœ¼ë©´ ë‹¤ ìˆ¨ê¹€
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('notiBtn').style.display = 'none';
            document.getElementById('myInteractionSection').style.display = 'none';
        }
    }

    function loadMyNotifications() {
        const listDiv = document.getElementById('notificationList');
        const notiBtn = document.getElementById('notiBtn');

        database.ref('users/' + myID + '/notifications').on('value', (snap) => {
            const notis = snap.val();
            listDiv.innerHTML = "";
            let unreadCount = 0;

            if (!notis) {
                listDiv.innerHTML = '<div style="padding:15px; color:#666; text-align:center;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                notiBtn.innerText = `ğŸ”” ì•Œë¦¼ (0)`;
                notiBtn.classList.remove('new-alert');
                return;
            }

            const sortedKeys = Object.keys(notis).sort((a,b) => notis[b].timestamp - notis[a].timestamp);

            sortedKeys.forEach(key => {
                const n = notis[key];
                if (!n.read) unreadCount++;

                const div = document.createElement('div');
                div.className = `noti-item ${n.read ? '' : 'unread'}`;
                
                const time = new Date(n.timestamp).toLocaleDateString();
                div.innerHTML = `<span>${n.message}</span><span class="noti-time">${time}</span>`;
                listDiv.appendChild(div);
            });

            notiBtn.innerText = `ğŸ”” ì•Œë¦¼ (${unreadCount})`;
            if (unreadCount > 0) notiBtn.classList.add('new-alert');
            else notiBtn.classList.remove('new-alert');
        });
    }

    function toggleNotifications() {
        const listDiv = document.getElementById('notificationList');
        const isClosed = listDiv.style.display === "none" || listDiv.style.display === "";
        
        if (isClosed) {
            listDiv.style.display = "block"; 
            database.ref('users/' + myID + '/notifications').once('value', snap => {
                snap.forEach(child => {
                    if (child.val().read === false) child.ref.update({ read: true });
                });
            });
        } else {
            listDiv.style.display = "none";
        }
    }

    function openEditModal() {
        database.ref('users/' + targetID).once('value', (snapshot) => {
            const d = snapshot.val() || {};
            document.getElementById('editNickname').value = d.nickname || "";
            document.getElementById('editFullBody').value = d.fullBodyImg || "";
            document.getElementById('editHead').value = d.img || "";
            document.getElementById('editCatch').value = d.catchphrase || "";
            document.getElementById('editOne').value = d.oneLiner || "";
            document.getElementById('editAge').value = d.age || "";
            document.getElementById('editGender').value = d.gender || "";
            document.getElementById('editJob').value = d.job || "";
            document.getElementById('editHeight').value = d.height || "";
            document.getElementById('editWeight').value = d.weight || "";
            document.getElementById('editPersonality').value = d.personality || "";
            document.getElementById('editEtc').value = d.etc || "";
            document.getElementById('editItems').value = d.items || "";
            document.getElementById('editStr').value = d.stat_str || 0;
            document.getElementById('editAgi').value = d.stat_agi || 0;
            document.getElementById('editSoc').value = d.stat_soc || 0;
            document.getElementById('editLuk').value = d.stat_luk || 0;
            document.getElementById('editModal').style.display = 'block';
        });
    }

    function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

    function saveProfile() {
        const updates = {
            nickname: document.getElementById('editNickname').value,
            fullBodyImg: document.getElementById('editFullBody').value,
            img: document.getElementById('editHead').value,
            catchphrase: document.getElementById('editCatch').value,
            oneLiner: document.getElementById('editOne').value,
            age: document.getElementById('editAge').value,
            gender: document.getElementById('editGender').value,
            job: document.getElementById('editJob').value,
            height: document.getElementById('editHeight').value,
            weight: document.getElementById('editWeight').value,
            personality: document.getElementById('editPersonality').value,
            etc: document.getElementById('editEtc').value,
            items: document.getElementById('editItems').value,
            stat_str: Number(document.getElementById('editStr').value),
            stat_agi: Number(document.getElementById('editAgi').value),
            stat_soc: Number(document.getElementById('editSoc').value),
            stat_luk: Number(document.getElementById('editLuk').value)
        };
        database.ref('users/' + targetID).update(updates).then(() => { alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); closeEditModal(); });
    }

    function useItem(key, name) {
        if (!confirm(`[${name}]ì„(ë¥¼) ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const ITEM_EFFECTS = { "ì´ˆì½”ìš°ìœ ": { hp: 20 }, "ì—ë„ˆì§€ë“œë§í¬": { hp: 10 }, "êµ¬ê¸‰ìƒì": { hp: 50 } };
        database.ref('users/' + targetID).once('value', (snapshot) => {
            const d = snapshot.val();
            let updates = {};
            if (ITEM_EFFECTS[name]) {
                updates['hp'] = Math.min(100, (d.hp || 0) + ITEM_EFFECTS[name].hp);
                alert(`ì²´ë ¥ì´ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            database.ref(`users/${targetID}/inventory/${key}`).remove().then(() => {
                if (updates.hp !== undefined) database.ref(`users/${targetID}`).update(updates);
            });
        });
    }

    let currentAction = ""; 
    function openUserSelectModal(action) {
        currentAction = action;
        const container = document.getElementById('userListContainer');
        container.innerHTML = '<p style="text-align:center; color:#888;">ìœ ì € ëª©ë¡ ë¡œë”© ì¤‘...</p>';
        document.getElementById('userSelectModal').style.display = 'block';

        database.ref('users').once('value', (snapshot) => {
            container.innerHTML = '';
            snapshot.forEach((child) => {
                const userData = child.val();
                const userId = child.key;
                if (userId === myID) return;

                const div = document.createElement('div');
                div.className = "user-select-item";
                div.onclick = () => processTransfer(userId, userData.nickname || userId);

                div.innerHTML = `
                    <img src="${userData.img || 'https://i.imgur.com/3SPL075.png'}" style="width:30px; height:30px; border-radius:50%; border:1px solid var(--accent-color);">
                    <span>${userData.nickname || userId}</span>
                `;
                container.appendChild(div);
            });
        });
    }

    function closeUserModal() { document.getElementById('userSelectModal').style.display = 'none'; }

    async function processTransfer(targetId, targetName) {
        closeUserModal();
        const senderName = document.getElementById('pName').innerText; 

        if (currentAction === 'money') {
            const amount = parseInt(prompt(`${targetName} ë‹˜ì—ê²Œ ì†¡ê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”:`));
            if (isNaN(amount) || amount <= 0) return;

            const mySnap = await database.ref('users/' + myID).once('value');
            const myMoney = mySnap.val().money || 0;

            if (myMoney < amount) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

            if (confirm(`${targetName} ë‹˜ì—ê²Œ ${amount}Gë¥¼ ë³´ë‚¼ê¹Œìš”?`)) {
                await database.ref('users/' + myID).update({ money: myMoney - amount });
                const targetSnap = await database.ref('users/' + targetId).once('value');
                const targetMoney = targetSnap.val().money || 0;
                await database.ref('users/' + targetId).update({ money: targetMoney + amount });
                
                sendNotification(targetId, `ğŸ’° ${senderName}ë‹˜ì´ ${amount}Gë¥¼ ì†¡ê¸ˆí–ˆìŠµë‹ˆë‹¤.`);
                alert(`âœ… ${targetName} ë‹˜ì—ê²Œ ì†¡ê¸ˆ ì™„ë£Œ!`);
            }
        } else {
            const myInvSnap = await database.ref('users/' + myID + '/inventory').once('value');
            const myInv = myInvSnap.val();
            if (!myInv) return alert("ì„ ë¬¼í•  ì•„ì´í…œì´ ê°€ë°©ì— ì—†ìŠµë‹ˆë‹¤.");

            const items = Object.entries(myInv);
            let msg = `${targetName} ë‹˜ì—ê²Œ ë³´ë‚¼ ì•„ì´í…œ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n`;
            items.forEach(([key, val], i) => msg += `${i + 1}. ${val.name}\n`);

            const choice = parseInt(prompt(msg)) - 1;
            if (isNaN(choice) || !items[choice]) return;

            const [itemKey, itemData] = items[choice];

            if (confirm(`${targetName} ë‹˜ì—ê²Œ [${itemData.name}]ì„ ì„ ë¬¼í• ê¹Œìš”?`)) {
                await database.ref(`users/${myID}/inventory/${itemKey}`).remove();
                await database.ref(`users/${targetId}/inventory`).push(itemData);
                
                sendNotification(targetId, `ğŸ ${senderName}ë‹˜ì´ [${itemData.name}]ì„ ì„ ë¬¼í–ˆìŠµë‹ˆë‹¤.`);
                alert(`ğŸ [${itemData.name}] ì„ ë¬¼ì„ ì „ë‹¬í–ˆìŠµë‹ˆë‹¤!`);
            }
        }
    }

    function sendNotification(targetId, message) {
        database.ref('users/' + targetId + '/notifications').push({
            message: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            read: false
        });
    }

    function logout() { localStorage.clear(); location.href = "index.html"; }
    window.onload = loadProfile;

    // [NEW] ì„¹ì…˜ ì ‘ê³  í¼ì¹˜ê¸° í•¨ìˆ˜
    function toggleSection(elementId, header) {
        const content = document.getElementById(elementId);
        if (!content) return;

        // 1. ë‚´ìš©ë¬¼ì˜ ë³´ì„/ìˆ¨ê¹€ í† ê¸€ (collapsed í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°)
        content.classList.toggle('collapsed');
        
        // 2. ì œëª©ì˜ í™”ì‚´í‘œ íšŒì „ í† ê¸€ (active í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°)
        header.classList.toggle('active');
    }

</script>
</body>
</html>