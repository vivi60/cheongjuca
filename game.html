<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¦¬ë“¬ ìíŒê¸° (4-KEY)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        body {
            background-color: #111;
            color: #d0d0d0;
            font-family: 'Courier Prime', monospace;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 20px; min-height: 100vh;
            user-select: none;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ (ê³µí†µ) --- */
        .navbar { width: 100%; background: rgba(0,0,0,0.9); border-bottom: 1px solid #ab0000; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 50px; box-sizing: border-box; position: fixed; top: 0; z-index: 1000; }
        .logo { color: #ab0000; font-family: 'Black Ops One'; font-size: 24px; }
        .nav-links { list-style: none; display: flex; gap: 20px; }
        .nav-links a { color: white; text-decoration: none; }

        /* --- ë©”ì¸ ì»¨í…Œì´ë„ˆ --- */
        .game-wrapper {
            margin-top: 80px;
            display: flex; gap: 20px;
            width: 100%; max-width: 1000px;
            height: 80vh;
        }

        /* ì™¼ìª½: ì•„ì´í…œ ì§„ì—´ì¥ */
        .shelf-section {
            flex: 1;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            align-content: start;
        }

        .shelf-item {
            background: #222; border: 1px solid #555; border-radius: 5px;
            padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .shelf-item:hover { border-color: #ab0000; background: #2a2a2a; }
        .shelf-item.selected { border-color: #0f0; background: #001100; box-shadow: 0 0 10px #0f0; }
        .item-emoji { font-size: 30px; }
        .item-info { font-size: 10px; color: #888; margin-top: 5px; }
        .difficulty-badge { 
            display: inline-block; background: #000; color: #fff; 
            font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-top: 3px;
        }

        /* ì˜¤ë¥¸ìª½: ë¦¬ë“¬ê²Œì„ ìŠ¤í…Œì´ì§€ */
        .rhythm-section {
            flex: 1.5;
            background: #000;
            border: 4px solid #333;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ê²Œì„ UI ì •ë³´ */
        .game-hud {
            width: 100%; padding: 10px;
            display: flex; justify-content: space-between;
            background: rgba(255,255,255,0.05);
            font-family: 'Black Ops One';
            z-index: 10;
        }
        .score-box { color: #ffd700; font-size: 20px; }
        .hp-bar { width: 150px; height: 20px; background: #333; border: 1px solid #555; }
        .hp-fill { width: 100%; height: 100%; background: #0f0; transition: 0.2s; }

        /* 4í‚¤ ë ˆì¸ ì»¨í…Œì´ë„ˆ */
        .lane-container {
            position: relative;
            width: 320px; /* 4í‚¤ * 80px */
            height: 100%;
            background: linear-gradient(180deg, #000 0%, #111 100%);
            display: flex;
            border-left: 2px solid #444; border-right: 2px solid #444;
        }

        .lane {
            flex: 1;
            border-right: 1px solid #333;
            position: relative;
        }
        .lane:last-child { border-right: none; }

        /* íŒì •ì„  (Receptor) */
        .receptor-line {
            position: absolute;
            bottom: 50px;
            width: 100%; height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-top: 2px solid #0ff;
            border-bottom: 2px solid #0ff;
            pointer-events: none;
            z-index: 5;
        }

        /* í‚¤ ê°€ì´ë“œ (D F J K) */
        .key-guide {
            position: absolute; bottom: 10px; width: 100%; display: flex;
        }
        .key-label {
            flex: 1; text-align: center; color: #555; font-weight: bold; font-size: 20px;
            text-shadow: 0 0 5px #000;
        }
        .key-label.active { color: #fff; text-shadow: 0 0 10px #fff; transform: translateY(2px); }

        /* ë–¨ì–´ì§€ëŠ” ë…¸íŠ¸ */
        .note {
            position: absolute;
            width: 90%; left: 5%; height: 20px;
            background: #ab0000;
            border: 1px solid #ff5555;
            border-radius: 4px;
            box-shadow: 0 0 10px #ab0000;
            z-index: 2;
        }
        /* ë¼ì¸ë³„ ë…¸íŠ¸ ìƒ‰ìƒ (D,KëŠ” íŒŒë‘ / F,JëŠ” í°ìƒ‰ - ë””ì œì´ë§¥ìŠ¤ ìŠ¤íƒ€ì¼?) */
        .note.lane-0, .note.lane-3 { background: #0088ff; border-color: #88ccff; box-shadow: 0 0 10px #0088ff; }
        .note.lane-1, .note.lane-2 { background: #ffffff; border-color: #cccccc; box-shadow: 0 0 10px #ffffff; }

        /* íˆíŠ¸ ì´í™íŠ¸ */
        .hit-effect {
            position: absolute; bottom: 50px; width: 100%; height: 50px;
            background: linear-gradient(to top, rgba(255,255,255,0.5), transparent);
            opacity: 0; pointer-events: none; transition: 0.1s;
        }
        .hit-effect.flash { opacity: 1; }

        /* íŒì • í…ìŠ¤íŠ¸ */
        #judgeDisplay {
            position: absolute; top: 40%; width: 100%; text-align: center;
            font-family: 'Black Ops One'; font-size: 40px; 
            text-shadow: 0 0 10px #000; opacity: 0; transform: scale(0.5); transition: 0.1s; z-index: 20;
        }

        /* ê²Œì„ ì˜¤ë²„ë ˆì´ (ì‹œì‘ ì „/ì¢…ë£Œ í›„) */
        .overlay-msg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; text-align: center;
        }
        .start-btn {
            padding: 15px 30px; font-size: 20px; background: #ab0000; color: white;
            border: none; cursor: pointer; font-family: 'Black Ops One'; margin-top: 20px;
        }
        .start-btn:disabled { background: #444; cursor: not-allowed; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">
            RHYTHM HACK
            <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px;"></span>
        </div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="sub.html">ìƒì¡´ìëª©ë¡</a></li>
            <li><a href="shop.html">ìƒì </a></li>
            <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>

    <div class="game-wrapper">
        <div class="shelf-section" id="shelfList">
            </div>

        <div class="rhythm-section">
            <div class="game-hud">
                <div>SCORE: <span id="scoreVal">0</span> / <span id="targetVal">0</span></div>
                <div class="hp-bar"><div class="hp-fill" id="hpVal"></div></div>
            </div>

            <div id="judgeDisplay">PERFECT</div>

            <div class="lane-container" id="laneContainer">
                <div class="receptor-line"></div>
                
                <div class="lane" id="lane0"><div class="hit-effect" id="eff0"></div></div>
                <div class="lane" id="lane1"><div class="hit-effect" id="eff1"></div></div>
                <div class="lane" id="lane2"><div class="hit-effect" id="eff2"></div></div>
                <div class="lane" id="lane3"><div class="hit-effect" id="eff3"></div></div>

                <div class="key-guide">
                    <div class="key-label" id="key0">D</div>
                    <div class="key-label" id="key1">F</div>
                    <div class="key-label" id="key2">J</div>
                    <div class="key-label" id="key3">K</div>
                </div>
            </div>

            <div class="overlay-msg" id="msgOverlay">
                <h2 id="msgTitle" style="color:#ab0000; font-size:30px;">SYSTEM READY</h2>
                <p id="msgDesc">ì™¼ìª½ì—ì„œ í•´í‚¹í•  ë¬¼ê±´ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <button class="start-btn" id="startBtn" onclick="startGame()" disabled>START GAME</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
            authDomain: "cheongjuca.firebaseapp.com",
            databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
            projectId: "cheongjuca",
            storageBucket: "cheongjuca.firebasestorage.app",
            messagingSenderId: "455437421321",
            appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // [ê²Œì„ ì„¤ì • ë°ì´í„°]
        // speed: ë…¸íŠ¸ ë‚´ë ¤ì˜¤ëŠ” ì†ë„ (ë†’ì„ìˆ˜ë¡ ë¹ ë¦„)
        // target: í´ë¦¬ì–´ ëª©í‘œ ì ìˆ˜
        // spawnRate: ë…¸íŠ¸ ìƒì„± ë¹ˆë„ (ë‚®ì„ìˆ˜ë¡ ìì£¼ ë‚˜ì˜´)
        const items = [
            { name: "ë¯¸ì§€ê·¼í•œ ìº”ì»¤í”¼", emoji: "â˜•", price: 50, speed: 3, target: 500, spawnRate: 60, desc: "EASY" },
            { name: "ì°Œê·¸ëŸ¬ì§„ ìº”ìŒë£Œ", emoji: "ğŸ¥¤", price: 80, speed: 5, target: 1000, spawnRate: 50, desc: "NORMAL" },
            { name: "ìœ í†µê¸°í•œ ì§€ë‚œ ê³¼ì", emoji: "ğŸª", price: 120, speed: 7, target: 2000, spawnRate: 40, desc: "HARD" },
            { name: "ë…¹ì•„ë‚´ë¦° ì´ˆì½œë¦¿", emoji: "ğŸ«", price: 200, speed: 9, target: 3500, spawnRate: 30, desc: "VERY HARD" },
            { name: "ìˆ˜ìƒí•œ ì—ë„ˆì§€ë“œë§í¬", emoji: "âš¡", price: 500, speed: 12, target: 5000, spawnRate: 25, desc: "INSANE" },
            { name: "ë°˜ì§ì´ëŠ” ë™ì „ ì§€ê°‘", emoji: "ğŸ‘›", price: 2000, speed: 15, target: 8000, spawnRate: 20, desc: "CHAOS" }
        ];

        let selectedItemIdx = -1;
        let isPlaying = false;
        let score = 0;
        let hp = 100;
        let animationFrame;
        let frameCount = 0;
        let notes = []; // í˜„ì¬ í™”ë©´ì— ìˆëŠ” ë…¸íŠ¸ë“¤ ê°ì²´ ë°°ì—´
        const KEY_MAP = { 'd': 0, 'f': 1, 'j': 2, 'k': 3 }; // í‚¤ ë§¤í•‘
        
        // ì‚¬ìš©ì ì •ë³´
        const myID = localStorage.getItem("loginID");
        const myNick = localStorage.getItem("userNick");
        let userMoney = 0;

        window.onload = function() {
            // ë°°ì§€ ë° ë¡œê·¸ì¸ ì²´í¬
            const status = localStorage.getItem("loginStatus");
            if (!status || (status !== "success" && status !== "admin")) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href="index.html"; return;
            }
            const badge = document.getElementById("userBadge");
            if(badge && myNick) {
                if(status === "admin") { badge.innerText="[ê´€ë¦¬ì ëª¨ë“œ]"; badge.style.color="red"; }
                else { badge.innerText=`[${myNick}]`; badge.style.color="#ccc"; }
                badge.style.display="inline";
            }

            // ëˆ ì •ë³´ ë¡œë“œ
            database.ref(`users/${myID}/money`).on('value', snap => {
                userMoney = snap.val() || 0;
            });

            renderShelf();
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
        };

        function renderShelf() {
            const container = document.getElementById('shelfList');
            container.innerHTML = "";
            items.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `shelf-item ${selectedItemIdx === idx ? 'selected' : ''}`;
                div.innerHTML = `
                    <div class="item-emoji">${item.emoji}</div>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div class="difficulty-badge" style="color:${getDiffColor(idx)}">${item.desc}</div>
                    <div class="item-info">ëª©í‘œ: ${item.target}ì  | ì†ë„: Lv.${item.speed}</div>
                    <div class="item-info" style="color:gold;">ë¹„ìš©: ${item.price} G</div>
                `;
                div.onclick = () => selectItem(idx);
                container.appendChild(div);
            });
        }

        function getDiffColor(idx) {
            if(idx < 2) return "#0f0"; // Easy
            if(idx < 4) return "#ff0"; // Medium
            return "#f00"; // Hard
        }

        function selectItem(idx) {
            if(isPlaying) return;
            selectedItemIdx = idx;
            renderShelf();
            
            const item = items[idx];
            const msgTitle = document.getElementById('msgTitle');
            const msgDesc = document.getElementById('msgDesc');
            const startBtn = document.getElementById('startBtn');

            msgTitle.innerText = item.name;
            msgTitle.style.color = "#fff";
            msgDesc.innerHTML = `
                ë‚œì´ë„: <span style="color:${getDiffColor(idx)}">${item.desc}</span><br>
                í•„ìš” ë¹„ìš©: <span style="color:gold">${item.price} G</span><br>
                ëª©í‘œ ì ìˆ˜: ${item.target} ì 
            `;
            startBtn.disabled = false;
            startBtn.innerText = `í•´í‚¹ ì‹œì‘ (-${item.price}G)`;
        }

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ (ê¸°ì¡´ ë³€ìˆ˜ ì„ ì–¸ë¶€ì— ì¶”ê°€í•´ë„ ë˜ê³ , ê·¸ëƒ¥ ë‘¬ë„ ë©ë‹ˆë‹¤)
        let nextSpawnAt = 0; 

        function startGame() {
            if(selectedItemIdx === -1) return;
            const item = items[selectedItemIdx];

            if(userMoney < item.price) {
                alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                return;
            }

            if(!confirm(`${item.price}Gë¥¼ ì‚¬ìš©í•˜ì—¬ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // ëˆ ì°¨ê°
            database.ref(`users/${myID}/money`).set(userMoney - item.price);

            // â˜… ë°”ë¡œ ì‹œì‘í•˜ì§€ ì•Šê³  ì¹´ìš´íŠ¸ë‹¤ìš´ í•¨ìˆ˜ í˜¸ì¶œ
            startCountdown();
        }

        function startCountdown() {
            const overlay = document.getElementById('msgOverlay');
            const title = document.getElementById('msgTitle');
            const desc = document.getElementById('msgDesc');
            const btn = document.getElementById('startBtn');

            // 1. UI ì¤€ë¹„ (ë²„íŠ¼ ìˆ¨ê¸°ê³ , ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤€ë¹„)
            btn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¹€
            desc.innerText = "SYSTEM BREACHING...";
            desc.style.color = "#0f0";
            
            let count = 5;
            title.innerText = count;
            title.style.fontSize = "100px"; // ìˆ«ì í¬ê²Œ!
            title.style.color = "#fff";

            // 2. 1ì´ˆë§ˆë‹¤ ìˆ«ì ì¤„ì´ê¸°
            const timer = setInterval(() => {
                count--;
                
                if (count > 0) {
                    title.innerText = count;
                } else if (count === 0) {
                    title.innerText = "HACK!";
                    title.style.color = "#ff0000"; // ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ê°•ì¡°
                    title.style.textShadow = "0 0 20px red";
                } else {
                    // 3. ì¹´ìš´íŠ¸ë‹¤ìš´ ë! ê²Œì„ ì‹œì‘
                    clearInterval(timer);
                    
                    // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                    overlay.style.display = 'none';
                    
                    // ìŠ¤íƒ€ì¼ ì›ìƒë³µêµ¬ (ë‹¤ìŒ ê²Œì„ì„ ìœ„í•´)
                    title.style.fontSize = "30px"; 
                    title.style.textShadow = "none";
                    desc.style.color = "#aaa";

                    // â˜… ì§„ì§œ ê²Œì„ ë¡œì§ ì‹¤í–‰
                    initGameAndLoop();
                }
            }, 1000); // 1ì´ˆ ê°„ê²©
        }

        // ê²Œì„ ë³€ìˆ˜ ì´ˆê¸°í™” ë° ë£¨í”„ ì‹œì‘ í•¨ìˆ˜ (ë¶„ë¦¬ë¨)
        function initGameAndLoop() {
            const item = items[selectedItemIdx];
            
            isPlaying = true;
            score = 0;
            hp = 100;
            frameCount = 0;
            nextSpawnAt = 0;
            notes = [];
            document.querySelectorAll('.note').forEach(el => el.remove()); 
            
            document.getElementById('scoreVal').innerText = "0";
            document.getElementById('targetVal').innerText = item.target;
            updateHP();

            gameLoop();
        }

        function gameLoop() {
            if(!isPlaying) return;

            const item = items[selectedItemIdx];
            frameCount++;

            // â˜… [í•µì‹¬ ìˆ˜ì •] ë³€ì¹™ì ì¸ ë…¸íŠ¸ ìƒì„± ë¡œì§
            if (frameCount >= nextSpawnAt) {
                // 1. ë…¸íŠ¸ í•˜ë‚˜ ìƒì„±
                const firstLane = spawnNote();

                // 2. [ì–´ë ¤ì›€ ì „ìš©] í™•ë¥ ì ìœ¼ë¡œ 'ë™ì‹œ ì¹˜ê¸°' (Double Note) ìƒì„±
                // ë‚œì´ë„ê°€ ë†’ì„ìˆ˜ë¡(speed > 7) ë™ì‹œì¹˜ê¸° í™•ë¥  ì¦ê°€
                if (item.speed > 7 && Math.random() < 0.3) {
                    spawnNote(firstLane); // ì²« ë²ˆì§¸ ë…¸íŠ¸ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ìƒì„±
                }

                // 3. [ë³€ì¹™ ë°•ì] ë‹¤ìŒ ë…¸íŠ¸ê°€ ë‚˜ì˜¬ ì‹œê°„(Interval)ì„ ëœë¤í•˜ê²Œ ê³„ì‚°
                // ê¸°ë³¸ í…œí¬ì—ì„œ 0.5ë°°(ë¹ ë¦„) ~ 1.5ë°°(ëŠë¦¼) ì‚¬ì´ë¡œ í”ë“¦
                let chaosFactor = 0.5 + Math.random(); 

                // [ê·¹ì•… ë‚œì´ë„ ì „ìš©] 20% í™•ë¥ ë¡œ 'í­íƒ€' (ì•„ì£¼ ì§§ì€ ê°„ê²©) ë°œìƒ
                if (item.speed > 10 && Math.random() < 0.2) {
                    chaosFactor = 0.25; 
                }

                // ë‹¤ìŒ ì†Œí™˜ ì‹œê°„ ì˜ˆì•½
                nextSpawnAt = frameCount + (item.spawnRate * chaosFactor);
            }

            // 3. ë…¸íŠ¸ ì´ë™ ë° ë¯¸ìŠ¤ ì²´í¬ (ê¸°ì¡´ ìœ ì§€)
            for (let i = notes.length - 1; i >= 0; i--) {
                const note = notes[i];
                note.y += item.speed;
                note.el.style.top = note.y + "px";

                const containerH = document.getElementById('laneContainer').clientHeight;
                
                if (note.y > containerH) {
                    if (note.hit) {
                        note.el.remove();
                        notes.splice(i, 1);
                    } else {
                        showJudge("MISS", "#555");
                        hp -= 10; 
                        updateHP();
                        note.el.remove();
                        notes.splice(i, 1);
                        checkGameOver();
                    }
                }
            }

            animationFrame = requestAnimationFrame(gameLoop);
        }

        function spawnNote(excludeLane = -1) {
            let laneIdx;
            
            // ê²¹ì¹˜ì§€ ì•ŠëŠ” ë ˆì¸ì„ ë½‘ì„ ë•Œê¹Œì§€ ë°˜ë³µ (ë™ì‹œì¹˜ê¸°ìš©)
            do {
                laneIdx = Math.floor(Math.random() * 4);
            } while (laneIdx === excludeLane);

            const laneEl = document.getElementById(`lane${laneIdx}`);
            
            const noteEl = document.createElement('div');
            noteEl.className = `note lane-${laneIdx}`;
            noteEl.style.top = "-20px"; 
            laneEl.appendChild(noteEl);

            notes.push({
                el: noteEl,
                lane: laneIdx,
                y: -20,
                hit: false 
            });

            return laneIdx; // ìƒì„±ëœ ë ˆì¸ ë²ˆí˜¸ë¥¼ ë°˜í™˜ (ë‹¤ìŒ ë…¸íŠ¸ê°€ í”¼í•  ìˆ˜ ìˆê²Œ)
        }

        function handleKeyDown(e) {
            if(!isPlaying) return;
            const key = e.key.toLowerCase();
            if(KEY_MAP.hasOwnProperty(key)) {
                const lane = KEY_MAP[key];
                
                // í‚¤ ëˆ„ë¦„ ì‹œê°ì  íš¨ê³¼
                document.getElementById(`key${lane}`).classList.add('active');
                document.getElementById(`eff${lane}`).classList.add('flash');
                setTimeout(() => document.getElementById(`eff${lane}`).classList.remove('flash'), 100);

                checkHit(lane);
            }
        }

        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            if(KEY_MAP.hasOwnProperty(key)) {
                document.getElementById(`key${KEY_MAP[key]}`).classList.remove('active');
            }
        }

        function checkHit(lane) {
            // í•´ë‹¹ ë ˆì¸ì— ìˆëŠ” ë…¸íŠ¸ ì¤‘, íŒì •ì„  ê·¼ì²˜ì— ìˆëŠ” ê°€ì¥ ì•„ë˜ìª½ ë…¸íŠ¸ ì°¾ê¸°
            // íŒì •ì„  ìœ„ì¹˜: bottom 50px. ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ top ì¢Œí‘œ ê³„ì‚° í•„ìš”.
            const containerH = document.getElementById('laneContainer').clientHeight;
            const targetY = containerH - 50 - 10; // íŒì •ì„  yì¢Œí‘œ (ëŒ€ëµì )

            // íŒì • ë²”ìœ„ (í”½ì…€)
            const PER_RANGE = 30; 
            const GOOD_RANGE = 60;
            const BAD_RANGE = 90;

            // í•´ë‹¹ ë ˆì¸ì˜ ë…¸íŠ¸ í•„í„°ë§
            const targetNotes = notes.filter(n => n.lane === lane && !n.hit);
            
            // ê°€ì¥ ì•„ë˜ì— ìˆëŠ” ë…¸íŠ¸ ì°¾ê¸° (yê°’ì´ ê°€ì¥ í° ê²ƒ)
            if(targetNotes.length === 0) return;
            
            // ì •ë ¬ (y ë‚´ë¦¼ì°¨ìˆœ)
            targetNotes.sort((a, b) => b.y - a.y);
            const note = targetNotes[0]; // íƒ€ê²Ÿ ë…¸íŠ¸

            const diff = Math.abs(targetY - note.y);

            if (diff < BAD_RANGE) {
                note.hit = true;
                note.el.style.opacity = 0; // ìˆ¨ê¹€ ì²˜ë¦¬ (ë‚˜ì¤‘ì— ë£¨í”„ì—ì„œ ì œê±°ë¨)
                
                if (diff < PER_RANGE) {
                    score += 100;
                    showJudge("PERFECT", "#0ff");
                    hp = Math.min(100, hp + 2); // í
                } else if (diff < GOOD_RANGE) {
                    score += 50;
                    showJudge("GOOD", "#0f0");
                    hp = Math.min(100, hp + 1);
                } else {
                    score += 10;
                    showJudge("BAD", "#ff0");
                }
                
                document.getElementById('scoreVal').innerText = score;
                updateHP();
                checkWin();
            }
        }

        function showJudge(text, color) {
            const el = document.getElementById('judgeDisplay');
            el.innerText = text;
            el.style.color = color;
            el.style.opacity = 1;
            el.style.transform = "scale(1.2)";
            
            // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ trick
            setTimeout(() => {
                el.style.transform = "scale(1)";
                el.style.opacity = 0;
            }, 300);
        }

        function updateHP() {
            const bar = document.getElementById('hpVal');
            bar.style.width = hp + "%";
            if(hp < 30) bar.style.background = "red";
            else bar.style.background = "#0f0";
        }

        function checkGameOver() {
            if (hp <= 0) {
                endGame(false);
            }
        }

        function checkWin() {
            const item = items[selectedItemIdx];
            if (score >= item.target) {
                endGame(true);
            }
        }

        function endGame(isWin) {
            isPlaying = false;
            cancelAnimationFrame(animationFrame);
            
            const overlay = document.getElementById('msgOverlay');
            const title = document.getElementById('msgTitle');
            const desc = document.getElementById('msgDesc');
            const btn = document.getElementById('startBtn');

            overlay.style.display = 'flex';
            btn.style.display = 'inline-block'; // â˜… [ì¶”ê°€ë¨] ì•„ê¹Œ ìˆ¨ê²¼ë˜ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
            
            if (isWin) {
                title.innerText = "HACKING SUCCESS!";
                title.style.color = "#0f0";
                desc.innerText = `ëª©í‘œ ì ìˆ˜ ë‹¬ì„±! ë³´ìƒì„ íšë“í•©ë‹ˆë‹¤.`;
                btn.innerText = "ë³´ìƒ ìˆ˜ë ¹";
                btn.onclick = () => giveReward();
            } else {
                title.innerText = "SYSTEM FAILURE";
                title.style.color = "#f00";
                desc.innerText = `HPê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                btn.innerText = "ë‹¤ì‹œ ì‹œë„";
                btn.onclick = () => startGame(); // ì¬ì‹œì‘ ì‹œ ë‹¤ì‹œ ì¹´ìš´íŠ¸ë‹¤ìš´ë¶€í„°
            }
        }

        function giveReward() {
            const item = items[selectedItemIdx];
            // í™•ë¥ ì ìœ¼ë¡œ ì—‰ëš±í•œ ë¬¼ê±´ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            let rewardItem = item;
            let msg = `[${item.name}] íšë“!`;

            if (Math.random() < 0.1) { // 10% í™•ë¥ ë¡œ ê½
                const randIdx = Math.floor(Math.random() * items.length);
                rewardItem = items[randIdx];
                msg = `âš ï¸ ì˜¤ë¥˜ ë°œìƒ! ì—‰ëš±í•œ ë¬¼ê±´ [${rewardItem.name}] íšë“...`;
            }

            // ì¸ë²¤í† ë¦¬ ì €ì¥
            const inv = JSON.parse(localStorage.getItem("myInventory") || "{}");
            inv[rewardItem.name] = (inv[rewardItem.name] || 0) + 1;
            inv[rewardItem.name + "_price"] = rewardItem.price;
            inv[rewardItem.name + "_icon"] = rewardItem.emoji;
            localStorage.setItem("myInventory", JSON.stringify(inv));

            alert(msg);
            location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì´ˆê¸°í™”
        }

        function logout() { localStorage.clear(); location.href="index.html"; }
    </script>
</body>
</html>