<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¦¬ë“¬ ìíŒê¸° (4-KEY)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        body {
            background-color: #111;
            color: #d0d0d0;
            font-family: 'Courier Prime', monospace;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 20px; min-height: 100vh;
            user-select: none;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ (ê³µí†µ) --- */
        .navbar { width: 100%; background: rgba(0,0,0,0.9); border-bottom: 1px solid #ab0000; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 50px; box-sizing: border-box; position: fixed; top: 0; z-index: 1000; }
        .logo { color: #ab0000; font-family: 'Black Ops One'; font-size: 24px; }
        .nav-links { list-style: none; display: flex; gap: 20px; }
        .nav-links a { color: white; text-decoration: none; }

        /* --- ë©”ì¸ ì»¨í…Œì´ë„ˆ --- */
        .game-wrapper {
            margin-top: 80px;
            display: flex; gap: 20px;
            width: 100%; max-width: 1000px;
            height: 80vh;
        }

        /* ì™¼ìª½: ì•„ì´í…œ ì§„ì—´ì¥ */
        .shelf-section {
            flex: 1;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            align-content: start;
        }

        .shelf-item {
            background: #222; border: 1px solid #555; border-radius: 5px;
            padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .shelf-item:hover { border-color: #ab0000; background: #2a2a2a; }
        .shelf-item.selected { border-color: #0f0; background: #001100; box-shadow: 0 0 10px #0f0; }
        .item-emoji { font-size: 30px; }
        .item-info { font-size: 10px; color: #888; margin-top: 5px; }
        .difficulty-badge { 
            display: inline-block; background: #000; color: #fff; 
            font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-top: 3px;
        }

        /* ì˜¤ë¥¸ìª½: ë¦¬ë“¬ê²Œì„ ìŠ¤í…Œì´ì§€ */
        .rhythm-section {
            flex: 1.5;
            background: #000;
            border: 4px solid #333;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ê²Œì„ UI ì •ë³´ */
        .game-hud {
            width: 100%; padding: 10px;
            display: flex; justify-content: space-between;
            background: rgba(255,255,255,0.05);
            font-family: 'Black Ops One';
            z-index: 10;
        }
        .score-box { color: #ffd700; font-size: 20px; }
        .hp-bar { width: 150px; height: 20px; background: #333; border: 1px solid #555; }
        .hp-fill { width: 100%; height: 100%; background: #0f0; transition: 0.2s; }

        /* 4í‚¤ ë ˆì¸ ì»¨í…Œì´ë„ˆ */
        .lane-container {
            position: relative;
            width: 320px; /* 4í‚¤ * 80px */
            height: 100%;
            background: linear-gradient(180deg, #000 0%, #111 100%);
            display: flex;
            border-left: 2px solid #444; border-right: 2px solid #444;
        }

        .lane {
            flex: 1;
            border-right: 1px solid #333;
            position: relative;
        }
        .lane:last-child { border-right: none; }

        /* íŒì •ì„  (Receptor) */
        .receptor-line {
            position: absolute;
            bottom: 50px;
            width: 100%; height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-top: 2px solid #0ff;
            border-bottom: 2px solid #0ff;
            pointer-events: none;
            z-index: 5;
        }

        /* í‚¤ ê°€ì´ë“œ (D F J K) */
        .key-guide {
            position: absolute; bottom: 10px; width: 100%; display: flex;
        }
        .key-label {
            flex: 1; text-align: center; color: #555; font-weight: bold; font-size: 20px;
            text-shadow: 0 0 5px #000;
        }
        .key-label.active { color: #fff; text-shadow: 0 0 10px #fff; transform: translateY(2px); }

        /* ë–¨ì–´ì§€ëŠ” ë…¸íŠ¸ */
        .note {
            position: absolute;
            width: 90%; left: 5%; height: 20px;
            background: #ab0000;
            border: 1px solid #ff5555;
            border-radius: 4px;
            box-shadow: 0 0 10px #ab0000;
            z-index: 2;
        }
        /* ë¼ì¸ë³„ ë…¸íŠ¸ ìƒ‰ìƒ (D,KëŠ” íŒŒë‘ / F,JëŠ” í°ìƒ‰ - ë””ì œì´ë§¥ìŠ¤ ìŠ¤íƒ€ì¼?) */
        .note.lane-0, .note.lane-3 { background: #0088ff; border-color: #88ccff; box-shadow: 0 0 10px #0088ff; }
        .note.lane-1, .note.lane-2 { background: #ffffff; border-color: #cccccc; box-shadow: 0 0 10px #ffffff; }

        /* íˆíŠ¸ ì´í™íŠ¸ */
        .hit-effect {
            position: absolute; bottom: 50px; width: 100%; height: 50px;
            background: linear-gradient(to top, rgba(255,255,255,0.5), transparent);
            opacity: 0; pointer-events: none; transition: 0.1s;
        }
        .hit-effect.flash { opacity: 1; }

        /* íŒì • í…ìŠ¤íŠ¸ */
        #judgeDisplay {
            position: absolute; top: 40%; width: 100%; text-align: center;
            font-family: 'Black Ops One'; font-size: 40px; 
            text-shadow: 0 0 10px #000; opacity: 0; transform: scale(0.5); transition: 0.1s; z-index: 20;
        }

        /* ê²Œì„ ì˜¤ë²„ë ˆì´ (ì‹œì‘ ì „/ì¢…ë£Œ í›„) */
        .overlay-msg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; text-align: center;
        }
        .start-btn {
            padding: 15px 30px; font-size: 20px; background: #ab0000; color: white;
            border: none; cursor: pointer; font-family: 'Black Ops One'; margin-top: 20px;
        }
        .start-btn:disabled { background: #444; cursor: not-allowed; }

        /* [ì¶”ê°€] ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .volume-control {
            display: flex; align-items: center; gap: 10px; font-size: 14px; color: #aaa;
        }
        
        /* [ìˆ˜ì •ë¨] ë”°ì˜´í‘œ("") ì¶”ê°€ ë° í‘œì¤€ ì†ì„± ì ìš© */
        input[type="range"] {
            -webkit-appearance: none; /* í¬ë¡¬, ì‚¬íŒŒë¦¬ êµ¬ë²„ì „ */
            appearance: none;         /* í‘œì¤€ ì†ì„± */
            width: 100px; 
            height: 6px; 
            background: #333; 
            border-radius: 3px; 
            outline: none;
            margin: 0 5px; /* ì¢Œìš° ì—¬ë°± ì‚´ì§ ì¶”ê°€ */
        }
        
        /* ìŠ¬ë¼ì´ë” í•¸ë“¤(ì†ì¡ì´) ìŠ¤íƒ€ì¼ - ì´ê²ƒë„ ê¼­ ìˆì–´ì•¼ í•©ë‹ˆë‹¤! */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; 
            height: 14px; 
            background: #ab0000; 
            border-radius: 50%;
            cursor: pointer; 
            border: 2px solid #fff;
        }

        /* --- [ì¶”ê°€] ë…¸íŠ¸ ìŠ¤í‚¨ ë””ìì¸ --- */
        
        /* 1. ê¸°ë³¸ ë…¸íŠ¸ (íŒŒë€ìƒ‰ ë„¤ëª¨) */
        .note.skin_default {
            background: #00ffff; 
            border-radius: 2px;
            box-shadow: 0 0 10px #00ffff;
        }

        /* 2. ë„¤ì˜¨ ì„œí´ (ë³´ë¼ìƒ‰ ë™ê·¸ë¼ë¯¸) */
        .note.skin_neon {
            background: #d000ff; 
            border-radius: 50%;
            box-shadow: 0 0 15px #d000ff, inset 0 0 5px white;
            border: 2px solid #fff;
        }

        /* 3. 8ë¹„íŠ¸ í”½ì…€ (íˆ¬ëª… ë°°ê²½ + ì´ëª¨ì§€) */
        .note.skin_pixel {
            background: transparent;
            box-shadow: none;
        }
        /* í”½ì…€ ìŠ¤í‚¨ì€ CSSë¡œ ê°€ì§œ ìš”ì†Œ(ì´ëª¨ì§€)ë¥¼ ë„£ì–´ì„œ í‘œí˜„ */
        .note.skin_pixel::after {
            content: 'ğŸ‘¾'; 
            font-size: 30px; 
            position: absolute; 
            left: -8px; top: -5px;
            filter: drop-shadow(0 0 5px #0f0);
        }

        /* 4. ë¶ˆê½ƒ ë…¸íŠ¸ (ì£¼í™©ìƒ‰ ë¬¼ë°©ìš¸ ëª¨ì–‘) */
        .note.skin_fire {
            background: linear-gradient(to bottom, yellow, red);
            border-radius: 50% 50% 5px 5px;
            box-shadow: 0 -5px 15px orange;
        }

    </style>
</head>
<body>
<audio id="bgmPlayer" loop style="display:none;"></audio>
    <nav class="navbar">
    <div class="logo">
        OUT BREAK 
        <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;"></span>
    </div>
    <ul class="nav-links">
        <li><a href="main.html">í™ˆ</a></li>
        <li><a href="sub.html">ìƒì¡´ìëª©ë¡</a></li>
        <li><a href="board.html">ììœ ê²Œì‹œíŒ</a></li>
        <li><a href="trade.html">ì¤‘ê³ ê±°ë˜ê²Œì‹œíŒ</a></li>
        <li><a href="quest.html">ì˜ë¢°ê²Œì‹œíŒ</a></li>
        <li><a href="game.html">ê³ ì¥ë‚œìíŒê¸°</a></li>
        <li><a href="shop.html">êµí™˜ì†Œ</a></li>
        <li><a href="vending.html">ì‹ í˜•ìíŒê¸°</a></li>
        <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
    </ul>
    </nav>

    <div class="game-wrapper">
        <div class="shelf-section" id="shelfList">
            </div>

            
        <div class="rhythm-section">
            <div class="game-hud">
                <div class="score-box">SCORE: <span id="scoreVal">0</span> / <span id="targetVal">0</span></div>
                
                <div class="volume-control">
                    <span>â™ª VOL</span>
                    <input type="range" id="volSlider" min="0" max="1" step="0.1" value="0.5">
                </div>

                <div class="hp-bar"><div class="hp-fill" id="hpVal"></div></div>
            </div>

            <div id="judgeDisplay">PERFECT</div>

            <div class="lane-container" id="laneContainer">
                <div class="receptor-line"></div>
                
                <div class="lane" id="lane0"><div class="hit-effect" id="eff0"></div></div>
                <div class="lane" id="lane1"><div class="hit-effect" id="eff1"></div></div>
                <div class="lane" id="lane2"><div class="hit-effect" id="eff2"></div></div>
                <div class="lane" id="lane3"><div class="hit-effect" id="eff3"></div></div>

                <div class="key-guide">
                    <div class="key-label" id="key0">D</div>
                    <div class="key-label" id="key1">F</div>
                    <div class="key-label" id="key2">J</div>
                    <div class="key-label" id="key3">K</div>
                </div>
            </div>

            <div class="overlay-msg" id="msgOverlay">
                <h2 id="msgTitle" style="color:#ab0000; font-size:30px;">SYSTEM READY</h2>
                <p id="msgDesc">ì™¼ìª½ì—ì„œ í•´í‚¹í•  ë¬¼ê±´ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <button class="start-btn" id="startBtn" onclick="startGame()" disabled>START GAME</button>
            </div>
        </div>
        
    </div>
    

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
            authDomain: "cheongjuca.firebaseapp.com",
            databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
            projectId: "cheongjuca",
            storageBucket: "cheongjuca.firebasestorage.app",
            messagingSenderId: "455437421321",
            appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // [ê²Œì„ ì„¤ì • ë°ì´í„°]
        // speed: ë…¸íŠ¸ ë‚´ë ¤ì˜¤ëŠ” ì†ë„ (ë†’ì„ìˆ˜ë¡ ë¹ ë¦„)
        // target: í´ë¦¬ì–´ ëª©í‘œ ì ìˆ˜
        // spawnRate: ë…¸íŠ¸ ìƒì„± ë¹ˆë„ (ë‚®ì„ìˆ˜ë¡ ìì£¼ ë‚˜ì˜´)
        // [ê²Œì„ ì„¤ì • ë°ì´í„°]
        // bpm: ë…¸ë˜ ë¹ ë¥´ê¸° (ë†’ì„ìˆ˜ë¡ ë…¸íŠ¸ê°€ ë¹¨ë¦¬ ë‚˜ì˜´)
        // audio: ì‹¤í–‰í•  ìŒì•… íŒŒì¼ ì£¼ì†Œ (mp3 ë“±)
        const items = [
            { 
                name: "ë¯¸ì§€ê·¼í•œ ìº”ì»¤í”¼ (Easy)", emoji: "â˜•", price: 50, 
                target: 5000, desc: "BPM 90", 
                speed: 3, bpm: 90, // ëŠë¦° ë°•ì
                audio: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg" // (ì˜ˆì‹œ) ì”ì”í•œ ì†Œë¦¬
            },
            { 
                name: "ì°Œê·¸ëŸ¬ì§„ ìº”ìŒë£Œ (Normal)", emoji: "ğŸ¥¤", price: 80, 
                target: 10000, desc: "BPM 110", 
                speed: 5, bpm: 110, // ë³´í†µ ë°•ì
                audio: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" // (ì˜ˆì‹œ) ì‹ ë‚˜ëŠ” ìŒì•…
            },
            { 
                name: "ìœ í†µê¸°í•œ ì§€ë‚œ ê³¼ì (Hard)", emoji: "ğŸª", price: 120, 
                target: 20000, desc: "BPM 130", 
                speed: 8, bpm: 130, // ë¹ ë¥¸ ë°•ì
                audio: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" 
            },
            { 
                name: "ë…¹ì•„ë‚´ë¦° ì´ˆì½œë¦¿ (Crazy)", emoji: "ğŸ«", price: 200, 
                target: 35000, desc: "BPM 160", 
                speed: 12, bpm: 160, // ì•„ì£¼ ë¹ ë¥¸ ë°•ì
                audio: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" 
            },
            { 
                name: "í•´í‚¹ ë””ìŠ¤í¬ (Extreme)", emoji: "ğŸ’¾", price: 500, 
                target: 50000, desc: "BPM 180", 
                speed: 15, bpm: 180, // ë¯¸ì¹œ ì†ë„
                audio: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" 
            }
        ];

        let selectedItemIdx = -1;
        let isPlaying = false;
        let score = 0;
        let hp = 100;
        let animationFrame;
        let frameCount = 0;
        let currentSkin = 'skin_default'; // ê¸°ë³¸ê°’
        let notes = []; // í˜„ì¬ í™”ë©´ì— ìˆëŠ” ë…¸íŠ¸ë“¤ ê°ì²´ ë°°ì—´
        const KEY_MAP = { 'd': 0, 'f': 1, 'j': 2, 'k': 3 }; // í‚¤ ë§¤í•‘
        
        // ì‚¬ìš©ì ì •ë³´
        const myID = localStorage.getItem("loginID");
        const myNick = localStorage.getItem("userNick");
        let userMoney = 0;

        window.onload = function() {
            // 1. ë¡œê·¸ì¸ ë° ê¶Œí•œ ì²´í¬
            const status = localStorage.getItem("loginStatus");
            // loginIDì™€ myIDê°€ í˜¼ìš©ë˜ê³  ìˆë‹¤ë©´ í•˜ë‚˜ë¡œ í†µì¼ (ë³´í†µ loginID ì‚¬ìš©)
            const myID = localStorage.getItem("loginID"); 
            const myNick = localStorage.getItem("userNick");

            if (!status || (status !== "success" && status !== "admin")) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href="index.html"; return;
            }

            // 2. Firebase ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìŠ¤í‚¨, ë‹‰ë„¤ì„)
            database.ref('users/' + myID).once('value', snapshot => {
                const data = snapshot.val();
                
                // ì¥ì°©í•œ ìŠ¤í‚¨ ì •ë³´ê°€ ìˆë‹¤ë©´ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                if (data && data.equipped && data.equipped.skin) {
                    currentSkin = data.equipped.skin;
                }
                
                // ê²Œì„ í™”ë©´ì— ë‹‰ë„¤ì„ í‘œì‹œ
                if(data) {
                    const nickElem = document.getElementById('myNick');
                    if(nickElem) nickElem.innerText = "USER: " + (data.nick || myID);
                }
            });

            // 3. ëˆ ì •ë³´ ì‹¤ì‹œê°„ ë™ê¸°í™”
            database.ref(`users/${myID}/money`).on('value', snap => {
                // userMoney ì „ì—­ë³€ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆì–´ì•¼ í•¨
                userMoney = snap.val() || 0; 
            });

            // 4. ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°°ì§€ ì„¤ì •
            const badge = document.getElementById("userBadge");
            if(badge && myNick) {
                if(status === "admin") { badge.innerText="[ê´€ë¦¬ì ëª¨ë“œ]"; badge.style.color="red"; }
                else { badge.innerText=`[${myNick}]`; badge.style.color="#ccc"; }
                badge.style.display="inline";
            }

            // 5. ê²Œì„ ì´ˆê¸°í™” ë° í™”ë©´ ê·¸ë¦¬ê¸° (ì¤‘ë³µ ì œê±°ë¨)
            renderShelf();
            
            // 6. í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ì¤‘ë³µ ì œê±°ë¨)
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);

            // 7. ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ì—°ê²°
            const volSlider = document.getElementById('volSlider');
            const audioPlayer = document.getElementById('bgmPlayer');
            
            if(volSlider && audioPlayer) {
                volSlider.addEventListener('input', function() {
                    audioPlayer.volume = this.value; 
                });
            }
        };

        function renderShelf() {
            const container = document.getElementById('shelfList');
            container.innerHTML = "";
            items.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `shelf-item ${selectedItemIdx === idx ? 'selected' : ''}`;
                div.innerHTML = `
                    <div class="item-emoji">${item.emoji}</div>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div class="difficulty-badge" style="color:${getDiffColor(idx)}">${item.desc}</div>
                    <div class="item-info">ëª©í‘œ: ${item.target}ì  | ì†ë„: Lv.${item.speed}</div>
                    <div class="item-info" style="color:gold;">ë¹„ìš©: ${item.price} G</div>
                `;
                div.onclick = () => selectItem(idx);
                container.appendChild(div);
            });
        }

        function getDiffColor(idx) {
            if(idx < 2) return "#0f0"; // Easy
            if(idx < 4) return "#ff0"; // Medium
            return "#f00"; // Hard
        }

        function selectItem(idx) {
            if(isPlaying) return;
            selectedItemIdx = idx;
            renderShelf();
            
            const item = items[idx];
            const msgTitle = document.getElementById('msgTitle');
            const msgDesc = document.getElementById('msgDesc');
            const startBtn = document.getElementById('startBtn');

            msgTitle.innerText = item.name;
            msgTitle.style.color = "#fff";
            msgDesc.innerHTML = `
                ë‚œì´ë„: <span style="color:${getDiffColor(idx)}">${item.desc}</span><br>
                í•„ìš” ë¹„ìš©: <span style="color:gold">${item.price} G</span><br>
                ëª©í‘œ ì ìˆ˜: ${item.target} ì 
            `;
            startBtn.disabled = false;
            startBtn.innerText = `í•´í‚¹ ì‹œì‘ (-${item.price}G)`;
        }

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ (ê¸°ì¡´ ë³€ìˆ˜ ì„ ì–¸ë¶€ì— ì¶”ê°€í•´ë„ ë˜ê³ , ê·¸ëƒ¥ ë‘¬ë„ ë©ë‹ˆë‹¤)
        let nextSpawnAt = 0; 

        function startGame() {
            if(selectedItemIdx === -1) return;
            const item = items[selectedItemIdx];

            if(userMoney < item.price) {
                alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                return;
            }

            if(!confirm(`${item.price}Gë¥¼ ì‚¬ìš©í•˜ì—¬ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // ëˆ ì°¨ê°
            database.ref(`users/${myID}/money`).set(userMoney - item.price);

            // â˜… ë°”ë¡œ ì‹œì‘í•˜ì§€ ì•Šê³  ì¹´ìš´íŠ¸ë‹¤ìš´ í•¨ìˆ˜ í˜¸ì¶œ
            startCountdown();
        }

        function startCountdown() {
            const overlay = document.getElementById('msgOverlay');
            const title = document.getElementById('msgTitle');
            const desc = document.getElementById('msgDesc');
            const btn = document.getElementById('startBtn');

            // 1. UI ì¤€ë¹„ (ë²„íŠ¼ ìˆ¨ê¸°ê³ , ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤€ë¹„)
            btn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¹€
            desc.innerText = "SYSTEM BREACHING...";
            desc.style.color = "#0f0";
            
            let count = 5;
            title.innerText = count;
            title.style.fontSize = "100px"; // ìˆ«ì í¬ê²Œ!
            title.style.color = "#fff";

            // 2. 1ì´ˆë§ˆë‹¤ ìˆ«ì ì¤„ì´ê¸°
            const timer = setInterval(() => {
                count--;
                
                if (count > 0) {
                    title.innerText = count;
                } else if (count === 0) {
                    title.innerText = "HACK!";
                    title.style.color = "#ff0000"; // ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ê°•ì¡°
                    title.style.textShadow = "0 0 20px red";
                } else {
                    // 3. ì¹´ìš´íŠ¸ë‹¤ìš´ ë! ê²Œì„ ì‹œì‘
                    clearInterval(timer);
                    
                    // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                    overlay.style.display = 'none';
                    
                    // ìŠ¤íƒ€ì¼ ì›ìƒë³µêµ¬ (ë‹¤ìŒ ê²Œì„ì„ ìœ„í•´)
                    title.style.fontSize = "30px"; 
                    title.style.textShadow = "none";
                    desc.style.color = "#aaa";

                    // â˜… ì§„ì§œ ê²Œì„ ë¡œì§ ì‹¤í–‰
                    initGameAndLoop();
                }
            }, 1000); // 1ì´ˆ ê°„ê²©
        }

        // ê²Œì„ ì‹œì‘ (ì¹´ìš´íŠ¸ë‹¤ìš´ ì§í›„ ì‹¤í–‰ë¨)
        function initGameAndLoop() {
            const item = items[selectedItemIdx];
            
            isPlaying = true;
            score = 0;
            hp = 100;
            frameCount = 0;
            nextSpawnAt = 0;
            notes = [];
            
            // ê¸°ì¡´ ë…¸íŠ¸ ì œê±°
            document.querySelectorAll('.note').forEach(el => el.remove()); 
            
            document.getElementById('scoreVal').innerText = "0";
            document.getElementById('targetVal').innerText = item.target;
            updateHP();

            // â˜… [ìˆ˜ì •ëœ ìŒì•… ì¬ìƒ ë¡œì§]
            const audio = document.getElementById('bgmPlayer');
            const volSlider = document.getElementById('volSlider'); // ìŠ¬ë¼ì´ë” ê°€ì ¸ì˜¤ê¸°

            if (item.audio) {
                audio.src = item.audio; 
                audio.volume = volSlider.value; // [ìˆ˜ì •] í˜„ì¬ ìŠ¬ë¼ì´ë” ê°’ìœ¼ë¡œ ë³¼ë¥¨ ì„¤ì •
                
                audio.play().catch(e => console.log("ìŒì•… ì¬ìƒ ì‹¤íŒ¨:", e));
            }

            gameLoop();
        }

        // ë©”ì¸ ê²Œì„ ë£¨í”„ (BPM ì ìš©ë¨)
        function gameLoop() {
            if(!isPlaying) return;

            const item = items[selectedItemIdx];
            frameCount++;

            // â˜… [í•µì‹¬] BPM ê¸°ë°˜ ë…¸íŠ¸ ìƒì„± íƒ€ì´ë° ê³„ì‚°
            // 60FPS ê¸°ì¤€: 1ì´ˆì— 60í”„ë ˆì„
            // BPM(ë¶„ë‹¹ ë°•ììˆ˜)ì„ í”„ë ˆì„ ê°„ê²©ìœ¼ë¡œ ë³€í™˜: (60ì´ˆ * 60í”„ë ˆì„) / BPM
            // ì˜ˆ: BPM 120ì´ë©´ 30í”„ë ˆì„ë§ˆë‹¤(0.5ì´ˆë§ˆë‹¤) ë…¸íŠ¸ ìƒì„±
            const framesPerBeat = 3600 / item.bpm; 

            // ë…¸íŠ¸ ìƒì„± ì‹œê°„ì¸ê°€?
            if (frameCount >= nextSpawnAt) {
                // 1. ë…¸íŠ¸ ìƒì„±
                const firstLane = spawnNote();

                // 2. [ì–´ë ¤ì›€] BPM 130 ì´ìƒì´ë©´ í™•ë¥ ì ìœ¼ë¡œ ë™ì‹œ ì¹˜ê¸°
                if (item.bpm >= 30 && Math.random() < 0.3) {
                    spawnNote(firstLane);
                }

                // 3. [ë¦¬ë“¬ ë³€ì¹™] ë‹¤ìŒ ë…¸íŠ¸ê°€ ë‚˜ì˜¬ ì‹œê°„ ê³„ì‚°
                // ê¸°ë³¸ì ìœ¼ë¡œ '1ë°•ì' ë’¤ì— ë‚˜ì˜¤ì§€ë§Œ, ê°€ë” 'ë°˜ë°•ì(0.5)' ë¹ ë¥´ê²Œ ë‚˜ì˜´
                let rhythmFactor = 1; 

                // BPMì´ ë†’ì„ìˆ˜ë¡ ì—‡ë°•ì(ë°˜ë°•ì) í™•ë¥  ì¦ê°€
                if (Math.random() < 0.3) {
                    rhythmFactor = 0.5; // ë°˜ë°•ì (8ë¶„ìŒí‘œ)
                }

                // ë‹¤ìŒ ì†Œí™˜ ì‹œê°„ ì˜ˆì•½
                nextSpawnAt = frameCount + (framesPerBeat * rhythmFactor);
            }

            // --- ì•„ë˜ëŠ” ê¸°ì¡´ ë…¸íŠ¸ ì´ë™ ë¡œì§ê³¼ ë™ì¼ ---
            for (let i = notes.length - 1; i >= 0; i--) {
                const note = notes[i];
                note.y += item.speed; // ë–¨ì–´ì§€ëŠ” ì†ë„ëŠ” ì•„ì´í…œë³„ speed ì„¤ì • ë”°ë¦„
                note.el.style.top = note.y + "px";

                const containerH = document.getElementById('laneContainer').clientHeight;
                
                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°”ì„ ë•Œ ì²˜ë¦¬
                if (note.y > containerH) {
                    if (note.hit) {
                        note.el.remove();
                        notes.splice(i, 1);
                    } else {
                        showJudge("MISS", "#555");
                        hp -= 10; 
                        updateHP();
                        note.el.remove();
                        notes.splice(i, 1);
                        checkGameOver();
                    }
                }
            }

            animationFrame = requestAnimationFrame(gameLoop);
        }

        // ë…¸íŠ¸ ìƒì„± í•¨ìˆ˜ (ìŠ¤í‚¨ ì ìš© ë²„ì „)
        function spawnNote(laneIdx = null) {
            // 1. ë ˆì¸ ëœë¤ ì„ íƒ (ë§Œì•½ laneIdxê°€ nullì´ë©´ ëœë¤, ìˆ«ìê°€ ì˜¤ë©´ ê·¸ ë ˆì¸ ì œì™¸í•˜ê³  ë½‘ê¸°)
            // ê¸°ì¡´ ì½”ë“œì˜ 'excludeLane' ê¸°ëŠ¥ì„ 'laneIdx' íŒŒë¼ë¯¸í„°ë¡œ í†µí•©í•´ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            
            let targetLane;
            
            if (laneIdx === null) {
                // ì™„ì „íˆ ëœë¤
                targetLane = Math.floor(Math.random() * 4);
            } else {
                // íŠ¹ì • ë ˆì¸ ì œì™¸í•˜ê³  ëœë¤ (ë™ì‹œì¹˜ê¸°ìš©)
                do {
                    targetLane = Math.floor(Math.random() * 4);
                } while (targetLane === laneIdx);
            }

            const laneEl = document.getElementById(`lane${targetLane}`);
            const note = document.createElement('div');
            
            // â˜… [í•µì‹¬] ìŠ¤í‚¨ ì ìš©: note í´ë˜ìŠ¤ì™€ í•¨ê»˜ ìŠ¤í‚¨ í´ë˜ìŠ¤(currentSkin) ì¶”ê°€
            // lane-0, lane-1 ë“±ì€ ìƒ‰ìƒ êµ¬ë¶„ì„ ìœ„í•´ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.
            note.className = `note lane-${targetLane} ${currentSkin}`; 
            
            // ì´ˆê¸° ìœ„ì¹˜
            note.style.top = "-20px"; 
            
            // í™”ë©´ì— ì¶”ê°€
            laneEl.appendChild(note);
            
            // ê²Œì„ ë¡œì§ ë°°ì—´ì— ì¶”ê°€
            notes.push({
                el: note,
                lane: targetLane,
                y: -20,
                hit: false
            });

            return targetLane; // ìƒì„±ëœ ë ˆì¸ ë²ˆí˜¸ ë°˜í™˜ (ë‹¤ìŒ ë…¸íŠ¸ê°€ í”¼í•  ìˆ˜ ìˆê²Œ)
        }

        function handleKeyDown(e) {
            if(!isPlaying) return;
            const key = e.key.toLowerCase();
            if(KEY_MAP.hasOwnProperty(key)) {
                const lane = KEY_MAP[key];
                
                // í‚¤ ëˆ„ë¦„ ì‹œê°ì  íš¨ê³¼
                document.getElementById(`key${lane}`).classList.add('active');
                document.getElementById(`eff${lane}`).classList.add('flash');
                setTimeout(() => document.getElementById(`eff${lane}`).classList.remove('flash'), 100);

                checkHit(lane);
            }
        }

        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            if(KEY_MAP.hasOwnProperty(key)) {
                document.getElementById(`key${KEY_MAP[key]}`).classList.remove('active');
            }
        }

        function checkHit(lane) {
            // í•´ë‹¹ ë ˆì¸ì— ìˆëŠ” ë…¸íŠ¸ ì¤‘, íŒì •ì„  ê·¼ì²˜ì— ìˆëŠ” ê°€ì¥ ì•„ë˜ìª½ ë…¸íŠ¸ ì°¾ê¸°
            // íŒì •ì„  ìœ„ì¹˜: bottom 50px. ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ top ì¢Œí‘œ ê³„ì‚° í•„ìš”.
            const containerH = document.getElementById('laneContainer').clientHeight;
            const targetY = containerH - 50 - 10; // íŒì •ì„  yì¢Œí‘œ (ëŒ€ëµì )

            // íŒì • ë²”ìœ„ (í”½ì…€)
            const PER_RANGE = 30; 
            const GOOD_RANGE = 60;
            const BAD_RANGE = 90;

            // í•´ë‹¹ ë ˆì¸ì˜ ë…¸íŠ¸ í•„í„°ë§
            const targetNotes = notes.filter(n => n.lane === lane && !n.hit);
            
            // ê°€ì¥ ì•„ë˜ì— ìˆëŠ” ë…¸íŠ¸ ì°¾ê¸° (yê°’ì´ ê°€ì¥ í° ê²ƒ)
            if(targetNotes.length === 0) return;
            
            // ì •ë ¬ (y ë‚´ë¦¼ì°¨ìˆœ)
            targetNotes.sort((a, b) => b.y - a.y);
            const note = targetNotes[0]; // íƒ€ê²Ÿ ë…¸íŠ¸

            const diff = Math.abs(targetY - note.y);

            if (diff < BAD_RANGE) {
                note.hit = true;
                note.el.style.opacity = 0; // ìˆ¨ê¹€ ì²˜ë¦¬ (ë‚˜ì¤‘ì— ë£¨í”„ì—ì„œ ì œê±°ë¨)
                
                if (diff < PER_RANGE) {
                    score += 100;
                    showJudge("PERFECT", "#0ff");
                    hp = Math.min(100, hp + 2); // í
                } else if (diff < GOOD_RANGE) {
                    score += 50;
                    showJudge("GOOD", "#0f0");
                    hp = Math.min(100, hp + 1);
                } else {
                    score += 10;
                    showJudge("BAD", "#ff0");
                }
                
                document.getElementById('scoreVal').innerText = score;
                updateHP();
                checkWin();
            }
        }

        function showJudge(text, color) {
            const el = document.getElementById('judgeDisplay');
            el.innerText = text;
            el.style.color = color;
            el.style.opacity = 1;
            el.style.transform = "scale(1.2)";
            
            // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ trick
            setTimeout(() => {
                el.style.transform = "scale(1)";
                el.style.opacity = 0;
            }, 300);
        }

        function updateHP() {
            const bar = document.getElementById('hpVal');
            bar.style.width = hp + "%";
            if(hp < 30) bar.style.background = "red";
            else bar.style.background = "#0f0";
        }

        function checkGameOver() {
            if (hp <= 0) {
                endGame(false);
            }
        }

        function checkWin() {
            const item = items[selectedItemIdx];
            if (score >= item.target) {
                endGame(true);
            }
        }

        // ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ (ìŒì•… ë„ê¸° ì¶”ê°€)
        function endGame(isWin) {
            isPlaying = false;
            cancelAnimationFrame(animationFrame);
            
            // â˜… [ìŒì•… ì •ì§€]
            const audio = document.getElementById('bgmPlayer');
            audio.pause();
            audio.currentTime = 0; // ìŒì•… ì²˜ìŒìœ¼ë¡œ ë˜ê°ê¸°

            const overlay = document.getElementById('msgOverlay');
            const title = document.getElementById('msgTitle');
            const desc = document.getElementById('msgDesc');
            const btn = document.getElementById('startBtn');

            overlay.style.display = 'flex';
            btn.style.display = 'inline-block'; 
            
            if (isWin) {
                title.innerText = "HACKING SUCCESS!";
                title.style.color = "#0f0";
                desc.innerText = `ëª©í‘œ ì ìˆ˜ ë‹¬ì„±! ë³´ìƒì„ íšë“í•©ë‹ˆë‹¤.`;
                btn.innerText = "ë³´ìƒ ìˆ˜ë ¹";
                btn.onclick = () => giveReward();
            } else {
                title.innerText = "SYSTEM FAILURE";
                title.style.color = "#f00";
                desc.innerText = `HPê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                btn.innerText = "ë‹¤ì‹œ ì‹œë„";
                btn.onclick = () => startGame(); 
            }
        }

        function giveReward() {
            const item = items[selectedItemIdx];
            // í™•ë¥ ì ìœ¼ë¡œ ì—‰ëš±í•œ ë¬¼ê±´ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            let rewardItem = item;
            let msg = `[${item.name}] íšë“!`;

            if (Math.random() < 0.1) { // 10% í™•ë¥ ë¡œ ê½
                const randIdx = Math.floor(Math.random() * items.length);
                rewardItem = items[randIdx];
                msg = `âš ï¸ ì˜¤ë¥˜ ë°œìƒ! ì—‰ëš±í•œ ë¬¼ê±´ [${rewardItem.name}] íšë“...`;
            }

            // ì¸ë²¤í† ë¦¬ ì €ì¥
            const inv = JSON.parse(localStorage.getItem("myInventory") || "{}");
            inv[rewardItem.name] = (inv[rewardItem.name] || 0) + 1;
            inv[rewardItem.name + "_price"] = rewardItem.price;
            inv[rewardItem.name + "_icon"] = rewardItem.emoji;
            localStorage.setItem("myInventory", JSON.stringify(inv));

            alert(msg);
            location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì´ˆê¸°í™”
        }

        function logout() { localStorage.clear(); location.href="index.html"; }
    </script>
</body>
</html>