<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜¤ì—¼ëœ ê°• ë‚šì‹œ</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
        authDomain: "cheongjuca.firebaseapp.com",
        databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
        projectId: "cheongjuca",
        storageBucket: "cheongjuca.firebasestorage.app",
        messagingSenderId: "455437421321",
        appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
        measurementId: "G-9XG7JRFM3D"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
    </script>

    <style>
        .game-container { width: 800px; margin: 50px auto; text-align: center; color: white; font-family: 'SchoolSafeBoardMarker'; }
        .status-bar { display: flex; justify-content: space-between; background: #222; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #555; font-size: 20px; }
        .river-box { width: 100%; height: 400px; background: linear-gradient(to bottom, #2b32b2, #1488cc); border: 4px solid #555; border-radius: 15px; position: relative; overflow: hidden; }
        #bobber { width: 30px; height: 30px; background: radial-gradient(circleAt 30% 30%, #ff4444, #8b0000); border: 2px solid white; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 10; }
        .floating { animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%, 100% { top: 50%; } 50% { top: 48%; } }
        .bite { top: 60% !important; border-color: yellow; box-shadow: 0 0 15px yellow; }
        
        /* ë¯¸ë‹ˆê²Œì„ UI ë° ê²½ê³  ì• ë‹ˆë©”ì´ì…˜ */
        #minigame-ui { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 340px; background: rgba(0,0,0,0.9); padding: 25px; border-radius: 15px; border: 3px solid gold; z-index: 20; transition: border-color 0.2s; }
        .gauge-container { width: 100%; height: 30px; background: #222; border-radius: 15px; position: relative; overflow: hidden; margin: 15px 0; border: 2px solid #444; }
        #target-zone { position: absolute; top: 0; left: 60%; width: 25%; height: 100%; background: rgba(0, 255, 0, 0.3); border-left: 2px solid #00ff00; border-right: 2px solid #00ff00; }
        #pointer { position: absolute; top: 0; left: 0%; width: 6px; height: 100%; background: white; box-shadow: 0 0 10px white; transition: left 0.05s linear; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(to right, #ab0000, #ff4e50); transition: width 0.1s; }

        @keyframes warning-flash {
            0% { border-color: gold; box-shadow: none; }
            50% { border-color: red; box-shadow: 0 0 20px red; }
            100% { border-color: gold; box-shadow: none; }
        }
        .ui-warning { animation: warning-flash 0.4s infinite; }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .action-btn { background: #ab0000; color: white; font-family: 'SchoolSafeBoardMarker'; font-size: 24px; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; flex: 1; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.95); }
        .stop-btn { background: #444; }

        /* ë¯¸ë¼ ì„ íƒì°½ ìŠ¤íƒ€ì¼ */
        #bait-selector { display:none; background:rgba(0,0,0,0.9); padding:20px; border-radius:15px; margin-bottom:15px; border:2px solid #555; }
        .bait-btn { background:#333; color:white; border:1px solid #555; padding:10px 20px; border-radius:8px; cursor:pointer; font-family:'SchoolSafeBoardMarker'; font-size:18px; flex:1; }
        .bait-btn:hover:not(:disabled) { border-color: #ab0000; background:#444; }
        .bait-btn:disabled { opacity:0.3; cursor:not-allowed; }
    </style>
</head>
<body class="game-page" style="background-color: #111;">

    <nav class="navbar">
        <div class="logo">OUT BREAK <span id="userBadge"></span></div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="shop.html">ìƒì </a></li>
            <li><a href="game.html">ë‚šì‹œí„°</a></li>
            <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>

    <div class="game-container">
        <div class="status-bar">
            <span>ğŸ‘¤ <span id="userNickDisplay">...</span></span>
            <span>ğŸ› ì¼ë°˜: <span id="baitCountNormal" style="color:#00ff00;">0</span> | ğŸª± ê³ ê¸‰: <span id="baitCountHigh" style="color:#ffcc00;">0</span></span>
        </div>

        <div class="river-box">
            <div id="bobber"></div>
            <div id="minigame-ui">
                <div id="ui-msg" style="font-size: 20px; margin-bottom: 10px; color: gold;">í˜ ëŒ€ê²° ì¤‘!</div>
                <div class="gauge-container">
                    <div id="target-zone"></div>
                    <div id="pointer"></div>
                </div>
                <div style="font-size: 14px; margin-bottom: 5px;">ì„±ê³µë„: <span id="percent-text">0</span>%</div>
                <div class="gauge-container" style="height: 12px; border: 1px solid #555;">
                    <div id="progress-bar"></div>
                </div>
                <div style="font-size: 11px; color: #888;">ë²„íŠ¼ì„ ê¾¹ ëˆ„ë¥´ë©´ ìš°ì¸¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤!</div>
            </div>
        </div>

        <div id="catch-display" style="font-size:80px; height:100px; margin-top:20px;">ğŸŸ</div>
        <div id="msg-box" style="font-size:22px; margin-bottom:20px; min-height: 30px;">ë‚šì‹¯ëŒ€ë¥¼ ë˜ì ¸ë³´ì„¸ìš”...</div>

        <div id="bait-selector">
            <div style="margin-bottom:15px; font-size:18px;">ì‚¬ìš©í•  ë¯¸ë¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="bait-btn" id="pick-normal" onclick="selectBait('normal')">ğŸ› ì¼ë°˜ ë¯¸ë¼</button>
                <button class="bait-btn" id="pick-high" onclick="selectBait('high')" style="border-color:#ffd700; color:#ffd700;">ğŸª± ê³ ê¸‰ ë¯¸ë¼</button>
            </div>
            <button onclick="toggleBaitSelector(false)" style="background:none; border:none; color:#888; margin-top:15px; cursor:pointer;">[ì·¨ì†Œ]</button>
        </div>

        <div class="btn-group">
            <button id="btn" class="action-btn" onmousedown="handlePress(true)" onmouseup="handlePress(false)" onmouseleave="handlePress(false)" ontouchstart="handlePress(true)" ontouchend="handlePress(false)">ë‚šì‹¯ëŒ€ ë˜ì§€ê¸°</button>
            <button class="action-btn stop-btn" onclick="stopFishing()">ì¤‘ë‹¨í•˜ê¸°</button>
        </div>
    </div>

    <script>
        const myNick = localStorage.getItem("userNick");
        document.getElementById('userNickDisplay').innerText = myNick;

        const bobber = document.getElementById('bobber');
        const btn = document.getElementById('btn');
        const msgBox = document.getElementById('msg-box');
        const minigameUI = document.getElementById('minigame-ui');
        const pointer = document.getElementById('pointer');
        const progressBar = document.getElementById('progress-bar');
        const percentText = document.getElementById('percent-text');
        const uiMsg = document.getElementById('ui-msg');
        const baitSelector = document.getElementById('bait-selector');

        let gameState = 'idle'; 
        let currentBait = 0, baitHigh = 0, rodLevel = 1; 
        let biteTimeout, failTimeout, gameLoop;
        let pointerPos = 0, catchProgress = 0, isPressing = false, failTimer = 0, selectedBaitType = null;

        // DB ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
        database.ref('users/' + myNick).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            currentBait = data.bait || 0;
            baitHigh = data.bait_high || 0;
            rodLevel = data.rod_level || 1; 
            document.getElementById('baitCountNormal').innerText = currentBait;
            document.getElementById('baitCountHigh').innerText = baitHigh;
        });

        // ë©”ì¸ ë²„íŠ¼ ì¡°ì‘ í•¸ë“¤ëŸ¬
        function handlePress(pressed) {
            isPressing = pressed;
            if (pressed) {
                if (gameState === 'idle' || gameState === 'result') {
                    toggleBaitSelector(true);
                } else if (gameState === 'bite') {
                    startMinigame();
                }
            }
        }

        function toggleBaitSelector(show) {
            baitSelector.style.display = show ? 'block' : 'none';
            btn.style.display = show ? 'none' : 'flex';
            document.getElementById('pick-normal').disabled = (currentBait <= 0);
            document.getElementById('pick-high').disabled = (baitHigh <= 0);
        }

        function selectBait(type) {
            selectedBaitType = type;
            toggleBaitSelector(false);
            castLine();
        }

        function castLine() {
            // ë¯¸ë¼ ì°¨ê° ë° ìƒíƒœ ì„¤ì •
            if (selectedBaitType === 'high') {
                if (baitHigh <= 0) return alert("ê³ ê¸‰ ë¯¸ë¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                database.ref('users/' + myNick).update({ bait_high: baitHigh - 1 });
                gameState = 'waiting_high';
            } else {
                if (currentBait <= 0) return alert("ì¼ë°˜ ë¯¸ë¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                database.ref('users/' + myNick).update({ bait: currentBait - 1 });
                gameState = 'waiting';
            }

            btn.style.display = 'flex';
            btn.innerText = "ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            bobber.style.display = "block";
            bobber.className = "floating";
            document.getElementById('catch-display').innerText = "";
            msgBox.innerText = "ì°Œë¥¼ ì£¼ì‹œí•˜ì„¸ìš”...";
            msgBox.style.color = "white";

            biteTimeout = setTimeout(() => {
                gameState = 'bite';
                bobber.className = "bite";
                msgBox.innerText = "ì§€ê¸ˆì´ì•¼!! ë‚šì•„ì±„!!";
                failTimeout = setTimeout(() => { 
                    if(gameState === 'bite') failFish("ë¬¼ê³ ê¸°ê°€ ë„ë§ê°”ìŠµë‹ˆë‹¤."); 
                }, 1000); 
            }, Math.random() * 3000 + 2000);
        }

        function startMinigame() {
    clearTimeout(failTimeout);
    const isHigh = (selectedBaitType === 'high');
    gameState = 'fighting';
    minigameUI.style.display = "block";
    minigameUI.classList.remove('ui-warning');
    
    pointerPos = 30; 
    catchProgress = 20; 
    failTimer = 0; 
    
    gameLoop = setInterval(() => {
        // 1. í¬ì¸í„° ì´ë™ (ë‚šì‹¯ëŒ€ ë ˆë²¨ ë³´ì •)
        let moveSpeed = rodLevel >= 2 ? 3.5 : 2.5; 
        if (isPressing) pointerPos += moveSpeed; else pointerPos -= 2.0;
        
        if (pointerPos < 0) pointerPos = 0; if (pointerPos > 100) pointerPos = 100;
        pointer.style.left = pointerPos + "%";

        // 2. íŒì • ë° ê²Œì´ì§€ ì¦ê° ë¡œì§ (ìˆœì„œ ë³€ê²½ ë° ì¡°ê±´ ìµœì í™”)
        if (pointerPos >= 60 && pointerPos <= 85) {
            // ì•ˆì „ ì˜ì—­: ê²Œì´ì§€ ìƒìŠ¹
            catchProgress += (rodLevel >= 2 ? 1.2 : 0.8);
            failTimer = 0; // ì•ˆì „ ì˜ì—­ì— ë“¤ì–´ì˜¤ë©´ ì¦‰ì‹œ íƒ€ì´ë¨¸ ë¦¬ì…‹
            
            minigameUI.style.borderColor = "#00ff00";
            minigameUI.classList.remove('ui-warning');
            uiMsg.innerText = "ë²„í‹°ëŠ” ì¤‘!"; 
            uiMsg.style.color = "#00ff00";
        } else {
            // ìœ„í—˜ ì˜ì—­: ê²Œì´ì§€ í•˜ë½
            catchProgress -= 0.5;
            minigameUI.style.borderColor = "gold";
        }

        // 3. ë†“ì¹¨ ì‹œìŠ¤í…œ (ê²½ê³  ë°œìƒ ì¡°ê±´ ê°•í™”)
        // ê²Œì´ì§€ê°€ ë°”ë‹¥ì¼ ë•Œë§Œ íƒ€ì´ë¨¸ê°€ ì‘ë™í•˜ë„ë¡ else if êµ¬ì¡°ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        if (catchProgress <= 0) {
            catchProgress = 0; // ìµœì†Œê°’ ê³ ì •
            failTimer += 30;   // 0%ì¼ ë•Œë§Œ íƒ€ì´ë¨¸ ëˆ„ì 
            
            minigameUI.classList.add('ui-warning'); 
            uiMsg.innerText = "âš ï¸ í…ì…˜ ìœ„í—˜!!"; 
            uiMsg.style.color = "red";
        } else if (catchProgress <= 10) {
            // ê²Œì´ì§€ê°€ ë‚®ì„ ë•Œ ì‹œê°ì  ê²½ê³ ë§Œ í‘œì‹œ (íƒ€ì´ë¨¸ëŠ” ì‘ë™ X)
            minigameUI.classList.add('ui-warning');
            uiMsg.innerText = "âš ï¸ ì£¼ì˜!";
        }

        // 4. ê²Œì„ ì¢…ë£Œ ì¡°ê±´ ì²´í¬
        if (failTimer >= 2000) { 
            failFish("ì¤„ì´ ë„ˆë¬´ ëŠìŠ¨í•´ ë¬¼ê³ ê¸°ê°€ ë°”ëŠ˜ì„ í„¸ê³  ë„ë§ê°”ìŠµë‹ˆë‹¤!");
            return;
        }

        if (catchProgress >= 100) {
            catchProgress = 100;
            winFish(isHigh);
            return;
        }

        // UI ë°˜ì˜
        progressBar.style.width = catchProgress + "%";
        percentText.innerText = Math.floor(catchProgress);
    }, 30);
}

        function winFish(isHigh) {
            clearInterval(gameLoop);
            gameState = 'result';
            minigameUI.style.display = "none";
            bobber.style.display = "none";
            
            const rand = Math.random();
            let item = { name: "ì‘ì€ í”¼ë¼ë¯¸", icon: "ğŸ ", price: 20 };
            
            // ë¯¸ë¼ ì¢…ë¥˜ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤ í™•ë¥ 
            let luck = isHigh ? 0.2 : 0;
            if (rand < (0.1 + luck)) item = { name: "í†µì¡°ë¦¼ ë°•ìŠ¤", icon: "ğŸ¥«", price: 100 };
            else if (rand < (0.3 + luck)) item = { name: "ë°©ì‚¬ëŠ¥ ì†¡ì–´", icon: "ğŸŸ", price: 50 };

            database.ref('users/' + myNick + '/inventory').push(item);
            
            // íŒì—… ì•Œë¦¼ì°½
            alert(`ğŸŠ ë‚šì‹œ ì„±ê³µ! \n\n[${item.name}]ì„(ë¥¼) ë‚šì•˜ìŠµë‹ˆë‹¤. \nê°€ë°©ì„ í™•ì¸í•´ë³´ì„¸ìš”!`);

            msgBox.innerText = `ë°©ê¸ˆ ì¡ì€ ë¬¼ê±´: ${item.name}`;
            msgBox.style.color = "#00ff00";
            document.getElementById('catch-display').innerText = item.icon;
            btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
        }

        function failFish(txt) {
            clearInterval(gameLoop);
            gameState = 'result';
            minigameUI.style.display = "none";
            bobber.style.display = "none";
            msgBox.innerText = txt;
            msgBox.style.color = "#ff4444";
            btn.innerText = "ë‹¤ì‹œ ì‹œë„";
        }

        function stopFishing() {
            if (gameState === 'waiting' || gameState === 'waiting_high' || gameState === 'bite' || gameState === 'fighting') {
                if (confirm("ì´ë¯¸ ë¯¸ë¼ë¥¼ ë˜ì§„ ìƒíƒœì…ë‹ˆë‹¤. ì§€ê¸ˆ ì¤‘ë‹¨í•˜ë©´ ë¯¸ë¼ë¥¼ ëŒë ¤ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    if (gameLoop) clearInterval(gameLoop);
                    location.href = "shop.html";
                }
            } else {
                location.href = "shop.html";
            }
        }
    </script>
</body>
</html>