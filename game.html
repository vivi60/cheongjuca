<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜¤ì—¼ëœ ê°• ë‚šì‹œ</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
        authDomain: "cheongjuca.firebaseapp.com",
        databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
        projectId: "cheongjuca",
        storageBucket: "cheongjuca.firebasestorage.app",
        messagingSenderId: "455437421321",
        appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
        measurementId: "G-9XG7JRFM3D"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
    </script>

    <style>
        .game-container {
            width: 800px;
            margin: 50px auto;
            text-align: center;
            color: white;
            font-family: 'SchoolSafeBoardMarker';
        }
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ìƒë‹¨ ì •ë³´ì°½ ì¶”ê°€ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #222;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #555;
            font-size: 20px;
        }

        .river-box {
            width: 100%; height: 400px;
            background: linear-gradient(to bottom, #2b32b2, #1488cc);
            border: 4px solid #555; border-radius: 15px;
            position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: pointer;
        }
        .wave {
            position: absolute; bottom: 0; left: 0; width: 200%; height: 100px;
            background: rgba(255, 255, 255, 0.1);
            animation: waveMove 5s linear infinite;
            border-radius: 40%; transform: translateY(50%);
        }
        @keyframes waveMove {
            0% { transform: translateX(0) translateY(50%) rotate(0deg); }
            50% { transform: translateX(-25%) translateY(45%) rotate(2deg); }
            100% { transform: translateX(-50%) translateY(50%) rotate(0deg); }
        }
        #bobber {
            width: 30px; height: 30px;
            background: radial-gradient(circleAt 30% 30%, #ff4444, #8b0000);
            border: 2px solid white; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; z-index: 10; transition: top 0.2s;
        }
        .floating { animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%, 100% { top: 50%; } 50% { top: 48%; } }
        .bite { top: 60% !important; border-color: yellow; box-shadow: 0 0 15px yellow; }
        
        #catch-display { font-size: 80px; margin: 20px; height: 100px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        #msg-box { font-size: 24px; height: 30px; color: #ddd; margin-bottom: 20px; }

        .btn-group { display: flex; gap: 10px; justify-content: center; }
        .action-btn {
            background: #ab0000; color: white;
            font-family: 'SchoolSafeBoardMarker'; font-size: 24px;
            padding: 15px 30px; border: none; border-radius: 10px;
            cursor: pointer; transition: 0.2s; flex: 1;
        }
        .action-btn:hover { background: #ff0000; }
        .stop-btn { background: #555; }
        .stop-btn:hover { background: #777; }
    </style>
</head>
<body class="game-page" style="background-color: #111;">

    <nav class="navbar">
        <div class="logo">OUT BREAK</div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="shop.html">ìƒì </a></li> 
            <li><a href="game.html">ë‚šì‹œí„°</a></li>
            <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>

    <div class="game-container">
        <div class="status-bar">
            <span>ğŸ‘¤ <span id="userNickDisplay">ìƒì¡´ì</span></span>
            <span>ğŸ› ë¯¸ë¼: <span id="baitCount" style="color:#00ff00;">0</span>ê°œ</span>
        </div>

        <h1 style="color:#ab0000;">ğŸ£ ì˜¤ì—¼ëœ ê°• ë‚šì‹œí„°</h1>
        
        <div class="river-box" onclick="tryPull()">
            <div id="bobber"></div>
            <div class="wave"></div>
            <div class="wave" style="animation-delay: -2s; opacity: 0.5;"></div>
        </div>

        <div id="catch-display">ğŸŸ</div>
        <div id="msg-box">ë¯¸ë¼ë¥¼ ë¼ìš°ê³  ë˜ì ¸ë³´ì„¸ìš”...</div>

        <div class="btn-group">
            <button id="btn" class="action-btn" onclick="handleBtn()">ë‚šì‹¯ëŒ€ ë˜ì§€ê¸°</button>
            <button class="action-btn stop-btn" onclick="stopFishing()">ë‚šì‹œ ì¤‘ë‹¨ (ìƒì ìœ¼ë¡œ)</button>
        </div>
    </div>

    <script>
        const myNick = localStorage.getItem("userNick");
        if(!myNick) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='index.html'; }
        document.getElementById('userNickDisplay').innerText = myNick;

        const bobber = document.getElementById('bobber');
        const btn = document.getElementById('btn');
        const msgBox = document.getElementById('msg-box');
        const catchDisplay = document.getElementById('catch-display');
        const baitDisplay = document.getElementById('baitCount');

        let gameState = 'idle'; 
        let biteTimeout, failTimeout;
        let currentBait = 0;

        // 1. DBì—ì„œ ë‚´ ì •ë³´(ë¯¸ë¼) ì‹¤ì‹œê°„ ê°ì‹œ
        database.ref('users/' + myNick).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            // ë¯¸ë¼ê°€ ì—†ìœ¼ë©´ 0ê°œ, ìˆìœ¼ë©´ ê·¸ ê°œìˆ˜
            currentBait = data.bait || 0;
            baitDisplay.innerText = currentBait;
        });

        // 2. ë²„íŠ¼ í•¸ë“¤ëŸ¬
        function handleBtn() {
            if (gameState === 'idle' || gameState === 'result') {
                castLine();
            } else if (gameState === 'waiting' || gameState === 'bite') {
                tryPull();
            }
        }

        // 3. ë‚šì‹¯ëŒ€ ë˜ì§€ê¸° (ë¯¸ë¼ ì†Œëª¨)
        function castLine() {
            if (currentBait <= 0) {
                alert("ë¯¸ë¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! ìƒì ì—ì„œ ì§€ë ì´ë¥¼ ì‚¬ì˜¤ì„¸ìš”.");
                location.href = "shop.html";
                return;
            }

            // ë¯¸ë¼ 1ê°œ ì°¨ê° (DB ì—…ë°ì´íŠ¸)
            database.ref('users/' + myNick).update({
                bait: currentBait - 1
            });

            gameState = 'waiting';
            btn.innerText = "ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            btn.style.background = "#555"; 
            msgBox.innerText = "ì°Œë¥¼ ì£¼ì‹œí•˜ì„¸ìš”...";
            catchDisplay.innerText = "";
            
            bobber.style.display = "block";
            bobber.classList.remove('bite');
            bobber.classList.add('floating');

            const waitTime = Math.random() * 4000 + 2000;
            biteTimeout = setTimeout(fishBite, waitTime);
        }

        // 4. ì…ì§ˆ
        function fishBite() {
            if (gameState !== 'waiting') return;
            gameState = 'bite';
            bobber.classList.remove('floating');
            bobber.classList.add('bite');
            msgBox.innerText = "ì§€ê¸ˆì´ì•¼! ë‹¹ê²¨!!";
            msgBox.style.color = "yellow";
            btn.innerText = "ë‚šì•„ì±„ê¸°! (í´ë¦­)";
            btn.style.background = "#ab0000";

            failTimeout = setTimeout(() => {
                if (gameState === 'bite') failFish();
            }, 800); 
        }

        // 5. ë‹¹ê¸°ê¸° ì‹œë„
        function tryPull() {
            if (gameState === 'waiting') {
                clearTimeout(biteTimeout);
                failEarly();
            } else if (gameState === 'bite') {
                clearTimeout(failTimeout);
                successCatch();
            }
        }

        // 6. ì„±ê³µ: ì•„ì´í…œ íšë“ ë° DB ì €ì¥
        function successCatch() {
            gameState = 'result';
            bobber.style.display = "none";

            // ì•„ì´í…œ í™•ë¥  í…Œì´ë¸”
            const rand = Math.random();
            let itemName = "";
            let icon = "";
            let price = 0;

            if (rand < 0.05) { itemName = "í†µì¡°ë¦¼ ë°•ìŠ¤"; icon = "ğŸ¥«"; price = 100; }
            else if (rand < 0.20) { itemName = "ë°©ì‚¬ëŠ¥ ì†¡ì–´"; icon = "ğŸŸ"; price = 50; }
            else if (rand < 0.60) { itemName = "ì‘ì€ í”¼ë¼ë¯¸"; icon = "ğŸ "; price = 20; }
            else if (rand < 0.85) { itemName = "ì©ì€ ì¥í™”"; icon = "ğŸ‘¢"; price = 5; }
            else { itemName = "ì¢€ë¹„ ì†ëª©"; icon = "ğŸ§Ÿ"; price = 0; }

            msgBox.innerText = `${itemName} íšë“!`;
            msgBox.style.color = "#00ff00";
            catchDisplay.innerText = icon;
            btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
            
            // â˜… í•µì‹¬: DB ì¸ë²¤í† ë¦¬ì— ì•„ì´í…œ ì¶”ê°€
            const newItem = {
                name: itemName,
                icon: icon,
                price: price,
                date: new Date().toLocaleString()
            };
            
            database.ref('users/' + myNick + '/inventory').push(newItem);
        }

        // 7. ì‹¤íŒ¨ ì²˜ë¦¬ë“¤
        function failEarly() {
            gameState = 'result';
            bobber.style.display = "none";
            msgBox.innerText = "ë„ˆë¬´ ë¹¨ëì–´! ë¬¼ê³ ê¸°ê°€ ë„ë§ê°.";
            msgBox.style.color = "#888";
            catchDisplay.innerText = "ğŸ’¨";
            btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
            btn.style.background = "#ab0000";
        }
        function failFish() {
            gameState = 'result';
            bobber.style.display = "none";
            msgBox.innerText = "ë†“ì³¤ë‹¤... ë¯¸ë¼ë§Œ ë‚ ë ¸êµ°.";
            msgBox.style.color = "#888";
            catchDisplay.innerText = "âŒ";
            btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
            btn.style.background = "#ab0000";
        }

        function stopFishing() {
            if(confirm("ë‚šì‹œë¥¼ ê·¸ë§Œí•˜ê³  ìƒì ìœ¼ë¡œ ì´ë™í• ê¹Œìš”?")) {
                location.href = "shop.html";
            }
        }
    </script>
</body>
</html>