<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜¤ì—¼ëœ ê°• ë‚šì‹œ</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
        authDomain: "cheongjuca.firebaseapp.com",
        databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
        projectId: "cheongjuca",
        storageBucket: "cheongjuca.firebasestorage.app",
        messagingSenderId: "455437421321",
        appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
        measurementId: "G-9XG7JRFM3D"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
    </script>

    <style>
        .game-container { width: 800px; margin: 50px auto; text-align: center; color: white; font-family: 'SchoolSafeBoardMarker'; }
        .status-bar { display: flex; justify-content: space-between; background: #222; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #555; font-size: 20px; }
        .river-box { width: 100%; height: 400px; background: linear-gradient(to bottom, #2b32b2, #1488cc); border: 4px solid #555; border-radius: 15px; position: relative; overflow: hidden; cursor: crosshair; }
        #bobber { width: 30px; height: 30px; background: radial-gradient(circleAt 30% 30%, #ff4444, #8b0000); border: 2px solid white; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 10; }
        .floating { animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%, 100% { top: 50%; } 50% { top: 48%; } }
        .bite { top: 60% !important; border-color: yellow; box-shadow: 0 0 20px yellow; }
        
        #minigame-ui { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 340px; background: rgba(0,0,0,0.95); padding: 25px; border-radius: 15px; border: 3px solid gold; z-index: 20; }
        .gauge-container { width: 100%; height: 30px; background: #222; border-radius: 15px; position: relative; overflow: hidden; margin: 15px 0; border: 2px solid #444; }
        #target-zone { position: absolute; top: 0; left: 60%; width: 25%; height: 100%; background: rgba(0, 255, 0, 0.3); border-left: 2px solid #00ff00; border-right: 2px solid #00ff00; }
        #pointer { position: absolute; top: 0; left: 0%; width: 6px; height: 100%; background: white; box-shadow: 0 0 10px white; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(to right, #ab0000, #ff4e50); transition: width 0.1s; }

        @keyframes warning-flash {
            0% { border-color: gold; }
            50% { border-color: red; box-shadow: 0 0 20px red; }
            100% { border-color: gold; }
        }
        .ui-warning { animation: warning-flash 0.4s infinite; }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .action-btn { background: #ab0000; color: white; font-family: 'SchoolSafeBoardMarker'; font-size: 24px; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; flex: 1; transition: 0.2s; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .stop-btn { background: #444; }

        #bait-selector { display:none; background:rgba(0,0,0,0.9); padding:20px; border-radius:15px; margin-bottom:15px; border:2px solid #555; }
        .bait-btn { background:#333; color:white; border:1px solid #555; padding:10px 20px; border-radius:8px; cursor:pointer; font-family:'SchoolSafeBoardMarker'; font-size:18px; flex:1; }
        .bait-btn:hover:not(:disabled) { border-color: #ab0000; background:#444; }
    </style>
</head>
<body class="game-page" style="background-color: #111;">

    <nav class="navbar">
        <div class="logo">OUT BREAK <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;"></span></div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="shop.html">ìƒì </a></li>
            <li><a href="game.html">ë‚šì‹œí„°</a></li>
            <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>

    <div class="game-container">
        <div class="status-bar">
            <span>ğŸ‘¤ <span id="userNickDisplay">...</span></span>
            <span>ğŸ› ì¼ë°˜: <span id="baitCountNormal" style="color:#00ff00;">0</span> | ğŸª± ê³ ê¸‰: <span id="baitCountHigh" style="color:#ffcc00;">0</span></span>
        </div>

        <div class="river-box" onclick="handleRiverClick()">
            <div id="bobber"></div>
            <div id="minigame-ui">
                <div id="ui-msg" style="font-size: 20px; margin-bottom: 10px; color: gold;">í˜ ëŒ€ê²° ì¤‘!</div>
                <div class="gauge-container">
                    <div id="target-zone"></div>
                    <div id="pointer"></div>
                </div>
                <div style="font-size: 14px; margin-bottom: 5px;">ì„±ê³µë„: <span id="percent-text">0</span>%</div>
                <div class="gauge-container" style="height: 12px; border: 1px solid #555;">
                    <div id="progress-bar"></div>
                </div>
                <div style="font-size: 11px; color: #888;">ë²„íŠ¼ì„ ê¾¹ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ í¬ì¸í„°ê°€ ìš°ì¸¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤!</div>
            </div>
        </div>

        <div id="catch-display" style="font-size:80px; height:100px; margin-top:20px;"></div>
        <div id="msg-box" style="font-size:22px; margin-bottom:20px; min-height: 30px;">ë‚šì‹¯ëŒ€ë¥¼ ë˜ì ¸ë³´ì„¸ìš”...</div>

        <div id="bait-selector">
            <div style="margin-bottom:15px; font-size:18px;">ì‚¬ìš©í•  ë¯¸ë¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="bait-btn" id="pick-normal" onclick="selectBait('normal')">ğŸ› ì¼ë°˜ ë¯¸ë¼</button>
                <button class="bait-btn" id="pick-high" onclick="selectBait('high')" style="border-color:#ffd700; color:#ffd700;">ğŸª± ê³ ê¸‰ ë¯¸ë¼</button>
            </div>
            <button onclick="toggleBaitSelector(false)" style="background:none; border:none; color:#888; margin-top:15px; cursor:pointer;">[ì·¨ì†Œ]</button>
        </div>

        <div class="btn-group">
            <button id="btn" class="action-btn" 
                onmousedown="handleMainBtn(true)" 
                onmouseup="handleMainBtn(false)"
                onmouseleave="handleMainBtn(false)"
                ontouchstart="handleMainBtn(true)" 
                ontouchend="handleMainBtn(false)">ë‚šì‹¯ëŒ€ ë˜ì§€ê¸°</button>
            <button class="action-btn stop-btn" onclick="stopFishing()">ì¤‘ë‹¨í•˜ê¸°</button>
        </div>
    </div>

    <script>
        const myNick = localStorage.getItem("userNick");
        document.getElementById('userNickDisplay').innerText = myNick;

        const bobber = document.getElementById('bobber');
        const btn = document.getElementById('btn');
        const msgBox = document.getElementById('msg-box');
        const minigameUI = document.getElementById('minigame-ui');
        const pointer = document.getElementById('pointer');
        const progressBar = document.getElementById('progress-bar');
        const percentText = document.getElementById('percent-text');
        const uiMsg = document.getElementById('ui-msg');
        const baitSelector = document.getElementById('bait-selector');

        let gameState = 'idle'; 
        let currentBait = 0, baitHigh = 0, rodLevel = 1; 
        let biteTimeout, failTimeout, gameLoop;
        let pointerPos = 0, catchProgress = 0, isPressing = false, failTimer = 0, selectedBaitType = null;

        // DB ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
        database.ref('users/' + myNick).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            currentBait = data.bait || 0;
            baitHigh = data.bait_high || 0;
            rodLevel = data.rod_level || 1; 
            document.getElementById('baitCountNormal').innerText = currentBait;
            document.getElementById('baitCountHigh').innerText = baitHigh;
        });

        // ìƒë‹¨ ë°°ì§€ ë…¸ì¶œ
        window.addEventListener('load', function() {
            const nick = localStorage.getItem("userNick");
            const status = localStorage.getItem("loginStatus");
            const badge = document.getElementById("userBadge");
            if (badge && nick) {
                if (status === "admin") { badge.innerText = `[ê´€ë¦¬ì ëª¨ë“œ]`; badge.style.color = "#ff0000"; }
                else { badge.innerText = `[${nick}]`; badge.style.color = "#cccccc"; }
                badge.style.display = "inline";
            }
        });

        // í†µí•© ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ëˆŒë €ì„ ë•Œ ë™ì‘)
        function handleMainBtn(pressed) {
            isPressing = pressed;
            if (pressed) {
                if (gameState === 'idle' || gameState === 'result') {
                    toggleBaitSelector(true);
                } else if (gameState === 'bite') {
                    startMinigame();
                }
            }
        }

        // ê°•ë¬¼ í´ë¦­ ì‹œì—ë„ ë‚šì•„ì±„ê¸° í—ˆìš©
        function handleRiverClick() {
            if (gameState === 'bite') startMinigame();
        }

        function toggleBaitSelector(show) {
            baitSelector.style.display = show ? 'block' : 'none';
            btn.style.display = show ? 'none' : 'flex';
            document.getElementById('pick-normal').disabled = (currentBait <= 0);
            document.getElementById('pick-high').disabled = (baitHigh <= 0);
        }

        function selectBait(type) {
            selectedBaitType = type;
            toggleBaitSelector(false);
            castLine();
        }

        function castLine() {
            if (selectedBaitType === 'high') {
                if (baitHigh <= 0) return alert("ê³ ê¸‰ ë¯¸ë¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                database.ref('users/' + myNick).update({ bait_high: baitHigh - 1 });
                gameState = 'waiting_high';
            } else {
                if (currentBait <= 0) return alert("ì¼ë°˜ ë¯¸ë¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                database.ref('users/' + myNick).update({ bait: currentBait - 1 });
                gameState = 'waiting';
            }

            btn.style.display = 'flex';
            btn.innerText = "ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            btn.style.background = "#444";
            bobber.style.display = "block";
            bobber.className = "floating";
            document.getElementById('catch-display').innerText = "";
            msgBox.innerText = "ì°Œë¥¼ ì£¼ì‹œí•˜ì„¸ìš”...";
            msgBox.style.color = "white";

            biteTimeout = setTimeout(() => {
                gameState = 'bite';
                bobber.className = "bite";
                msgBox.innerText = "ì§€ê¸ˆì´ì•¼!! ë‚šì•„ì±„!!";
                msgBox.style.color = "yellow";
                
                // â˜… ì…ì§ˆ ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ ë³€ê²½ ì¶”ê°€ â˜…
                btn.innerText = "ğŸ£ ë‚šì•„ì±„ê¸°!!"; 
                btn.style.background = "#ffcc00"; 
                btn.style.color = "#000";

                failTimeout = setTimeout(() => { 
                    if(gameState === 'bite') failFish("ë¬¼ê³ ê¸°ê°€ ë„ë§ê°”ìŠµë‹ˆë‹¤."); 
                }, 1200); // 1.2ì´ˆ ì—¬ìœ 
            }, Math.random() * 3000 + 2000);
        }

    function startMinigame() {
    clearTimeout(failTimeout);
    const isHigh = (selectedBaitType === 'high');
    gameState = 'fighting';
    minigameUI.style.display = "block";
    
    // 1. ë¬¼ê³ ê¸° ì¢…ë¥˜ ë° ë‚œì´ë„ ë°ì´í„° ì •ì˜
    const fishTable = [
        { name: "ë…¹ìŠ¨ ìº”", icon: "ğŸ¥«", price: 5, width: 35, speed: 0.5, chance: 0.3 },
        { name: "ì˜¤ì—¼ëœ ì¥í™”", icon: "ğŸ¥¾", price: 10, width: 30, speed: 0.7, chance: 0.25 },
        { name: "ë°©ì‚¬ëŠ¥ í”¼ë¼ë¯¸", icon: "ğŸ ", price: 25, width: 25, speed: 1.2, chance: 0.2 },
        { name: "ëŒì—°ë³€ì´ ì†¡ì–´", icon: "ğŸŸ", price: 60, width: 18, speed: 2.0, chance: 0.15 },
        { name: "ì‹¬í•´ ê´´ë¬¼íƒœì•„", icon: "ğŸ™", price: 150, width: 12, speed: 2.8, chance: 0.07 },
        { name: "í™©ê¸ˆ í†µì¡°ë¦¼", icon: "ğŸ¥«", price: 500, width: 8, speed: 3.5, chance: 0.03 }
    ];

    // 2. ë¯¸ë¼ ë“±ê¸‰ì— ë”°ë¥¸ ë¬¼ê³ ê¸° ì¶”ì²¨ (ê³ ê¸‰ ë¯¸ë¼ëŠ” ì¢‹ì€ ë¬¼ê³ ê¸° í™•ë¥  UP)
let selectedFish;
// ì¼ë°˜ ë¯¸ë¼ëŠ” 0~1.0, ê³ ê¸‰ ë¯¸ë¼ëŠ” 0.35~1.35 ë²”ìœ„ì˜ ê°’ì„ ê°€ì§‘ë‹ˆë‹¤.
const rand = Math.random() + (isHigh ? 0.35 : 0); 

if (rand > 1.15) {
    selectedFish = fishTable[5]; // í™©ê¸ˆ í†µì¡°ë¦¼ (ê³ ê¸‰ ë¯¸ë¼ ì „ìš©)
} else if (rand > 0.95) {
    selectedFish = fishTable[4]; // ì‹¬í•´ ê´´ë¬¼íƒœì•„ (ì¼ë°˜ ë¯¸ë¼ ì‹œ ì•½ 5% í™•ë¥ )
} else if (rand > 0.85) {
    selectedFish = fishTable[3]; // ëŒì—°ë³€ì´ ì†¡ì–´ (ì¼ë°˜ ë¯¸ë¼ ì‹œ ì•½ 10% í™•ë¥ )
} else if (rand > 0.6) {
    selectedFish = fishTable[2]; // ë°©ì‚¬ëŠ¥ í”¼ë¼ë¯¸
} else if (rand > 0.3) {
    selectedFish = fishTable[1]; // ì˜¤ì—¼ëœ ì¥í™”
} else {
    selectedFish = fishTable[0]; // ë…¹ìŠ¨ ìº”
}

    // 3. ë‚œì´ë„ ë³€ìˆ˜ ì„¸íŒ…
    pointerPos = 30; catchProgress = 20; failTimer = 0;
    let targetZonePos = 40;
    let targetZoneWidth = selectedFish.width; 
    let targetDirection = Math.random() < 0.5 ? -1 : 1;
    
    // ë‚šì‹¯ëŒ€ ë ˆë²¨ ë³´ì • (2ë ˆë²¨ì´ë©´ íƒ€ê²Ÿ ì†ë„ 20% ê°ì†Œ)
    let reduction = (rodLevel >= 2) ? 0.7 : 1.0;
    let targetSpeed = selectedFish.speed * reduction;

    const targetZone = document.getElementById('target-zone');
    targetZone.style.width = targetZoneWidth + "%";
    btn.innerText = `ğŸ£ [${selectedFish.name}] ê²©íˆ¬ ì¤‘!`;
    btn.style.background = "#ab0000";

    gameLoop = setInterval(() => {
        // í¬ì¸í„° ì´ë™ ë¡œì§
        let moveSpeed = rodLevel >= 2 ? 2.5 : 2.5; 
        if (isPressing) pointerPos += moveSpeed; else pointerPos -= 2.2;
        if (pointerPos < 0) pointerPos = 0; if (pointerPos > 100) pointerPos = 100;
        pointer.style.left = pointerPos + "%";

        // íƒ€ê²Ÿ ì¡´ ì´ë™ ë¡œì§
        targetZonePos += (targetSpeed * targetDirection);
        if (targetZonePos <= 0 || targetZonePos + targetZoneWidth >= 100) targetDirection *= -1;
        if (Math.random() < 0.02) targetDirection *= -1; // ë¬´ì‘ìœ„ ë°©í–¥ ì „í™˜
        targetZone.style.left = targetZonePos + "%";

        // íŒì • ë¡œì§
        if (pointerPos >= targetZonePos && pointerPos <= (targetZonePos + targetZoneWidth)) {
            // ë‚šì‹¯ëŒ€ ë ˆë²¨ì— ë”°ë¥¸ ê²Œì´ì§€ ìƒìŠ¹ëŸ‰ ì°¨ì´
            catchProgress += (rodLevel >= 2 ? 1.6 : 1.0); 
            failTimer = 0; 
            minigameUI.style.borderColor = "#00ff00";
            uiMsg.innerText = "ì¢‹ì•„ìš”! ìœ ì§€í•˜ì„¸ìš”!";
        } else {
            catchProgress -= 0.7; 
            minigameUI.style.borderColor = "gold";
        }

        // ì‹¤íŒ¨ ì¡°ê±´ ë° ì¢…ë£Œ
        if (catchProgress <= 0) {
            catchProgress = 0;
            failTimer += 30;
            minigameUI.classList.add('ui-warning'); 
            uiMsg.innerText = "âš ï¸ í…ì…˜ ìœ„í—˜!!";
        }

        if (failTimer >= 2000) { 
            failFish(`${selectedFish.name}ì´(ê°€) ì¤„ì„ ëŠê³  ë„ë§ê°”ìŠµë‹ˆë‹¤!`);
            return;
        }

        progressBar.style.width = catchProgress + "%";
        percentText.innerText = Math.floor(catchProgress);

        // ìŠ¹ë¦¬ ì‹œ ë‹¹ì²¨ëœ ë¬¼ê³ ê¸° ì •ë³´ë¥¼ winFishë¡œ ì „ë‹¬
        if (catchProgress >= 100) winFish(selectedFish);
    }, 30);
}

// winFish í•¨ìˆ˜ ìˆ˜ì • (ë§¤ê°œë³€ìˆ˜ë¡œ ë¬¼ê³ ê¸° ê°ì²´ë¥¼ ë°›ìŒ)
function winFish(fish) {
    clearInterval(gameLoop);
    gameState = 'result';
    minigameUI.style.display = "none";
    bobber.style.display = "none";
    
    // DB ì €ì¥
    database.ref('users/' + myNick + '/inventory').push({
        name: fish.name,
        icon: fish.icon,
        price: fish.price,
        date: new Date().toLocaleString()
    });

    alert(`ğŸŠ ì„±ê³µ! [${fish.name}]ì„(ë¥¼) ë‚šì•˜ìŠµë‹ˆë‹¤!\nìƒì ì—ì„œ ${fish.price}Gì— íŒ” ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    msgBox.innerText = `ë°©ê¸ˆ ë‚šì€ ê²ƒ: ${fish.name}`;
    document.getElementById('catch-display').innerText = fish.icon;
    btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
    btn.style.background = "#ab0000";
}

        function winFish(isHigh) {
            clearInterval(gameLoop);
            gameState = 'result';
            minigameUI.style.display = "none";
            bobber.style.display = "none";
            
            const rand = Math.random();
            let item = { name: "ì‘ì€ í”¼ë¼ë¯¸", icon: "ğŸ ", price: 20 };
            let luck = isHigh ? 0.25 : 0;
            if (rand < (0.1 + luck)) item = { name: "í†µì¡°ë¦¼ ë°•ìŠ¤", icon: "ğŸ¥«", price: 100 };
            else if (rand < (0.3 + luck)) item = { name: "ë°©ì‚¬ëŠ¥ ì†¡ì–´", icon: "ğŸŸ", price: 50 };

            database.ref('users/' + myNick + '/inventory').push(item);
            alert(`ğŸŠ ì„±ê³µ! [${item.name}]ì„(ë¥¼) ë‚šì•˜ìŠµë‹ˆë‹¤!`);

            msgBox.innerText = `ë°©ê¸ˆ ë‚šì€ ê²ƒ: ${item.name}`;
            msgBox.style.color = "#00ff00";
            document.getElementById('catch-display').innerText = item.icon;
            btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
            btn.style.background = "#ab0000";
        }

        function failFish(txt) {
            clearInterval(gameLoop);
            gameState = 'result';
            minigameUI.style.display = "none";
            bobber.style.display = "none";
            msgBox.innerText = txt;
            msgBox.style.color = "#ff4444";
            btn.innerText = "ë‹¤ì‹œ ë˜ì§€ê¸°";
            btn.style.background = "#ab0000";
        }

        function stopFishing() {
            if (gameState !== 'idle' && gameState !== 'result') {
                if (confirm("ë‚šì‹œë¥¼ ì¤‘ë‹¨í•˜ë©´ ì†Œëª¨ëœ ë¯¸ë¼ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ìƒì ìœ¼ë¡œ ê°ˆê¹Œìš”?")) {
                    if (gameLoop) clearInterval(gameLoop);
                    location.href = "shop.html";
                }
            } else { location.href = "shop.html"; }
        }
        function logout() { localStorage.removeItem("loginStatus"); location.href = "index.html"; }
    </script>
</body>
</html>