<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì˜ë¢° ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
  // board.htmlì— ìˆëŠ” ê²ƒê³¼ ë˜‘ê°™ì€ ì„¤ì •ê°’ì„ ë„£ìœ¼ì„¸ìš”!
const firebaseConfig = {
    apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
    authDomain: "cheongjuca.firebaseapp.com",
    databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
    projectId: "cheongjuca",
    storageBucket: "cheongjuca.firebasestorage.app",
    messagingSenderId: "455437421321",
    appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
    measurementId: "G-9XG7JRFM3D"
  };
  
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>


<script>
    (function() {
        const status = localStorage.getItem("loginStatus");
        const nick = localStorage.getItem("userNick"); // ì €ì¥ëœ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°

        // 1. ë¡œê·¸ì¸ ì•ˆ ëœ ì‚¬ëŒ íŠ•ê²¨ë‚´ê¸°
        if (!status || (status !== "success" && status !== "admin")) {
            if (!window.location.href.includes("index.html")) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "index.html";
            }
        }

        // 2. í˜ì´ì§€ ë¡œë”© í›„ ë‹‰ë„¤ì„ í‘œì‹œí•˜ê¸°
        window.addEventListener('load', function() {
            const badge = document.getElementById("userBadge");
            if (badge && nick) {
                // ê´€ë¦¬ìë©´ ë¹¨ê°„ìƒ‰, ì¼ë°˜ ìœ ì €ëŠ” í°ìƒ‰ì´ë‚˜ íšŒìƒ‰ ë“±ìœ¼ë¡œ í‘œì‹œ
                if (status === "admin") {
                    badge.innerText = `[ê´€ë¦¬ì ëª¨ë“œ]`;
                    badge.style.color = "#ff0000";
                } else {
                    badge.innerText = `[${nick}]`; // ì˜ˆ: [ëŸ¬ë„ˆ1]
                    badge.style.color = "#cccccc"; // ì¼ë°˜ ìœ ì € ìƒ‰ìƒ
                }
                badge.style.display = "inline"; // ìˆ¨ê²¨ë‘” ë°°ì§€ë¥¼ ë³´ì´ê²Œ í•¨
            }
        });
    })();

        function logout() {
            localStorage.removeItem("loginStatus");
            location.href = "index.html";
        }
    </script>
</head>
<body class="quest-page">
    <nav class="navbar">
        <div class="logo">
            OUT BREAK 
        <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;">
        </span>
        </div>
        <ul class="nav-links">
            <li><a href="main.html">í™ˆ</a></li>
            <li><a href="sub.html">ìƒì¡´ìëª©ë¡</a></li>
            <li><a href="board.html">ìµëª…ê²Œì‹œíŒ</a></li>
            <li><a href="quest.html">ì˜ë¢°ê²Œì‹œíŒ</a></li> <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>

    <div class="quest-container">
        <h2 style="font-family: 'SchoolSafeBoardMarker'; color: #ab0000; text-align: center; font-size: 40px; margin-bottom: 30px;">
            ìƒì¡´ì ì˜ë¢° í˜„í™©
        </h2>

        <div class="quest-grid" id="q1">
            
            <div class="quest-card">
                <div class="quest-profile">
                    <img src="https://i.imgur.com/3SPL075.png" alt="ì˜ë¢°ì">
                </div>
                <h3 class="quest-title">[ì•½í’ˆ íƒìƒ‰]</h3>
                <p class="quest-desc">Bë™ 203í˜¸ì— ë‘ê³  ì˜¨<br>ì¸ìŠë¦°ì„ ì°¾ì•„ì¤˜.</p>
                <div class="quest-reward">
                    <span>ë³´ìƒ</span>
                    <strong>í†µì¡°ë¦¼ 2ê°œ</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">ê±°ì ˆ</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">ìˆ˜ë½</button>
                </div>
            </div>

            <div class="quest-card" id="q2">
                <div class="quest-profile">
                    <img src="https://i.imgur.com/oltH399.png" alt="ì˜ë¢°ì">
                </div>
                <h3 class="quest-title">[ì¢€ë¹„ ì†Œíƒ•]</h3>
                <p class="quest-desc">í›„ë¬¸ ì£¼ì°¨ì¥ì„ ë§‰ê³  ìˆëŠ”<br>ê°ì—¼ìë“¤ì„ ì²˜ë¦¬í•´ ì¤˜.</p>
                <div class="quest-reward">
                    <span>ë³´ìƒ</span>
                    <strong>íƒ„ì•½ 10ë°œ</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">ê±°ì ˆ</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">ìˆ˜ë½</button>
                </div>
            </div>

            <div class="quest-card" id="q3">
                <div class="quest-profile">
                    <img src="https://i.imgur.com/TZFuO24.png" alt="ì˜ë¢°ì">
                </div>
                <h3 class="quest-title">[ë™ë£Œ ì°¾ê¸°]</h3>
                <p class="quest-desc">ë‚´ ë™ìƒì´ í•™êµ ê·¼ì²˜ì—ì„œ<br>ë§ˆì§€ë§‰ìœ¼ë¡œ ëª©ê²©ëì–´.</p>
                <div class="quest-reward">
                    <span>ë³´ìƒ</span>
                    <strong>ì§€ë„ ì¡°ê°</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">ê±°ì ˆ</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">ìˆ˜ë½</button>
                </div>
            </div>

            <div class="quest-card" id="q4">
                <div class="quest-profile">
                    <div style="width:100%; height:100%; background:#333;"></div>
                </div>
                <h3 class="quest-title">[ì •ì°°]</h3>
                <p class="quest-desc">ì˜¥ìƒì— ì˜¬ë¼ê°€ì„œ<br>êµ¬ì¡° ì‹ í˜¸ í™•ì¸ ìš”ë§.</p>
                <div class="quest-reward">
                    <span>ë³´ìƒ</span>
                    <strong>ë¬¼ 500ml</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">ê±°ì ˆ</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">ìˆ˜ë½</button>
                </div>
            </div>

        </div>
    </div>

<script>
    // 1. í˜„ì¬ ë‚´ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
    const myNick = localStorage.getItem("userNick");

    // 2. [ì‹¤ì‹œê°„] Firebaseì—ì„œ í€˜ìŠ¤íŠ¸ ìƒíƒœ ê°ì‹œí•˜ê¸°
    database.ref('questStatus').on('value', (snapshot) => {
        const data = snapshot.val() || {}; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´

        // í™”ë©´ì— ìˆëŠ” ëª¨ë“  ì¹´ë“œë¥¼ í•˜ë‚˜ì”© ê²€ì‚¬
        const cards = document.querySelectorAll('.quest-card');
        
        cards.forEach(card => {
            const questId = card.id;      
            const questInfo = data[questId]; // DB ì •ë³´

            if (questInfo && questInfo.status === 'accepted') {
                // ëˆ„êµ°ê°€ ìˆ˜ë½í•œ ìƒíƒœ
                updateCardToTaken(card, questInfo.takenBy);
            } else {
                // ì•„ë¬´ë„ ìˆ˜ë½ ì•ˆ í•¨ (ë˜ëŠ” í¬ê¸°í•¨) -> ì´ˆê¸°í™”
                resetCard(card);
            }
        });
    });

    // 3. [ê¸°ëŠ¥] ìˆ˜ë½í•˜ê¸° (DBì— ë“±ë¡)
    function acceptQuest(button) {
        const card = button.closest('.quest-card');
        const questId = card.id;

        if (confirm("ì´ ì˜ë¢°ë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ëª¨ë‘ì—ê²Œ ì•Œë ¤ì§‘ë‹ˆë‹¤)")) {
            database.ref('questStatus/' + questId).set({
                status: 'accepted',
                takenBy: myNick,
                timestamp: new Date().toLocaleString()
            });
        }
    }

    // 4. [ê¸°ëŠ¥] í¬ê¸°í•˜ê¸° (DBì—ì„œ ì‚­ì œ) - ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥!
    function giveUpQuest(button) {
        const card = button.closest('.quest-card');
        const questId = card.id;

        if (confirm("ì •ë§ ì˜ë¢°ë¥¼ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë‹¤ë¥¸ ìƒì¡´ìê°€ ë‹¤ì‹œ ìˆ˜ë½í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤)")) {
            // Firebaseì—ì„œ í•´ë‹¹ í€˜ìŠ¤íŠ¸ ì •ë³´ ì‚­ì œ -> ì¦‰ì‹œ 'ì´ˆê¸°í™”' ìƒíƒœë¡œ ê³µìœ ë¨
            database.ref('questStatus/' + questId).remove();
            alert("ì˜ë¢°ë¥¼ í¬ê¸°í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 5. [í™”ë©´ì²˜ë¦¬] ì¹´ë“œë¥¼ 'ìˆ˜í–‰ ì¤‘' ìƒíƒœë¡œ ë°”ê¾¸ëŠ” í•¨ìˆ˜
    function updateCardToTaken(card, ownerName) {
        const acceptBtn = card.querySelector('.btn-accept');
        const declineBtn = card.querySelector('.btn-decline');

        // ê±°ì ˆ ë²„íŠ¼ì€ ë¬´ì¡°ê±´ ìˆ¨ê¹€
        if(declineBtn) declineBtn.style.display = 'none';

        // â˜… í•µì‹¬ ë¡œì§: ë‚´ê°€ ì£¼ì¸ì¸ê°€? ë‚¨ì´ ì£¼ì¸ì¸ê°€?
        if (ownerName === myNick) {
            // [ë‚´ í€˜ìŠ¤íŠ¸] -> "í¬ê¸°í•˜ê¸°" ë²„íŠ¼ìœ¼ë¡œ ë³€ì‹ 
            acceptBtn.innerText = "í¬ê¸°í•˜ê¸° ğŸ³ï¸";
            acceptBtn.style.background = "#555";     // íšŒìƒ‰ (í¬ê¸° ëŠë‚Œ)
            acceptBtn.style.color = "#fff";
            acceptBtn.style.cursor = "pointer";
            acceptBtn.disabled = false;              // í´ë¦­ ê°€ëŠ¥í•˜ê²Œ í’ˆ!
            
            // ê¸°ì¡´ ìˆ˜ë½ í•¨ìˆ˜(onclick)ë¥¼ ì œê±°í•˜ê³  í¬ê¸° í•¨ìˆ˜ë¡œ êµì²´
            acceptBtn.setAttribute("onclick", "giveUpQuest(this)");

        } else {
            // [ë‚¨ì˜ í€˜ìŠ¤íŠ¸] -> "ì ê¸ˆ" ìƒíƒœ
            acceptBtn.innerText = `[${ownerName}] ì§„í–‰ ì¤‘`;
            acceptBtn.style.background = "#222";     // ê²€ì€ìƒ‰ (ì ê¹€)
            acceptBtn.style.color = "#ff4444";       // ë¶‰ì€ ê¸€ì”¨
            acceptBtn.style.cursor = "not-allowed";
            acceptBtn.disabled = true;               // í´ë¦­ ë¶ˆê°€ëŠ¥
        }
        
        card.style.opacity = "0.9";
    }

    // 6. [í™”ë©´ì²˜ë¦¬] ì¹´ë“œë¥¼ ë‹¤ì‹œ 'ìˆ˜ë½ ê°€ëŠ¥' ìƒíƒœë¡œ ì›ìƒë³µêµ¬
    function resetCard(card) {
        const acceptBtn = card.querySelector('.btn-accept');
        const declineBtn = card.querySelector('.btn-decline');

        // ë²„íŠ¼ ë””ìì¸ ì›ìƒë³µêµ¬
        acceptBtn.style.background = "#ab0000";
        acceptBtn.style.color = "white";
        acceptBtn.innerText = "ìˆ˜ë½";
        acceptBtn.disabled = false;
        acceptBtn.style.cursor = "pointer";
        
        // í•¨ìˆ˜ë„ ë‹¤ì‹œ 'ìˆ˜ë½'ìœ¼ë¡œ ì—°ê²°
        acceptBtn.setAttribute("onclick", "acceptQuest(this)");
        
        // ê±°ì ˆ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
        if(declineBtn) declineBtn.style.display = "inline-block";
        
        card.style.opacity = "1";
    }
    
    // 7. [ê¸°ëŠ¥] ê±°ì ˆ ë²„íŠ¼ (ê°œì¸ì  ìˆ¨ê¹€ ì—†ìŒ, ê³µìš© í€˜ìŠ¤íŠ¸ë¼ ë§‰ìŒ)
    function removeCard(button) {
        alert("ê³µë™ ì˜ë¢°ëŠ” ê°œì¸ì´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
</script>
</body>
</html>