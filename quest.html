<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>의뢰 게시판</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
  // board.html에 있는 것과 똑같은 설정값을 넣으세요!
const firebaseConfig = {
    apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
    authDomain: "cheongjuca.firebaseapp.com",
    databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
    projectId: "cheongjuca",
    storageBucket: "cheongjuca.firebasestorage.app",
    messagingSenderId: "455437421321",
    appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
    measurementId: "G-9XG7JRFM3D"
  };
  
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>


<script>
    (function() {
        const status = localStorage.getItem("loginStatus");
        const nick = localStorage.getItem("userNick"); // 저장된 닉네임 가져오기

        // 1. 로그인 안 된 사람 튕겨내기
        if (!status || (status !== "success" && status !== "admin")) {
            if (!window.location.href.includes("index.html")) {
                alert("로그인이 필요합니다.");
                window.location.href = "index.html";
            }
        }

        // 2. 페이지 로딩 후 닉네임 표시하기
        window.addEventListener('load', function() {
            const badge = document.getElementById("userBadge");
            if (badge && nick) {
                // 관리자면 빨간색, 일반 유저는 흰색이나 회색 등으로 표시
                if (status === "admin") {
                    badge.innerText = `[관리자 모드]`;
                    badge.style.color = "#ff0000";
                } else {
                    badge.innerText = `[${nick}]`; // 예: [러너1]
                    badge.style.color = "#cccccc"; // 일반 유저 색상
                }
                badge.style.display = "inline"; // 숨겨둔 배지를 보이게 함
            }
        });
    })();

        function logout() {
            localStorage.removeItem("loginStatus");
            location.href = "index.html";
        }
    </script>
</head>
<body class="quest-page">
    <nav class="navbar">
        <div class="logo">
            OUT BREAK 
        <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;">
        </span>
        </div>
        <ul class="nav-links">
            <li><a href="main.html">홈</a></li>
            <li><a href="sub.html">생존자목록</a></li>
            <li><a href="board.html">익명게시판</a></li>
            <li><a href="quest.html">의뢰게시판</a></li> <li><a href="#" onclick="logout()">로그아웃</a></li>
        </ul>
    </nav>

    <div class="quest-container">
        <h2 style="font-family: 'SchoolSafeBoardMarker'; color: #ab0000; text-align: center; font-size: 40px; margin-bottom: 30px;">
            생존자 의뢰 현황
        </h2>

        <div class="quest-grid" id="q1">
            
            <div class="quest-card">
                <div class="quest-profile">
                    <img src="https://i.imgur.com/3SPL075.png" alt="의뢰자">
                </div>
                <h3 class="quest-title">[약품 탐색]</h3>
                <p class="quest-desc">B동 203호에 두고 온<br>인슐린을 찾아줘.</p>
                <div class="quest-reward">
                    <span>보상</span>
                    <strong>통조림 2개</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">거절</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">수락</button>
                </div>
            </div>

            <div class="quest-card" id="q2">
                <div class="quest-profile">
                    <img src="https://i.imgur.com/oltH399.png" alt="의뢰자">
                </div>
                <h3 class="quest-title">[좀비 소탕]</h3>
                <p class="quest-desc">후문 주차장을 막고 있는<br>감염자들을 처리해 줘.</p>
                <div class="quest-reward">
                    <span>보상</span>
                    <strong>탄약 10발</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">거절</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">수락</button>
                </div>
            </div>

            <div class="quest-card" id="q3">
                <div class="quest-profile">
                    <img src="https://i.imgur.com/TZFuO24.png" alt="의뢰자">
                </div>
                <h3 class="quest-title">[동료 찾기]</h3>
                <p class="quest-desc">내 동생이 학교 근처에서<br>마지막으로 목격됐어.</p>
                <div class="quest-reward">
                    <span>보상</span>
                    <strong>지도 조각</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">거절</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">수락</button>
                </div>
            </div>

            <div class="quest-card" id="q4">
                <div class="quest-profile">
                    <div style="width:100%; height:100%; background:#333;"></div>
                </div>
                <h3 class="quest-title">[정찰]</h3>
                <p class="quest-desc">옥상에 올라가서<br>구조 신호 확인 요망.</p>
                <div class="quest-reward">
                    <span>보상</span>
                    <strong>물 500ml</strong>
                </div>
                <div class="quest-buttons">
                    <button class="btn-decline" onclick="removeCard(this)">거절</button>
                    <button class="btn-accept" onclick="acceptQuest(this)">수락</button>
                </div>
            </div>

        </div>
    </div>

<script>
    // 1. 현재 내 닉네임 가져오기
    const myNick = localStorage.getItem("userNick");

    // 2. [실시간] Firebase에서 퀘스트 상태 감시하기
    database.ref('questStatus').on('value', (snapshot) => {
        const data = snapshot.val() || {}; // 데이터가 없으면 빈 객체

        // 화면에 있는 모든 카드를 하나씩 검사
        const cards = document.querySelectorAll('.quest-card');
        
        cards.forEach(card => {
            const questId = card.id;      // 예: q1
            const questInfo = data[questId]; // DB에 저장된 정보 (누가 수락했는지)

            if (questInfo && questInfo.status === 'accepted') {
                // 누군가 이미 수락한 경우
                updateCardToTaken(card, questInfo.takenBy);
            } else {
                // 아무도 수락 안 한 경우 (초기화)
                resetCard(card);
            }
        });
    });

    // 3. [기능] 수락 버튼을 눌렀을 때 (서버에 알림)
    function acceptQuest(button) {
        const card = button.closest('.quest-card');
        const questId = card.id;

        if (confirm("이 의뢰를 수락하시겠습니까? (모두에게 알려집니다)")) {
            // Firebase에 "내가 찜했음" 하고 저장
            database.ref('questStatus/' + questId).set({
                status: 'accepted',
                takenBy: myNick,
                timestamp: new Date().toLocaleString()
            });
        }
    }

    // 4. [기능] 거절 버튼 (나한테만 안 보이게 할지, 아니면 버튼을 없앨지 선택)
    // 공유 퀘스트에서는 함부로 거절(삭제)하면 다른 사람도 못 하게 되므로
    // 보통은 '거절' 버튼을 숨기거나 비활성화하는 게 좋습니다.
    function removeCard(button) {
        alert("공동 의뢰는 거절할 수 없습니다. 누군가는 해야 하니까요...");
    }

    // 5. [화면처리] 카드를 '수행 중' 상태로 바꾸는 함수
    function updateCardToTaken(card, ownerName) {
        const acceptBtn = card.querySelector('.btn-accept');
        const declineBtn = card.querySelector('.btn-decline');

        // 수락 버튼 스타일 변경
        acceptBtn.style.background = "#222"; 
        acceptBtn.style.color = "#ff4444"; // 붉은 글씨
        acceptBtn.style.border = "1px solid #555";
        
        // 텍스트 변경 (핵심 기능!)
        if (ownerName === myNick) {
            acceptBtn.innerText = "내가 수행 중";
        } else {
            acceptBtn.innerText = `[${ownerName}] 진행 중`;
        }

        acceptBtn.disabled = true;       // 버튼 못 누르게 잠금
        acceptBtn.style.cursor = "not-allowed";
        
        // 거절 버튼은 숨김
        if(declineBtn) declineBtn.style.display = 'none';
        
        // 카드 전체를 약간 어둡게 처리 (선택사항)
        card.style.opacity = "0.8";
    }

    // 6. [화면처리] 카드를 다시 원상복구 (혹시 취소 기능 넣을 때 대비)
    function resetCard(card) {
        const acceptBtn = card.querySelector('.btn-accept');
        const declineBtn = card.querySelector('.btn-decline');

        acceptBtn.style.background = "#ab0000";
        acceptBtn.style.color = "white";
        acceptBtn.innerText = "수락";
        acceptBtn.disabled = false;
        acceptBtn.style.cursor = "pointer";
        card.style.opacity = "1";
        
        if(declineBtn) declineBtn.style.display = "inline-block";
    }
</script>
</body>
</html>