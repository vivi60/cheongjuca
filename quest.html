<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>의뢰 게시판</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAlv59Z0jrLUGdIrhf9INS2G2I4IwLvCr0",
        authDomain: "cheongjuca.firebaseapp.com",
        databaseURL: "https://cheongjuca-default-rtdb.firebaseio.com", 
        projectId: "cheongjuca",
        storageBucket: "cheongjuca.firebasestorage.app",
        messagingSenderId: "455437421321",
        appId: "1:455437421321:web:61711d53c4fa6c9c95e1d8",
        measurementId: "G-9XG7JRFM3D"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
    </script>

    <script>
        // 로그인 체크 및 닉네임 표시
        (function() {
            const status = localStorage.getItem("loginStatus");
            const nick = localStorage.getItem("userNick");

            if (!status || (status !== "success" && status !== "admin")) {
                if (!window.location.href.includes("index.html")) {
                    alert("로그인이 필요합니다.");
                    window.location.href = "index.html";
                }
            }

            window.addEventListener('load', function() {
                const badge = document.getElementById("userBadge");
                if (badge && nick) {
                    if (status === "admin") {
                        badge.innerText = `[관리자 모드]`;
                        badge.style.color = "#ff0000";
                    } else {
                        badge.innerText = `[${nick}]`;
                        badge.style.color = "#cccccc";
                    }
                    badge.style.display = "inline";
                }
            });
        })();

        function logout() {
            localStorage.removeItem("loginStatus");
            location.href = "index.html";
        }
    </script>
</head>
<body class="quest-page">
    <nav class="navbar">
        <div class="logo">
            OUT BREAK 
            <span id="userBadge" style="display: none; font-size: 14px; margin-left: 10px; vertical-align: middle;"></span>
        </div>
        <ul class="nav-links">
            <li><a href="main.html">홈</a></li>
            <li><a href="sub.html">생존자목록</a></li>
            <li><a href="board.html">익명게시판</a></li>
            <li><a href="quest.html">의뢰게시판</a></li>
            <li><a href="#" onclick="logout()">로그아웃</a></li>
        </ul>
    </nav>

    <div class="quest-container">
        <h2 style="font-family: 'SchoolSafeBoardMarker'; color: #ab0000; text-align: center; font-size: 40px; margin-bottom: 30px;">
            생존자 의뢰 현황
        </h2>

        <div class="quest-grid" id="questListArea">
            </div>

        <div class="quest-form-box">
            <h3 style="color: #ab0000; font-family: 'SchoolSafeBoardMarker'; text-align: center;">새 의뢰 등록</h3>
            <div class="form-row">
                <input type="text" id="qImg" placeholder="이미지 주소 (링크)">
                <input type="text" id="qTitle" placeholder="의뢰 제목 (예: 식량 부족)">
            </div>
            <textarea id="qDesc" rows="2" placeholder="의뢰 내용 (상세히 적어주세요)"></textarea>
            <div class="form-row">
                <input type="text" id="qReward" placeholder="보상 (예: 통조림 1개)">
                <button onclick="writeQuest()">의뢰 등록하기</button>
            </div>
        </div>
    </div>

<script>
    const myNick = localStorage.getItem("userNick");
    const isAdmin = localStorage.getItem("loginStatus") === "admin";

    // 1. [실시간] Firebase 감시 및 화면 그리기
    database.ref('requests').on('value', (snapshot) => {
        const questListArea = document.getElementById('questListArea');
        const data = snapshot.val();

        questListArea.innerHTML = ""; // 화면 초기화

        if (!data) {
            questListArea.innerHTML = "<p style='color:white; width:100%; text-align:center;'>등록된 의뢰가 없습니다.</p>";
            return;
        }

        // 최신순 정렬
        const entries = Object.entries(data).reverse();

        entries.forEach(([key, quest]) => {
            const card = document.createElement('div');
            card.className = 'quest-card';
            card.id = key;

            // --- [버튼 로직의 핵심] ---
            let buttonsHtml = "";
            let statusBadge = ""; 

            const isAuthor = (quest.author === myNick);
            const isRunner = (quest.takenBy === myNick);

            if (quest.status === 'open') {
                // [상태: 의뢰 중] 
                if (isAuthor) {
                    // ★ 수정된 부분: 내 의뢰면 수락 버튼 대신 '대기중' 표시
                    buttonsHtml = `<button class="btn-accept" disabled style="background:#333; color:#777; cursor:default; border:1px solid #555;">내 의뢰 (생존자 기다리는 중)</button>`;
                } else {
                    // 남의 의뢰면 수락 가능
                    buttonsHtml = `<button class="btn-accept" onclick="acceptQuest('${key}')">수락하기</button>`;
                }
            
            } else if (quest.status === 'accepted') {
                // [상태: 진행 중]
                if (isRunner) {
                    buttonsHtml = `
                        <button class="btn-accept" onclick="requestApproval('${key}')" 
                                style="background:#222; border:2px solid #ab0000; color:#ab0000; font-weight:bold;">
                            임무 완료 보고 (V)
                        </button>
                        <button class="btn-decline" onclick="giveUpQuest('${key}')" 
                                style="background:#555; color:white; margin-left:5px;">포기</button>
                    `;
                } else {
                    buttonsHtml = `<button class="btn-accept" disabled style="background:#222; color:#ff4444; cursor:not-allowed;">[${quest.takenBy}] 수행중...</button>`;
                }

            } else if (quest.status === 'pending') {
                // [상태: 검토 대기]
                if (isAuthor) {
                    statusBadge = "<div style='color:#00ff00; font-size:14px; margin-bottom:5px;'>★ 상대방이 완료했습니다!</div>";
                    buttonsHtml = `
                        <button class="btn-accept" onclick="approveQuest('${key}')" 
                                style="background:#006400; color:white; font-weight:bold; border:2px solid #00ff00;">
                            완료 확인 (보상 지급)
                        </button>
                    `;
                } else if (isRunner) {
                    buttonsHtml = `<button class="btn-accept" disabled style="background:#444; color:white;">의뢰자 확인 대기중...</button>`;
                } else {
                    buttonsHtml = `<button class="btn-accept" disabled style="background:#222; color:#888;">검토 진행 중</button>`;
                }

            } else if (quest.status === 'completed') {
                // [상태: 최종 완료]
                if (isRunner) {
                    statusBadge = "<div style='color:gold; font-size:14px; margin-bottom:5px;'>★ 의뢰자가 확인했습니다!</div>";
                    buttonsHtml = `
                        <button class="btn-accept" onclick="finishAndGetReward('${key}')" 
                                style="background:gold; color:black; font-weight:bold; border:2px solid orange;">
                            보상 수령 (목록에서 삭제)
                        </button>
                    `;
                } else {
                    card.style.display = 'none'; 
                    return; 
                }
            }

            // 삭제 버튼 (작성자 또는 관리자)
            let deleteBtnHtml = "";
            if (isAuthor || isAdmin || myNick === "관리자") {
                deleteBtnHtml = `<button class="btn-delete-quest" onclick="deleteQuest('${key}')">X</button>`;
            }

            card.innerHTML = `
                ${deleteBtnHtml}
                <div class="quest-profile">
                    <img src="${quest.image || 'https://i.imgur.com/3SPL075.png'}" alt="이미지" onerror="this.src='https://i.imgur.com/3SPL075.png'">
                </div>
                <h3 class="quest-title">[${quest.title}]</h3>
                <p class="quest-desc">${quest.desc}</p>
                <div class="quest-reward">
                    <span>보상</span>
                    <strong>${quest.reward}</strong>
                </div>
                <div style="font-size:12px; color:#666; margin-bottom:5px;">의뢰자: ${quest.author}</div>
                ${statusBadge}
                <div class="quest-buttons">
                    ${buttonsHtml}
                </div>
            `;
            questListArea.appendChild(card);
        });
    });

    // --- [기능 함수들 (기존과 동일)] ---
    function writeQuest() {
        const img = document.getElementById('qImg').value;
        const title = document.getElementById('qTitle').value;
        const desc = document.getElementById('qDesc').value;
        const reward = document.getElementById('qReward').value;

        if (!title || !desc || !reward) return alert("내용을 모두 입력해주세요.");

        const newQuest = {
            image: img, title: title, desc: desc, reward: reward,
            author: myNick,
            status: 'open', 
            timestamp: new Date().toLocaleString()
        };
        database.ref('requests').push(newQuest);
        
        document.getElementById('qImg').value = '';
        document.getElementById('qTitle').value = '';
        document.getElementById('qDesc').value = '';
        document.getElementById('qReward').value = '';
    }

    function acceptQuest(key) {
        if (confirm("의뢰를 수락하시겠습니까?")) {
            database.ref('requests/' + key).update({ status: 'accepted', takenBy: myNick });
        }
    }

    function requestApproval(key) {
        if (confirm("임무를 완수했습니까? 의뢰자에게 확인을 요청합니다.")) {
            database.ref('requests/' + key).update({ status: 'pending' });
        }
    }

    function approveQuest(key) {
        if (confirm("수행 내용을 확인하셨습니까? 승인하면 상대방에게 보상 알림이 뜹니다.")) {
            database.ref('requests/' + key).update({ status: 'completed' });
        }
    }

    function finishAndGetReward(key) {
        alert("보상을 획득했습니다! 수고하셨습니다.");
        database.ref('requests/' + key).remove(); 
    }

    function giveUpQuest(key) {
        if (confirm("정말 포기하시겠습니까?")) {
            database.ref('requests/' + key).update({ status: 'open', takenBy: null });
        }
    }

    function deleteQuest(key) {
        if (confirm("정말 삭제하시겠습니까?")) {
            database.ref('requests/' + key).remove();
        }
    }
</script>
</body>
</html>